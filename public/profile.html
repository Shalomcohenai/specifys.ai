<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרופיל משתמש - Specifys.ai</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/auth.css">
    <link rel="stylesheet" href="/styles/dashboard.css">
    <link rel="stylesheet" href="/styles/profile.css">
</head>
<body>
    <nav id="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Specifys.ai</h1>
            </div>
            <div class="nav-links" id="nav-links">
                <!-- Will be populated by navbar.js -->
            </div>
        </div>
    </nav>

    <main class="container">
        <!-- User Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar">
                <div class="avatar-placeholder" id="user-avatar">
                    <span id="avatar-initial">👤</span>
                </div>
            </div>
            <div class="profile-info">
                <h2 id="user-name">טוען...</h2>
                <p id="user-email">טוען...</p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="specs-count">0</span>
                        <span class="stat-label">מפרטים</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="join-date">-</span>
                        <span class="stat-label">תאריך הצטרפות</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Actions -->
        <div class="profile-actions">
            <button id="edit-profile-btn" class="btn btn-primary">
                <span>✏️</span> ערוך פרופיל
            </button>
            <button id="create-spec-btn" class="btn btn-outline">
                <span>➕</span> צור מפרט חדש
            </button>
        </div>

        <!-- User's Specs Section -->
        <div class="profile-specs-section">
            <div class="section-header">
                <h3>המפרטים שלי</h3>
                <div class="section-actions">
                    <input type="text" id="search-specs" placeholder="חיפוש במפרטים..." class="search-input">
                    <select id="sort-specs" class="sort-select">
                        <option value="newest">החדשים ביותר</option>
                        <option value="oldest">הישנים ביותר</option>
                        <option value="title">לפי כותרת</option>
                    </select>
                </div>
            </div>

            <div id="specs-container" class="specs-grid">
                <div class="loading">טוען מפרטים...</div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ערוך פרופיל</h3>
                    <button class="close-modal" id="close-modal">&times;</button>
                </div>
                <form id="edit-profile-form" class="modal-form">
                    <div class="form-group">
                        <label for="display-name">שם תצוגה:</label>
                        <input type="text" id="display-name" name="displayName" required>
                    </div>
                    <div class="form-group">
                        <label for="bio">קצת עליי:</label>
                        <textarea id="bio" name="bio" rows="4" placeholder="ספר על עצמך..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancel-edit">ביטול</button>
                        <button type="submit" class="btn btn-primary">שמור שינויים</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>
    </main>

    <script type="module" src="/scripts/firebaseConfig.js"></script>
    <script type="module" src="/scripts/authService.js"></script>
    <script type="module" src="/scripts/navbar.js"></script>
    <script type="module" src="/scripts/routeGuards.js"></script>
    <script type="module" src="/scripts/specsService.js"></script>
    <script type="module">
        import { onAuthChanged, getCurrentUser } from '/scripts/authService.js';
        import { requireAuth } from '/scripts/routeGuards.js';
        import { fetchUserSpecs, deleteSpec, updateSpec } from '/scripts/specsService.js';

        // Require authentication
        requireAuth('/login.html');

        let currentUser = null;
        let userSpecs = [];

        // Auth state change handler
        onAuthChanged((user) => {
            if (user) {
                currentUser = user;
                updateProfileInfo(user);
                loadUserSpecs();
            } else {
                window.location.href = '/login.html';
            }
        });

        // Update profile information
        function updateProfileInfo(user) {
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            const avatarInitial = document.getElementById('avatar-initial');
            const joinDate = document.getElementById('join-date');

            userName.textContent = user.displayName || user.email.split('@')[0];
            userEmail.textContent = user.email;
            
            if (user.displayName) {
                avatarInitial.textContent = user.displayName.charAt(0).toUpperCase();
            } else {
                avatarInitial.textContent = user.email.charAt(0).toUpperCase();
            }

            // Set join date
            if (user.metadata && user.metadata.creationTime) {
                const date = new Date(user.metadata.creationTime);
                joinDate.textContent = date.toLocaleDateString('he-IL');
            }
        }

        // Load user specs
        async function loadUserSpecs() {
            if (!currentUser) return;
            
            try {
                userSpecs = await fetchUserSpecs(currentUser.uid);
                document.getElementById('specs-count').textContent = userSpecs.length;
                renderSpecs();
            } catch (error) {
                console.error('Error loading specs:', error);
                document.getElementById('specs-container').innerHTML = '<div class="error">שגיאה בטעינת המפרטים</div>';
            }
        }

        // Render specs in grid layout
        function renderSpecs() {
            const specsContainer = document.getElementById('specs-container');
            
            if (userSpecs.length === 0) {
                specsContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon">📝</div>
                        <h4>אין מפרטים עדיין</h4>
                        <p>צור מפרט ראשון כדי להתחיל!</p>
                        <button class="btn btn-primary" onclick="window.location.href='/dashboard.html'">
                            צור מפרט חדש
                        </button>
                    </div>
                `;
                return;
            }
            
            specsContainer.innerHTML = userSpecs.map(spec => `
                <div class="spec-card" data-spec-id="${spec.id}">
                    <div class="spec-card-header">
                        <h4 class="spec-card-title">${spec.title}</h4>
                        <div class="spec-card-actions">
                            <button class="btn-icon" onclick="editSpecCard('${spec.id}')" title="ערוך">
                                ✏️
                            </button>
                            <button class="btn-icon" onclick="deleteSpecCard('${spec.id}')" title="מחק">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="spec-card-content">
                        ${spec.content.length > 150 ? spec.content.substring(0, 150) + '...' : spec.content}
                    </div>
                    <div class="spec-card-footer">
                        <small>נוצר: ${new Date(spec.createdAt?.toDate?.() || spec.createdAt).toLocaleDateString('he-IL')}</small>
                    </div>
                </div>
            `).join('');
        }

        // Search functionality
        document.getElementById('search-specs').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredSpecs = userSpecs.filter(spec => 
                spec.title.toLowerCase().includes(searchTerm) ||
                spec.content.toLowerCase().includes(searchTerm)
            );
            renderFilteredSpecs(filteredSpecs);
        });

        // Sort functionality
        document.getElementById('sort-specs').addEventListener('change', (e) => {
            const sortBy = e.target.value;
            const sortedSpecs = [...userSpecs];
            
            switch(sortBy) {
                case 'newest':
                    sortedSpecs.sort((a, b) => new Date(b.createdAt?.toDate?.() || b.createdAt) - new Date(a.createdAt?.toDate?.() || a.createdAt));
                    break;
                case 'oldest':
                    sortedSpecs.sort((a, b) => new Date(a.createdAt?.toDate?.() || a.createdAt) - new Date(b.createdAt?.toDate?.() || b.createdAt));
                    break;
                case 'title':
                    sortedSpecs.sort((a, b) => a.title.localeCompare(b.title));
                    break;
            }
            
            renderFilteredSpecs(sortedSpecs);
        });

        function renderFilteredSpecs(specs) {
            const specsContainer = document.getElementById('specs-container');
            
            if (specs.length === 0) {
                specsContainer.innerHTML = '<div class="no-results">לא נמצאו מפרטים</div>';
                return;
            }
            
            specsContainer.innerHTML = specs.map(spec => `
                <div class="spec-card" data-spec-id="${spec.id}">
                    <div class="spec-card-header">
                        <h4 class="spec-card-title">${spec.title}</h4>
                        <div class="spec-card-actions">
                            <button class="btn-icon" onclick="editSpecCard('${spec.id}')" title="ערוך">
                                ✏️
                            </button>
                            <button class="btn-icon" onclick="deleteSpecCard('${spec.id}')" title="מחק">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="spec-card-content">
                        ${spec.content.length > 150 ? spec.content.substring(0, 150) + '...' : spec.content}
                    </div>
                    <div class="spec-card-footer">
                        <small>נוצר: ${new Date(spec.createdAt?.toDate?.() || spec.createdAt).toLocaleDateString('he-IL')}</small>
                    </div>
                </div>
            `).join('');
        }

        // Modal functionality
        document.getElementById('edit-profile-btn').addEventListener('click', () => {
            document.getElementById('edit-profile-modal').style.display = 'flex';
            document.getElementById('display-name').value = currentUser.displayName || '';
        });

        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('cancel-edit').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }

        // Create spec button
        document.getElementById('create-spec-btn').addEventListener('click', () => {
            window.location.href = '/dashboard.html';
        });

        // Global functions for spec actions
        window.editSpecCard = function(specId) {
            const spec = userSpecs.find(s => s.id === specId);
            if (!spec) return;
            
            const newTitle = prompt('ערוך כותרת:', spec.title);
            if (newTitle === null) return;
            
            const newContent = prompt('ערוך תוכן:', spec.content);
            if (newContent === null) return;
            
            updateSpec(specId, { title: newTitle, content: newContent })
                .then(() => {
                    showMessage('המפרט עודכן בהצלחה!', 'success');
                    loadUserSpecs();
                })
                .catch(error => {
                    showMessage('שגיאה בעדכון המפרט: ' + error.message, 'error');
                });
        };

        window.deleteSpecCard = function(specId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את המפרט?')) {
                return;
            }
            
            deleteSpec(specId)
                .then(() => {
                    showMessage('המפרט נמחק בהצלחה!', 'success');
                    loadUserSpecs();
                })
                .catch(error => {
                    showMessage('שגיאה במחיקת המפרט: ' + error.message, 'error');
                });
        };

        function showMessage(message, type) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
