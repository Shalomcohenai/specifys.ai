rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'specifysai@gmail.com' ||
        request.auth.token.email == 'admin@specifys.ai' ||
        request.auth.token.email == 'shalom@specifys.ai'
      );
    }

    // Users collection
    match /users/{userId} {
      // Allow read if user owns it or is admin
      allow read: if request.auth != null && request.auth.uid == userId || isAdmin();
      // Allow create if user is creating their own document
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow update if user is updating their own document
      allow update: if request.auth != null && request.auth.uid == userId || isAdmin();
      // Allow delete if user owns it or is admin
      allow delete: if request.auth != null && request.auth.uid == userId || isAdmin();
    }

    // Entitlements collection
    match /entitlements/{userId} {
      // Allow read if user owns it or is admin
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      // Only backend (via admin SDK) can write - frontend cannot modify
      allow write: if false;
    }

    // Purchases collection
    match /purchases/{purchaseId} {
      // Allow read if user owns it or is admin
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId || isAdmin()
      );
      // Only backend can write
      allow write: if false;
    }

    // Subscriptions collection
    match /subscriptions/{userId} {
      // Allow read if user owns it or is admin
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      // Only backend can write
      allow write: if false;
    }

    // UserTools subcollections
    match /userTools/{userId}/{document=**} {
      allow read, write: if request.auth != null && userId == request.auth.uid || isAdmin();
      allow create: if request.auth != null && userId == request.auth.uid;
    }

    // Public stats collection - anyone can read
    match /public_stats/{document} {
      allow read: if true;
      allow write, create, update, delete: if isAdmin();
    }

    // Specs collection - improved security with isPublic flag
    match /specs/{specId} {
      // Allow read if public OR user owns it OR admin
      allow read: if resource.data.isPublic == true || 
                       (request.auth != null && request.auth.uid == resource.data.userId) || 
                       isAdmin();
      // Allow creation if the user is setting their own userId
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      // Allow update if user owns the document or is admin
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        (isAdmin() && request.resource.data.userId == resource.data.userId)
      );
      // Allow delete if user owns the document
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // Market research collection
    match /marketResearch/{document} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // Apps collection
    match /apps/{appId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // App notes collection
    match /appNotes/{noteId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // App tasks collection
    match /appTasks/{taskId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // App milestones collection
    match /appMilestones/{milestoneId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // App expenses collection
    match /appExpenses/{expenseId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // User likes collection
    match /userLikes/{likeId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId || isAdmin();
      allow update: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId || isAdmin();
    }

    // Test purchases collection - for Lemon Squeezy test system
    match /test_purchases/{purchaseId} {
      allow read: if true; // Anyone can read (for counter display)
      allow create, update, delete: if isAdmin(); // Only backend (via admin SDK) can write
    }

    // Credits transactions collection
    match /credits_transactions/{transactionId} {
      // Allow read if user owns it or is admin
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId || isAdmin()
      );
      // Only backend (via admin SDK) can write
      allow write: if false;
    }

    // Activity logs collection
    match /activityLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Academy categories collection - public read, admin write
    match /academy_categories/{categoryId} {
      allow read: if true; // Anyone can read categories
      allow create, update, delete: if isAdmin(); // Only admins can write
    }

    // Academy guides collection - public read, admin write
    match /academy_guides/{guideId} {
      allow read: if true; // Anyone can read guides
      allow create, update, delete: if isAdmin(); // Only admins can write
    }

    // Academy visits collection - users can create, admins can read
    match /academy_visits/{visitId} {
      allow read: if isAdmin(); // Only admins can read visits
      allow create: if true; // Anyone can create visits (including anonymous users)
      allow update, delete: if isAdmin(); // Only admins can update/delete
    }
  }
}
