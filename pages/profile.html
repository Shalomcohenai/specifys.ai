<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#000000">
    <title>My Profile - Specifys.ai</title>
    <meta name="description" content="Manage your Specifys.ai profile and apps">
    <meta name="keywords" content="AI development tools, app specification generator, no-code platform, AI-powered planning, vibe coding, AI app builder, specification generator, market research tool, app planning tool, development tools, AI tools">
    <meta name="author" content="Specifys.ai">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    
    <!-- Content Security Policy - Removed to fix Google Analytics/Ads issues -->
    
    <!-- Canonical URL -->
    
    <link rel="canonical" href="https://specifys-ai.com/pages/profile.html">
    
    
    <!-- Open Graph -->
    <meta property="og:site_name" content="Specifys.ai">
    <meta property="og:title" content="My Profile">
    <meta property="og:description" content="Manage your Specifys.ai profile and apps">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://specifys-ai.com/pages/profile.html">
    <meta property="og:image" content="https://specifys-ai.com/assets/images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="en_US">
    
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@specifysai">
    <meta name="twitter:creator" content="@specifysai">
    <meta name="twitter:title" content="My Profile">
    <meta name="twitter:description" content="Manage your Specifys.ai profile and apps">
    <meta name="twitter:image" content="https://specifys-ai.com/assets/images/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
      
        <link rel="stylesheet" href="/assets/css/pages/profile.css">
      
    
    
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Mermaid for diagrams (used in demo, spec, research pages) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    
    <!-- Marked for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- jsPDF for PDF export (used in research pages) -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RWBT69JCM7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-RWBT69JCM7');
</script>


    <script>
// Central Analytics Event Tracking System for Specifys.ai
// This file contains reusable tracking functions for consistent analytics across the site

// Check if gtag is available
function isGtagAvailable() {
  return typeof gtag !== 'undefined';
}

// Track button clicks with detailed categorization
function trackButtonClick(buttonName, category, source, additionalData = {}) {
  if (isGtagAvailable()) {
    gtag('event', 'click', {
      'event_category': category || 'Button Click',
      'event_label': buttonName,
      'event_source': source || 'unknown',
      ...additionalData
    });
  }
}

// Track CTA (Call-to-Action) clicks
function trackCTA(ctaName, location) {
  if (isGtagAvailable()) {
    gtag('event', 'cta_click', {
      'event_category': 'CTA',
      'event_label': ctaName,
      'cta_location': location
    });
  }
}

// Track navigation events
function trackNavigation(destination, source) {
  if (isGtagAvailable()) {
    gtag('event', 'navigation', {
      'event_category': 'Navigation',
      'event_label': destination,
      'navigation_source': source
    });
  }
}

// Track tool usage
function trackToolUsage(toolName, action) {
  if (isGtagAvailable()) {
    gtag('event', 'tool_usage', {
      'event_category': 'Tools',
      'event_label': toolName,
      'tool_action': action
    });
  }
}

// Track form submissions
function trackFormSubmit(formName, formType) {
  if (isGtagAvailable()) {
    gtag('event', 'form_submit', {
      'event_category': 'Form',
      'event_label': formName,
      'form_type': formType
    });
  }
}

// Track user authentication events
function trackAuthEvent(action, method) {
  if (isGtagAvailable()) {
    gtag('event', action, {
      'event_category': 'Authentication',
      'event_label': action,
      'auth_method': method || 'email'
    });
  }
}

// Track downloads
function trackDownload(fileName, fileType) {
  if (isGtagAvailable()) {
    gtag('event', 'download', {
      'event_category': 'Downloads',
      'event_label': fileName,
      'file_type': fileType
    });
  }
}

// Track spec/result generations
function trackGeneration(type, mode) {
  if (isGtagAvailable()) {
    gtag('event', 'generation_start', {
      'event_category': 'Generation',
      'event_label': type,
      'generation_mode': mode
    });
  }
}

// Track generation completion
function trackGenerationComplete(type, mode, success) {
  if (isGtagAvailable()) {
    gtag('event', 'generation_complete', {
      'event_category': 'Generation',
      'event_label': type,
      'generation_mode': mode,
      'success': success
    });
  }
}

// Track external link clicks
function trackExternalLink(linkUrl, linkText) {
  if (isGtagAvailable()) {
    gtag('event', 'click', {
      'event_category': 'External Link',
      'event_label': linkText || linkUrl,
      'link_url': linkUrl
    });
  }
}

// Track modal interactions
function trackModal(modalName, action) {
  if (isGtagAvailable()) {
    gtag('event', 'modal_' + action, {
      'event_category': 'Modal',
      'event_label': modalName,
      'modal_action': action
    });
  }
}

// Track FAQ interactions
function trackFAQ(question, action) {
  if (isGtagAvailable()) {
    gtag('event', 'faq_' + action, {
      'event_category': 'FAQ',
      'event_label': question,
      'faq_action': action
    });
  }
}

// Track search actions
function trackSearch(searchTerm, searchType) {
  if (isGtagAvailable()) {
    gtag('event', 'search', {
      'event_category': 'Search',
      'search_term': searchTerm,
      'search_type': searchType
    });
  }
}

// Track video/demo views
function trackDemoView(demoName, viewDuration) {
  if (isGtagAvailable()) {
    gtag('event', 'demo_view', {
      'event_category': 'Demo',
      'event_label': demoName,
      'view_duration': viewDuration
    });
  }
}

// Track user engagement time
function trackEngagement(pageName, timeSpent) {
  if (isGtagAvailable()) {
    gtag('event', 'user_engagement', {
      'event_category': 'Engagement',
      'event_label': pageName,
      'engagement_time_msec': timeSpent
    });
  }
}

// Track errors
function trackError(errorType, errorMessage, errorLocation) {
  if (isGtagAvailable()) {
    gtag('event', 'error', {
      'event_category': 'Error',
      'event_label': errorType,
      'error_message': errorMessage,
      'error_location': errorLocation
    });
  }
}

// Track user preferences
function trackPreference(preferenceName, preferenceValue) {
  if (isGtagAvailable()) {
    gtag('event', 'preference_change', {
      'event_category': 'Preferences',
      'event_label': preferenceName,
      'preference_value': preferenceValue
    });
  }
}

// Track scroll depth
let scrollDepthTracked = {25: false, 50: false, 75: false, 100: false};
function initScrollTracking(pageName) {
  window.addEventListener('scroll', function() {
    const scrollPercent = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
    
    if (scrollPercent >= 25 && !scrollDepthTracked[25]) {
      scrollDepthTracked[25] = true;
      if (isGtagAvailable()) {
        gtag('event', 'scroll', {
          'event_category': 'Scroll Depth',
          'event_label': pageName,
          'scroll_depth': '25%'
        });
      }
    }
    if (scrollPercent >= 50 && !scrollDepthTracked[50]) {
      scrollDepthTracked[50] = true;
      if (isGtagAvailable()) {
        gtag('event', 'scroll', {
          'event_category': 'Scroll Depth',
          'event_label': pageName,
          'scroll_depth': '50%'
        });
      }
    }
    if (scrollPercent >= 75 && !scrollDepthTracked[75]) {
      scrollDepthTracked[75] = true;
      if (isGtagAvailable()) {
        gtag('event', 'scroll', {
          'event_category': 'Scroll Depth',
          'event_label': pageName,
          'scroll_depth': '75%'
        });
      }
    }
    if (scrollPercent >= 100 && !scrollDepthTracked[100]) {
      scrollDepthTracked[100] = true;
      if (isGtagAvailable()) {
        gtag('event', 'scroll', {
          'event_category': 'Scroll Depth',
          'event_label': pageName,
          'scroll_depth': '100%'
        });
      }
    }
  });
}

// Auto-initialize scroll tracking when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  const pageName = document.title || window.location.pathname;
  initScrollTracking(pageName);
});
</script>


    <!-- Structured Data (JSON-LD) for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "name": "Specifys.ai",
      "url": "https://specifys-ai.com",
      "logo": "https://specifys-ai.com/favicon.ico",
      "description": "AI-powered app planning and specification generation platform",
      "sameAs": [
        "https://www.linkedin.com/company/specifys-ai/"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "email": "specifysai@gmail.com",
        "contactType": "Customer Service"
      }
    },
    {
      "@type": "WebSite",
      "name": "Specifys.ai",
      "url": "https://specifys-ai.com",
      "description": "Plan your app smarter with AI-driven insights and tools",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://specifys-ai.com/pages/ToolPicker.html?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "SoftwareApplication",
      "name": "Specifys.ai",
      "applicationCategory": "DevelopmentApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "250"
      },
      "description": "AI-powered app planning platform with specification generator, market research tools, and vibe coding tools map"
    }
  ]
}
</script>


</head>


<body>
    <!-- Header -->
    <!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Header -->
<header class="thematic-header" role="banner">
    <div class="header-center">
        <div class="logo">
            <a href="/" aria-label="Specifys.ai homepage">
                <span class="logo-text">Specifys<span class="logo-dot">.</span>AI</span>
            </a>
        </div>
    </div>
    <div class="header-right">
        <div class="auth-buttons" id="auth-buttons">
            <!-- Will be populated by auth system -->
        </div>
    </div>
</header>

<style>
/* Logo dark grey color - adjusted size */
.logo a,
.logo-text {
    color: #333 !important;
    font-size: 1.66rem !important;
}

/* Only the dot in orange */
.logo-dot {
    color: #FF6B35 !important;
}

.logo a:hover {
    color: #444 !important;
}

.logo a:hover .logo-dot {
    color: #FF8551 !important;
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .logo a,
    .logo-text {
        font-size: 1.22rem !important;
    }
}

@media (max-width: 480px) {
    .logo a,
    .logo-text {
        font-size: 1.11rem !important;
    }
}

/* Pagination Styles */
.pagination-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    padding: 20px 0;
}

.pagination-btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
}

.pagination-btn:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #FF6B35;
    color: #FF6B35;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

/* Search Input Styles */
.search-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: #FF6B35;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.sort-select {
    transition: all 0.2s ease;
}

.sort-select:focus {
    outline: none;
    border-color: #FF6B35;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}
</style>


    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
            <main class="profile-container">
        <!-- User Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar-section">
                <div class="avatar-placeholder" id="user-avatar">
                    <span id="avatar-initial">ðŸ‘¤</span>
                </div>
                <div class="profile-actions-buttons">
                    <button class="personal-info-btn" onclick="openPersonalInfoPanel()" title="Personal Information">
                        <i class="fas fa-user-circle"></i> Personal Info
                    </button>
                    <button class="admin-dashboard-btn" id="admin-dashboard-btn" style="display: none;" onclick="window.location.href='/pages/admin-dashboard.html'" title="Admin Dashboard">
                        <i class="fas fa-user-shield"></i> Admin Dashboard
                    </button>
                    <button class="logout-btn-small" onclick="logout()" title="Sign Out">
                        Sign Out
                    </button>
                </div>
            </div>
            <div class="profile-info">
                <h2 id="user-name">Loading...</h2>
                <p id="user-email">Loading...</p>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number" id="specs-count">0</div>
                    <div class="stat-label">Specs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="specs-remaining-count">âˆž</div>
                    <div class="stat-label">Remaining Specs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="saved-tools-count">0</div>
                    <div class="stat-label">Tools</div>
                </div>
            </div>
        </div>


        <!-- Workspace Section -->
        <div class="profile-specs-section">
            <div class="section-header">
                <h3>Workspace</h3>
                <div class="section-actions">
                    <button class="create-app-btn" onclick="goToCreateSpec()" title="Create New Specification">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Search and Sort -->
            <div class="workspace-controls" style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                <input type="text" id="workspace-search" placeholder="Search workspace items..." class="search-input" style="flex: 1; min-width: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <select id="workspace-sort" class="sort-select" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="a-z">A-Z</option>
                    <option value="z-a">Z-A</option>
                </select>
            </div>

            <div id="workspace-container" class="workspace-grid">
                <div class="loading">Loading workspace...</div>
            </div>

            <!-- Pagination -->
            <div id="workspace-pagination" class="pagination-container" style="display: none; margin-top: 20px; text-align: center;">
                <button class="pagination-btn" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="pagination-info" id="pagination-info">Page 1 of 1</span>
                <button class="pagination-btn" id="next-page">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- User's Content Section - Saved Tools Only -->
        <div class="profile-specs-section">
            <div class="section-header">
                <h3>My Content</h3>
            </div>
            
            <div class="tabbed-section">
                <div class="tab-header">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="tools">
                            <i class="fas fa-wrench"></i> Saved Tools
                        </button>
                    </div>
                    <div class="tab-actions" id="profile-tab-actions">
                        <div class="action-buttons">
                            <!-- Filters removed as requested -->
                        </div>
                    </div>
                </div>
                <div class="tab-content expanded">
                    <div class="tab-pane active" id="tools-tab">
                        <div id="tools-container" class="apps-grid">
                            <div class="loading">Loading tools...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Personal Information Side Panel -->
    <div id="personalInfoPanel" class="personal-info-panel">
        <div class="panel-overlay" onclick="closePersonalInfoPanel()"></div>
        <div class="panel-content">
            <div class="panel-header">
                <h2><i class="fas fa-user-circle"></i> Account & Subscription</h2>
                <button class="panel-close" onclick="closePersonalInfoPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="panel-body" id="personalInfoContent">
                <div class="info-section">
                    <h3>Personal Information</h3>
                    <div class="info-card">
                        <div class="info-row">
                            <label>Display Name</label>
                            <div class="info-value">
                                <span id="info-display-name">Loading...</span>
                                <button class="edit-btn" onclick="editDisplayName()"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                        <div class="info-row">
                            <label>Email</label>
                            <div class="info-value" id="info-email">Loading...</div>
                        </div>
                        <div class="info-row">
                            <label>Account Created</label>
                            <div class="info-value" id="info-created">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Subscription Details</h3>
                    <div class="info-card">
                        <div class="info-row">
                            <label>Plan Type</label>
                            <div class="info-value">
                                <span id="info-plan" class="plan-badge">Loading...</span>
                            </div>
                        </div>
                        <div class="info-row" id="renewal-row" style="display: none;">
                            <label>Renewal Date</label>
                            <div class="info-value" id="info-renewal-date">-</div>
                        </div>
                        <div class="info-row" id="cost-row" style="display: none;">
                            <label>Renewal Cost</label>
                            <div class="info-value" id="info-renewal-cost">-</div>
                        </div>
                        <div class="info-row">
                            <label>Status</label>
                            <div class="info-value"><span id="info-status" class="status-badge">Loading...</span></div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Usage & Credits</h3>
                    <div class="info-card">
                        <div class="info-row">
                            <label>Specs Remaining</label>
                            <div class="info-value" id="info-specs">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Manage Subscription</h3>
                    <div class="info-card">
                        <button class="panel-action-btn" id="manageSubBtn" onclick="manageSubscription()">
                            <i class="fas fa-external-link-alt"></i> Manage in LemonSqueezy
                        </button>
                        <button class="panel-action-btn cancel-btn" id="cancelSubBtn" onclick="cancelSubscription()" style="display: none;">
                            <i class="fas fa-times-circle"></i> Cancel Subscription
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Display Name Modal -->
    <div id="editNameModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Display Name</h3>
                <button class="modal-close" onclick="closeEditNameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editDisplayNameInput">Display Name</label>
                    <input type="text" id="editDisplayNameInput" placeholder="Enter your display name" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditNameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDisplayName()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Button - Only visible for admins -->
    <div class="admin-section" style="margin: 40px auto; text-align: center; padding: 20px; max-width: 1200px; display: none;">
        <a href="admin-dashboard.html" class="btn btn-primary">
            <i class="fas fa-tachometer-alt"></i>
            Admin Dashboard
        </a>
    </div>

    <script src="../assets/js/script.js"></script>

    <!-- Header and Theme JavaScript -->
    <script>
        // Basic header functionality
        document.addEventListener('DOMContentLoaded', function() {
            
            
            
        });

        // Auth UI functions will be handled by the modern Firebase v9+ script below
    </script>

    <!-- Auth System Script -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            getAuth,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { doc as firestoreDoc, setDoc as firestoreSetDoc, serverTimestamp as firestoreServerTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        import { 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            orderBy,
            serverTimestamp,
            getFirestore,
            deleteDoc,
            doc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9hr0IWM4EREzkKDxBxYoYinV6LJXWXV4",
    authDomain: "specify-ai.firebaseapp.com",
    projectId: "specify-ai",
    storageBucket: "specify-ai.firebasestorage.app",
            messagingSenderId: "734278787482",
            appId: "1:734278787482:web:0e312fb6f197e849695a23",
            measurementId: "G-4YR9LK63MR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Create user document in Firestore
        async function createUserDocumentInProfile(user) {
            try {
                const userRef = firestoreDoc(db, 'users', user.uid);
                await firestoreSetDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    emailVerified: user.emailVerified,
                    createdAt: firestoreServerTimestamp(),
                    lastActive: firestoreServerTimestamp(),
                    newsletterSubscription: false
                }, { merge: true });
            } catch (error) {
                console.error('âŒ Error creating user document:', error);
            }
        }

        let currentUser = null;
        let userSpecs = [];
        let userApps = [];
        let userSavedTools = [];
        let userMarketResearch = [];
        
        // Pagination variables
        let workspaceItems = [];
        let currentPage = 1;
        const itemsPerPage = 6;
        let filteredItems = [];
        
        // Prevent multiple event listeners and debouncing
        let eventListenersSetup = false;
        let updateTimeout;

        // Auth state change handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Create/update user document in Firestore
                await createUserDocumentInProfile(user);
                
                updateProfileInfo(user);
                loadWorkspace();
                loadUserSavedTools();
                loadSpecsRemaining();
                updateAuthUI(user);
            } else {
                // Redirect to login if not authenticated
                window.location.href = '../index.html';
            }
        });

        // Update profile information
        function updateProfileInfo(user) {
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            const avatarInitial = document.getElementById('avatar-initial');

            if (userName) {
                userName.textContent = user.displayName || user.email.split('@')[0];
            }
            
            if (userEmail) {
                userEmail.textContent = user.email;
            }
            
            if (avatarInitial) {
                if (user.displayName) {
                    avatarInitial.textContent = user.displayName.charAt(0).toUpperCase();
                } else {
                    avatarInitial.textContent = user.email.charAt(0).toUpperCase();
                }
            }
            
            // Check admin access and show/hide admin dashboard button
            checkAdminAccess(user);
        }

        // Load workspace data (apps + specs + research)
        async function loadWorkspace() {
            if (!currentUser) return;
            
            try {
                workspaceItems = [];
                
                // Load Apps
                const appsQuery = query(
                    collection(db, 'apps'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                const appsSnapshot = await getDocs(appsQuery);
                appsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    workspaceItems.push({
                        id: doc.id,
                        type: 'app',
                        title: data.name,
                        description: data.description,
                        createdAt: data.createdAt,
                        updatedAt: data.updatedAt,
                        status: data.status,
                        viewUrl: `app-dashboard.html?id=${doc.id}`
                    });
                });
                
                // Load ALL Specs (both new and old)
                const specsQuery = query(
                    collection(db, 'specs'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                const specsSnapshot = await getDocs(specsQuery);
                specsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Determine if it's a new spec (from spec-viewer) or old spec
                    const isNewSpec = data.technical !== undefined || data.market !== undefined;
                    const isMarketResearch = data.mode === 'market';
                    
                    if (isMarketResearch) {
                        // Old market research
                        workspaceItems.push({
                            id: doc.id,
                            type: 'research',
                            title: data.title,
                            createdAt: data.createdAt,
                            viewUrl: `legacy-viewer.html?id=${doc.id}`
                        });
                    } else if (isNewSpec) {
                        // New spec from spec-viewer
                        workspaceItems.push({
                            id: doc.id,
                            type: 'new-spec',
                            title: data.title,
                            description: data.overview ? data.overview.substring(0, 100) + '...' : 'Complete specification with technical details',
                            overview: data.overview,
                            createdAt: data.createdAt,
                            updatedAt: data.updatedAt,
                            status: data.status,
                            design: data.design,
                            diagrams: data.diagrams,
                            viewUrl: `spec-viewer.html?id=${doc.id}`
                        });
                    } else {
                        // Old spec
                        workspaceItems.push({
                            id: doc.id,
                            type: 'old-spec',
                            title: data.title,
                            description: 'Legacy specification document',
                            createdAt: data.createdAt,
                            updatedAt: data.updatedAt,
                            viewUrl: `legacy-viewer.html?id=${doc.id}`
                        });
                    }
                });
                
                // Load Market Research from dedicated collection
                const researchQuery = query(
                    collection(db, 'marketResearch'),
                    where('userId', '==', currentUser.uid)
                );
                const researchSnapshot = await getDocs(researchQuery);
                researchSnapshot.forEach((doc) => {
                    const data = doc.data();
                    workspaceItems.push({
                        id: doc.id,
                        type: 'research',
                        title: data.title,
                        description: 'Market research and analysis',
                        createdAt: data.createdAt,
                        updatedAt: data.updatedAt,
                        viewUrl: `legacy-viewer.html?id=${doc.id}`
                    });
                });
                
                // Sort by creation date (newest first)
                workspaceItems.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt);
                    const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt);
                    return dateB - dateA;
                });
                
                // Update stats - count specs (new-spec + old-spec)
                const specsCount = workspaceItems.filter(item => 
                    item.type === 'new-spec' || item.type === 'old-spec'
                ).length;
                document.getElementById('specs-count').textContent = specsCount;
                
                // Reset pagination and apply initial sorting
                currentPage = 1;
                filteredItems = [...workspaceItems];
                applySorting(); // Apply initial sorting
                renderWorkspace(filteredItems);
                setupPagination();
                setupSearch();
                
            } catch (error) {
                console.error('Error loading workspace:', error);
                document.getElementById('workspace-container').innerHTML = '<div class="error">Error loading workspace</div>';
            }
        }

        // Pagination setup
        function setupPagination() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            const paginationContainer = document.getElementById('workspace-pagination');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderWorkspace(filteredItems);
                    setupPagination();
                }
            };
            
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderWorkspace(filteredItems);
                    setupPagination();
                }
            };
        }
        
        // Search and Sort setup
        function setupSearch() {
            const searchInput = document.getElementById('workspace-search');
            const sortSelect = document.getElementById('workspace-sort');
            
            if (searchInput) {
                searchInput.oninput = (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (searchTerm === '') {
                        filteredItems = [...workspaceItems];
                    } else {
                        filteredItems = workspaceItems.filter(item => {
                            const title = item.title?.toLowerCase() || '';
                            const description = item.description?.toLowerCase() || '';
                            return title.includes(searchTerm) || description.includes(searchTerm);
                        });
                    }
                    
                    // Apply sorting to filtered items
                    applySorting();
                    
                    currentPage = 1;
                    renderWorkspace(filteredItems);
                    setupPagination();
                };
            }
            
            if (sortSelect) {
                sortSelect.onchange = () => {
                    applySorting();
                    currentPage = 1;
                    renderWorkspace(filteredItems);
                    setupPagination();
                };
            }
        }
        
        // Apply sorting to filtered items
        function applySorting() {
            const sortSelect = document.getElementById('workspace-sort');
            if (!sortSelect) return;
            
            const sortOrder = sortSelect.value;
            
            filteredItems.sort((a, b) => {
                switch(sortOrder) {
                    case 'newest':
                        const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt);
                        const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt);
                        return dateB - dateA;
                    
                    case 'oldest':
                        const dateA_old = a.createdAt?.toDate?.() || new Date(a.createdAt);
                        const dateB_old = b.createdAt?.toDate?.() || new Date(b.createdAt);
                        return dateA_old - dateB_old;
                    
                    case 'a-z':
                        const titleA = (a.title || '').toLowerCase();
                        const titleB = (b.title || '').toLowerCase();
                        return titleA.localeCompare(titleB);
                    
                    case 'z-a':
                        const titleA_z = (a.title || '').toLowerCase();
                        const titleB_z = (b.title || '').toLowerCase();
                        return titleB_z.localeCompare(titleA_z);
                    
                    default:
                        return 0;
                }
            });
        }

        // Render workspace items
        function renderWorkspace(items) {
            const workspaceContainer = document.getElementById('workspace-container');
            
            if (items.length === 0) {
                workspaceContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon"><i class="fas fa-folder-open"></i></div>
                        <h4>Your workspace is empty</h4>
                        <p>Create your first app or specification to get started!</p>
                        <button class="btn" onclick="showCreateAppModal()">
                            Create New App
                        </button>
                    </div>
                `;
                return;
            }
            
            // Paginate items
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = items.slice(startIndex, endIndex);
            
            workspaceContainer.innerHTML = paginatedItems.map(item => {
                const date = new Date(item.createdAt?.toDate?.() || item.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                
                // Determine progress based on item type
                let progressItems = [];
                
                if (item.type === 'app') {
                    progressItems = [
                        { name: 'Planning', status: 'ready' },
                        { name: 'Design', status: 'in-progress' },
                        { name: 'Development', status: 'pending' },
                        { name: 'Testing', status: 'not-started' },
                        { name: 'Launch', status: 'not-started' }
                    ];
                } else if (item.type === 'new-spec') {
                    // For spec-viewer specs, check actual status
                    const status = item.status || {};
                    // Check if design exists in the spec data
                    const hasDesign = item.design !== undefined && item.design !== null;
                    const designStatus = hasDesign ? 'ready' : (status.design || 'pending');
                    
                    // Check if diagrams exist and are valid
                    const hasDiagrams = item.diagrams !== undefined && 
                                       item.diagrams !== null && 
                                       item.diagrams.generated === true &&
                                       item.diagrams.diagrams && 
                                       Array.isArray(item.diagrams.diagrams) && 
                                       item.diagrams.diagrams.length > 0;
                    const diagramsStatus = hasDiagrams ? 'ready' : (status.diagrams || 'pending');
                    
                    progressItems = [
                        { name: 'Overview', status: status.overview || 'ready' },
                        { name: 'Technical', status: status.technical || 'pending' },
                        { name: 'Market', status: status.market || 'pending' },
                        { name: 'Design', status: designStatus },
                        { name: 'Diagrams', status: diagramsStatus }
                    ];
                } else {
                    // For old specs and research
                    progressItems = [
                        { name: 'Analysis', status: 'ready' },
                        { name: 'Research', status: 'ready' },
                        { name: 'Documentation', status: 'in-progress' },
                        { name: 'Diagrams', status: 'pending' }
                    ];
                }
                
                const progressHTML = progressItems.map(progress => `
                    <div class="progress-item ${progress.status}" data-tooltip="${getTooltipText(progress.status)}">
                        ${getStatusIcon(progress.status)}
                        <span>${progress.name}</span>
                    </div>
                `).join('');
                
                return `
                    <div class="workspace-item ${item.type}" data-item-id="${item.id}" data-item-type="${item.type}" data-tooltip="${getItemTooltip(item)}">
                        <div class="workspace-item-header">
                            <h4 class="workspace-item-title">${item.title}</h4>
                            <p class="workspace-item-description">${getItemDescription(item)}</p>
                        </div>
                        
                        <div class="workspace-progress">
                            <div class="workspace-progress-title">Progress:</div>
                            <div class="progress-items">
                                ${progressHTML}
                            </div>
                        </div>
                        
                        <div class="workspace-item-footer">
                            <div class="workspace-item-dates">
                                <small>Created: ${date}</small>
                            </div>
                            <a href="${item.viewUrl}" class="workspace-view-btn">
                                View Project â†’
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get tooltip text
        function getTooltipText(status) {
            switch(status) {
                case 'ready': return 'Completed and ready';
                case 'in-progress': return 'Currently in progress';
                case 'pending': return 'Waiting to start';
                case 'not-started': return 'Not yet started';
                default: return 'Unknown status';
            }
        }

        // Helper function to get item tooltip
        function getItemTooltip(item) {
            if (item.type === 'app') {
                return 'Mobile application project - Click to view dashboard';
            } else if (item.type === 'new-spec') {
                return 'Complete specification with technical details - Click to view';
            } else if (item.type === 'old-spec') {
                return 'Legacy specification document - Click to view';
            } else if (item.type === 'research') {
                return 'Market research and analysis - Click to view';
            }
            return 'Project documentation - Click to view';
        }

        // Helper function to get status icon
        function getStatusIcon(status) {
            switch(status) {
                case 'ready': return '<i class="fas fa-check-circle"></i>';
                case 'in-progress': return '<i class="fas fa-clock"></i>';
                case 'pending': return '<i class="fas fa-circle"></i>';
                case 'not-started': return '<i class="fas fa-times-circle"></i>';
                default: return '<i class="fas fa-circle"></i>';
            }
        }

        // Helper function to get item description
        function getItemDescription(item) {
            // Don't use item.description if it looks like JSON, prefer extracting from overview
            if (item.description && !item.description.startsWith('{')) {
                return item.description;
            }
            
            if (item.type === 'app') {
                return item.description || 'Mobile application project';
            } else if (item.type === 'new-spec') {
                // Extract description from overview JSON
                if (item.overview) {
                    try {
                        const overviewData = typeof item.overview === 'string' ? JSON.parse(item.overview) : item.overview;
                        
                        // The structure is nested: { overview: { ideaSummary: "..." } }
                        if (overviewData.overview && overviewData.overview.ideaSummary) {
                            const text = overviewData.overview.ideaSummary;
                            return text.substring(0, 120) + (text.length > 120 ? '...' : '');
                        }
                        
                        // Fallback for direct structure
                        if (overviewData.ideaSummary) {
                            const text = overviewData.ideaSummary;
                            return text.substring(0, 120) + (text.length > 120 ? '...' : '');
                        }
                    } catch (e) {
                        // If JSON parsing fails, try to extract text using regex
                        try {
                            // Try to find ideaSummary in the text
                            const match = item.overview.match(/"ideaSummary":"([^"]+)"/);
                            if (match && match[1]) {
                                const text = match[1].replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                                return text.substring(0, 120) + (text.length > 120 ? '...' : '');
                            }
                            
                            // Fallback: remove JSON structure and clean
                            let cleanText = item.overview;
                            // Remove the prefix if exists
                            if (cleanText.includes('"ideaSummary":"')) {
                                cleanText = cleanText.substring(cleanText.indexOf('"ideaSummary":"') + 16);
                                cleanText = cleanText.substring(0, cleanText.indexOf('"'));
                                cleanText = cleanText.replace(/\\"/g, '"');
                                return cleanText.substring(0, 120) + (cleanText.length > 120 ? '...' : '');
                            }
                        } catch (e2) {
                            return 'Complete specification with technical details';
                        }
                    }
                }
                return 'Complete specification with technical details';
            } else if (item.type === 'old-spec') {
                return 'Legacy specification document';
            } else if (item.type === 'research') {
                return 'Market research and analysis';
            }
            return 'Project documentation';
        }

        // Load user apps
        async function loadUserApps() {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'apps'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                userApps = [];
                
                querySnapshot.forEach((doc) => {
                    const appData = {
                        id: doc.id,
                        ...doc.data()
                    };
                    userApps.push(appData);
                });
                
                document.getElementById('apps-count').textContent = userApps.length;
                renderApps();
                
                // Update button appearance after loading apps
                setTimeout(updateLinkButtonAppearance, 200);
            } catch (error) {
                console.error('Error loading apps:', error);
                document.getElementById('apps-container').innerHTML = '<div class="error">Error loading apps</div>';
            }
        }

        // Load user specs
        async function loadUserSpecs() {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'specs'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                userSpecs = [];
                
                querySnapshot.forEach((doc) => {
                    userSpecs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                document.getElementById('specs-count').textContent = userSpecs.length;
                renderSpecs();
                setTimeout(updateLinkButtonAppearance, 100);
            } catch (error) {
                console.error('Error loading specs:', error);
                document.getElementById('specs-container').innerHTML = '<div class="error">Error loading specifications</div>';
            }
        }

        // Load user saved tools
        async function loadUserSavedTools() {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'userTools', currentUser.uid, 'savedTools'),
                    orderBy('addedAt', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                userSavedTools = [];
                
                querySnapshot.forEach((doc) => {
                    userSavedTools.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                document.getElementById('saved-tools-count').textContent = userSavedTools.length;
                renderSavedTools(userSavedTools);
            } catch (error) {
                console.error('Error loading saved tools:', error);
                document.getElementById('tools-container').innerHTML = '<div class="error">Error loading saved tools</div>';
            }
        }

        // Load specs remaining
        async function loadSpecsRemaining() {
            if (!currentUser) return;
            
            try {
                // Load entitlements
                const entitlementsRef = doc(db, 'entitlements', currentUser.uid);
                const entitlementsDoc = await getDoc(entitlementsRef);
                
                // Load user doc as fallback
                const userRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                const specsRemainingEl = document.getElementById('specs-remaining-count');
                
                if (entitlementsDoc.exists()) {
                    const entitlements = entitlementsDoc.data();
                    const unlimited = entitlements.unlimited || false;
                    const specCredits = entitlements.spec_credits || 0;
                    
                    if (unlimited) {
                        specsRemainingEl.innerHTML = 'âˆž';
                    } else if (specCredits > 0) {
                        specsRemainingEl.textContent = specCredits;
                    } else if (userDoc.exists()) {
                        // If no purchased credits, check free specs
                        const userData = userDoc.data();
                        const freeSpecs = typeof userData.free_specs_remaining === 'number' ? userData.free_specs_remaining : 1;
                        specsRemainingEl.textContent = freeSpecs;
                    } else {
                        specsRemainingEl.textContent = '0';
                    }
                } else if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const freeSpecs = typeof userData.free_specs_remaining === 'number' ? userData.free_specs_remaining : 1;
                    specsRemainingEl.textContent = freeSpecs;
                } else {
                    specsRemainingEl.textContent = '0';
                }
            } catch (error) {
                console.error('Error loading specs remaining:', error);
                document.getElementById('specs-remaining-count').textContent = '-';
            }
        }

        // Load user market research
        async function loadUserMarketResearch() {
            if (!currentUser) return;
            
            try {
                // Load from marketResearch collection (new)
                const q1 = query(
                    collection(db, 'marketResearch'),
                    where('userId', '==', currentUser.uid)
                );
                
                const querySnapshot1 = await getDocs(q1);
                userMarketResearch = [];
                
                querySnapshot1.forEach((doc) => {
                    userMarketResearch.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load from specs collection with mode: "market" (old)
                const q2 = query(
                    collection(db, 'specs'),
                    where('userId', '==', currentUser.uid),
                    where('mode', '==', 'market')
                );
                
                const querySnapshot2 = await getDocs(q2);
                
                querySnapshot2.forEach((doc) => {
                    userMarketResearch.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                userMarketResearch.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || a.createdAt;
                    const dateB = b.createdAt?.toDate?.() || b.createdAt;
                    return new Date(dateB) - new Date(dateA);
                });
                
                document.getElementById('research-count').textContent = userMarketResearch.length;
                renderMarketResearch();
                setTimeout(updateLinkButtonAppearance, 100);
            } catch (error) {
                console.error('Error loading market research:', error);
                document.getElementById('research-count').textContent = '0';
            }
        }

        // Render saved tools in grid layout
        function renderSavedTools(tools) {
            const toolsContainer = document.getElementById('tools-container');
            
            if (tools.length === 0) {
                toolsContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon"><i class="fas fa-wrench"></i></div>
                        <h4>No saved tools yet</h4>
                        <p>Add tools from the Tools Map to see them here!</p>
                        <a href="../tools/map/vibe-coding-tools-map.html" class="btn">Explore Tools Map</a>
                    </div>
                `;
                return;
            }

            toolsContainer.innerHTML = tools.map(tool => `
                <div class="app-card" data-tool-id="${tool.id}">
                    <div class="app-card-header">
                        <h4 class="app-card-title">
                            <span class="spec-link">${tool.name || 'Unknown Tool'}</span>
                        </h4>
                        <div class="app-card-actions">
                            <button class="btn-icon" onclick="removeSavedTool('${tool.id}')" title="Remove from saved tools">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${tool.link && tool.link !== '#' ? `<button class="btn-icon" onclick="window.open('${tool.link}', '_blank')" title="Visit tool website"><i class="fas fa-external-link-alt"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="app-card-content">
                        <div class="app-stats-minimal">
                            <div class="app-stat-minimal">
                                <i class="fas fa-wrench"></i>
                                <span>Tool</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-card-footer">
                        <small>Saved: ${new Date(tool.addedAt).toLocaleDateString()}</small>
                    </div>
                </div>
            `).join('');
        }

        // Render apps in grid layout
        function renderApps() {
            const appsContainer = document.getElementById('apps-container');
            
            if (userApps.length === 0) {
                appsContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon"><i class="fas fa-mobile-alt"></i></div>
                        <h4>No apps yet</h4>
                        <p>Create your first app to get started!</p>
                        <button class="btn" onclick="showCreateAppModal()">
                            Create New App
                        </button>
                    </div>
                `;
                return;
            }
            
            appsContainer.innerHTML = userApps.map(app => {
                const specsCount = app.linkedSpecs ? app.linkedSpecs.length : 0;
                const researchCount = app.linkedResearch ? app.linkedResearch.length : 0;
                
                return `
                    <div class="app-card" data-app-id="${app.id}">
                        <div class="app-card-header">
                            <h4 class="app-card-title">
                                <a href="app-dashboard.html?id=${app.id}" class="spec-link">${app.name}</a>
                            </h4>
                            <div class="app-card-actions">
                                <button class="btn-icon" onclick="editAppCard('${app.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteAppCard('${app.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="app-card-content">
                            
                            <!-- App Statistics - Simplified -->
                            <div class="app-stats-minimal">
                                <div class="app-stat-minimal">
                                    <i class="fas fa-file-alt"></i>
                                    <span>${specsCount} Specs</span>
                                </div>
                                <div class="app-stat-minimal">
                                    <i class="fas fa-search"></i>
                                    <span>${researchCount} Research</span>
                                </div>
                            </div>
                        </div>
                        <div class="app-card-footer">
                            <small>Created: ${new Date(app.createdAt?.toDate?.() || app.createdAt).toLocaleDateString('en-US')}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render specs in grid layout
        function renderSpecs() {
            const specsContainer = document.getElementById('specs-container');
            
            if (userSpecs.length === 0) {
                specsContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon"><i class="fas fa-file-alt"></i></div>
                        <h4>No specifications yet</h4>
                        <p>Create your first specification to get started!</p>
                        <button class="btn" onclick="window.location.href='../index.html'">
                            Create New Specification
                        </button>
                    </div>
                `;
                return;
            }
            
            specsContainer.innerHTML = userSpecs.map(spec => `
                <div class="app-card" data-spec-id="${spec.id}">
                    <div class="app-card-header">
                        <h4 class="app-card-title">
                            <a href="legacy-viewer.html?id=${spec.id}" class="spec-link">${spec.title}</a>
                        </h4>
                        <div class="app-card-actions">
                            <button class="btn-icon link-spec-btn" data-spec-id="${spec.id}" title="Link to App">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn-icon" onclick="editSpecCard('${spec.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteSpecCard('${spec.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="app-card-content">
                        <div class="app-stats-minimal">
                            <div class="app-stat-minimal">
                                <i class="fas fa-file-alt"></i>
                                <span>Specification</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-card-footer">
                        <small>Created: ${new Date(spec.createdAt?.toDate?.() || spec.createdAt).toLocaleDateString('en-US')}</small>
                    </div>
                </div>
            `).join('');
            
            // Update link button appearance after rendering specs
            setTimeout(updateLinkButtonAppearance, 50);
        }

        // Render market research in grid layout
        function renderMarketResearch() {
            const researchContainer = document.getElementById('research-container');
            
            if (userMarketResearch.length === 0) {
                researchContainer.innerHTML = `
                    <div class="no-specs">
                        <div class="no-specs-icon"><i class="fas fa-search"></i></div>
                        <h4>No market research yet</h4>
                        <p>Create your first market research to get started!</p>
                        <button class="btn" onclick="window.location.href='processing-market.html'">
                            Create New Market Research
                        </button>
                    </div>
                `;
                return;
            }
            
            researchContainer.innerHTML = userMarketResearch.map(research => `
                <div class="app-card" data-research-id="${research.id}">
                    <div class="app-card-header">
                        <h4 class="app-card-title">
                            <a href="legacy-viewer.html?id=${research.id}" class="spec-link">${research.title}</a>
                        </h4>
                        <div class="app-card-actions">
                            <button class="btn-icon link-research-btn" data-research-id="${research.id}" title="Link to App">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn-icon" onclick="editResearchCard('${research.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteResearchCard('${research.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="app-card-content">
                        <div class="app-stats-minimal">
                            <div class="app-stat-minimal">
                                <i class="fas fa-search"></i>
                                <span>Market Research</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-card-footer">
                        <small>Created: ${new Date(research.createdAt?.toDate?.() || research.createdAt).toLocaleDateString('en-US')}</small>
                    </div>
                </div>
            `).join('');
            
            // Update link button appearance after rendering market research
            setTimeout(updateLinkButtonAppearance, 50);
        }

        // Search functionality for apps - removed as requested

        // Search functionality for tabbed content
        // Search functionality for tabbed content - removed as requested

        // Sort functionality for apps - removed as requested

        // Sort functionality for tabbed content
        // Sort functionality for tabbed content - removed as requested

        function renderFilteredApps(apps) {
            const appsContainer = document.getElementById('apps-container');
            
            if (apps.length === 0) {
                appsContainer.innerHTML = '<div class="no-results">No apps found</div>';
                return;
            }
            
            appsContainer.innerHTML = apps.map(app => {
                const specsCount = app.linkedSpecs ? app.linkedSpecs.length : 0;
                const researchCount = app.linkedResearch ? app.linkedResearch.length : 0;
                
                return `
                    <div class="app-card" data-app-id="${app.id}">
                        <div class="app-card-header">
                            <h4 class="app-card-title">
                                <a href="app-dashboard.html?id=${app.id}" class="spec-link">${app.name}</a>
                            </h4>
                            <div class="app-card-actions">
                                <button class="btn-icon" onclick="editAppCard('${app.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteAppCard('${app.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="app-card-content">
                            
                            <!-- App Statistics - Simplified -->
                            <div class="app-stats-minimal">
                                <div class="app-stat-minimal">
                                    <i class="fas fa-file-alt"></i>
                                    <span>${specsCount} Specs</span>
                                </div>
                                <div class="app-stat-minimal">
                                    <i class="fas fa-search"></i>
                                    <span>${researchCount} Research</span>
                                </div>
                            </div>
                        </div>
                        <div class="app-card-footer">
                            <small>Created: ${new Date(app.createdAt?.toDate?.() || app.createdAt).toLocaleDateString('en-US')}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFilteredSpecs(specs) {
            const specsContainer = document.getElementById('specs-container');
            
            if (specs.length === 0) {
                specsContainer.innerHTML = '<div class="no-results">No specifications found</div>';
                return;
            }
            
            specsContainer.innerHTML = specs.map(spec => `
                <div class="spec-card" data-spec-id="${spec.id}">
                    <div class="spec-card-header">
                        <h4 class="spec-card-title">
                            <a href="legacy-viewer.html?id=${spec.id}" class="spec-link">${spec.title}</a>
                        </h4>
                        <div class="spec-card-actions">
                            <button class="btn-icon link-spec-btn" data-spec-id="${spec.id}" title="Link to App">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn-icon" onclick="editSpecCard('${spec.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteSpecCard('${spec.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="spec-card-content">
                        <!-- Mode badge removed as requested -->
                    </div>
                    <div class="spec-card-footer">
                        <small>Created: ${new Date(spec.createdAt?.toDate?.() || spec.createdAt).toLocaleDateString('en-US')}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderFilteredResearch(research) {
            const researchContainer = document.getElementById('research-container');
            
            if (research.length === 0) {
                researchContainer.innerHTML = '<div class="no-results">No market research found</div>';
                return;
            }
            
            researchContainer.innerHTML = research.map(research => `
                <div class="spec-card" data-research-id="${research.id}">
                    <div class="spec-card-header">
                        <h4 class="spec-card-title">
                            <a href="legacy-viewer.html?id=${research.id}" class="spec-link">${research.title}</a>
                        </h4>
                        <div class="spec-card-actions">
                            <button class="btn-icon link-research-btn" data-research-id="${research.id}" title="Link to App">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn-icon" onclick="editResearchCard('${research.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteResearchCard('${research.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="spec-card-content">
                        <!-- Research content preview -->
                    </div>
                    <div class="spec-card-footer">
                        <small>Created: ${new Date(research.createdAt?.toDate?.() || research.createdAt).toLocaleDateString('en-US')}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderFilteredTools(tools) {
            const toolsContainer = document.getElementById('tools-container');
            
            if (tools.length === 0) {
                toolsContainer.innerHTML = '<div class="no-results">No tools found</div>';
                return;
            }

            toolsContainer.innerHTML = tools.map(tool => `
                <div class="app-card" data-tool-id="${tool.id}">
                    <div class="app-card-header">
                        <h4 class="app-card-title">
                            <span class="spec-link">${tool.name || 'Unknown Tool'}</span>
                        </h4>
                        <div class="app-card-actions">
                            <button class="btn-icon" onclick="removeSavedTool('${tool.id}')" title="Remove from saved tools">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${tool.link && tool.link !== '#' ? `<button class="btn-icon" onclick="window.open('${tool.link}', '_blank')" title="Visit tool website"><i class="fas fa-external-link-alt"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="app-card-content">
                        <div class="app-stats-minimal">
                            <div class="app-stat-minimal">
                                <i class="fas fa-wrench"></i>
                                <span>Tool</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-card-footer">
                        <small>Saved: ${new Date(tool.addedAt).toLocaleDateString()}</small>
                    </div>
                </div>
            `).join('');
        }

        // Create app button (optional - already uses onclick in HTML)
        const createAppBtn = document.getElementById('create-app-btn');
        if (createAppBtn) {
            createAppBtn.addEventListener('click', () => {
                showCreateAppModal();
            });
        }

        // Global functions for app actions
        // Navigate to create spec (with auto-start)
        window.goToCreateSpec = function() {
            window.location.href = '/index.html?autoStart=true';
        };

        window.showCreateAppModal = function() {
            // Create modal HTML
            const modalHTML = `
                <div id="createAppModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Create New App</h3>
                            <button class="modal-close" onclick="closeCreateAppModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="appNameInput">App Name *</label>
                                <input type="text" id="appNameInput" placeholder="Enter app name..." required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeCreateAppModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="submitCreateApp()">Create App</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('appNameInput').focus();
            }, 100);
        };

        window.closeCreateAppModal = function() {
            const modal = document.getElementById('createAppModal');
            if (modal) {
                modal.remove();
            }
        };

        window.submitCreateApp = function() {
            const appNameInput = document.getElementById('appNameInput');
            const appName = appNameInput.value.trim();
            
            if (!appName) {
                appNameInput.style.borderColor = '#ff4444';
                appNameInput.focus();
                return;
            }
            
            // Close modal
            closeCreateAppModal();
            
            // Create app
            createNewApp(appName, '', 0);
        };

        window.editAppCard = async function(appId) {
            const app = userApps.find(a => a.id === appId);
            if (!app) return;
            
            const newName = prompt('Edit app name:', app.name);
            if (newName === null || newName.trim() === '') return;
            
            try {
                const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const appRef = doc(db, 'apps', appId);
                await setDoc(appRef, {
                    name: newName.trim(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Update local data
                app.name = newName.trim();
                app.updatedAt = new Date().toISOString();
                
                // Refresh the display
                renderApps();
            } catch (error) {
                console.error("Error updating app:", error);
                alert("Failed to update app. Please try again.");
            }
        };

        window.deleteAppCard = async function(appId) {
            if (!confirm('Are you sure you want to delete this app? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const appRef = doc(db, 'apps', appId);
                await deleteDoc(appRef);
                
                // Remove from local data
                userApps = userApps.filter(app => app.id !== appId);
                
                // Refresh the display
                renderApps();
            } catch (error) {
                console.error("Error deleting app:", error);
                alert("Failed to delete app. Please try again.");
            }
        };

        window.openAppDashboard = function(appId) {
            window.location.href = `app-dashboard.html?id=${appId}`;
        };

        // Global functions for spec actions
        window.editSpecCard = async function(specId) {
            const spec = userSpecs.find(s => s.id === specId);
            if (!spec) {
                alert('Specification not found');
                return;
            }
            
            const newTitle = prompt('Edit title:', spec.title);
            if (newTitle === null || newTitle.trim() === '') return;
            
            try {
                // Update in Firestore
                const specRef = doc(db, 'specs', specId);
                await setDoc(specRef, {
                    title: newTitle.trim(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Update local data
                const specIndex = userSpecs.findIndex(s => s.id === specId);
                if (specIndex !== -1) {
                    userSpecs[specIndex].title = newTitle.trim();
                }
                
                // Re-render specs
                renderSpecs();
                
                // Update link button appearance after re-render
                setTimeout(updateLinkButtonAppearance, 100);
                
                showSuccess('Specification title updated successfully!');
                
            } catch (error) {
                console.error('Error updating spec title:', error);
                showError('Failed to update specification title');
            }
        };

        window.deleteSpecCard = function(specId) {
            if (!confirm('Are you sure you want to delete this specification?')) {
                return;
            }
            
            try {
                // Remove from DOM - find and remove the spec card element
                const specCard = document.querySelector(`[data-spec-id="${specId}"]`);
                if (specCard) {
                    specCard.remove();
                }
                
                // Remove from local userSpecs array
                const specIndex = userSpecs.findIndex(spec => spec.id === specId);
                if (specIndex !== -1) {
                    userSpecs.splice(specIndex, 1);
                }
                
                // Show success message
                alert('Specification removed successfully from interface');
                
            } catch (error) {
                console.error('Error removing spec from UI:', error);
                alert('Error removing specification from interface');
            }
        };

        // Global functions for research actions
        window.editResearchCard = async function(researchId) {
            const research = userMarketResearch.find(r => r.id === researchId);
            if (!research) {
                alert('Market research not found');
                return;
            }
            
            const newTitle = prompt('Edit title:', research.title);
            if (newTitle === null || newTitle.trim() === '') return;
            
            try {
                // Update in Firestore
                const researchRef = doc(db, 'marketResearch', researchId);
                await setDoc(researchRef, {
                    title: newTitle.trim(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Update local data
                const researchIndex = userMarketResearch.findIndex(r => r.id === researchId);
                if (researchIndex !== -1) {
                    userMarketResearch[researchIndex].title = newTitle.trim();
                }
                
                // Re-render market research
                renderMarketResearch();
                
                // Update link button appearance after re-render
                setTimeout(updateLinkButtonAppearance, 100);
                
                console.log('âœ… Market research title updated successfully');
                showSuccess('Market research title updated successfully!');
                
            } catch (error) {
                console.error('Error updating market research title:', error);
                showError('Failed to update market research title');
            }
        };

        window.deleteResearchCard = function(researchId) {
            if (!confirm('Are you sure you want to delete this market research?')) {
                return;
            }
            
            // Here you would delete the research from Firestore
            alert('Delete functionality will be added soon');
        };

        // Create new app function
        async function createNewApp(name, description, budget) {
            if (!currentUser) return;
            
            try {
                const appData = {
                    name: name,
                    description: description,
                    status: 'Planning',
                    budget: budget,
                    spent: 0,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    linkedSpecs: [],
                    linkedResearch: [],
                    linkedTools: []
                };
                
                await addDoc(collection(db, 'apps'), appData);
                loadUserApps(); // Reload the apps list
                showSuccess('App created successfully!');
            } catch (error) {
                console.error('Error creating app:', error);
                showError('Failed to create app');
            }
        }

        // Global function for removing saved tool
        window.removeSavedTool = async function(toolId) {
            if (!confirm('Are you sure you want to remove this tool from your saved list?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'userTools', currentUser.uid, 'savedTools', toolId));
                loadUserSavedTools(); // Reload the list
                showSuccess('Tool removed from saved list');
            } catch (error) {
                console.error('Error removing tool:', error);
                showError('Failed to remove tool from saved list');
            }
        };

        // Utility functions
        function showSuccess(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
                animation: slideUp 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 3000);
        }

        function showError(message) {
            // Create a temporary error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
                animation: slideUp 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 5000);
        }

        // Auth UI functions
        function updateAuthUI(user) {
            const authButtons = document.getElementById('auth-buttons');
            if (!authButtons) return;
            
            if (user) {
                // User is logged in
                const displayName = user.displayName || user.email.split('@')[0];
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                authButtons.innerHTML = `
                    <a href="/pages/profile.html" class="user-info" style="text-decoration: none;">
                        <div class="user-avatar">${firstLetter}</div>
                        <span>${displayName}</span>
                    </a>
                `;
                
                // Check if user is admin and show/hide admin dashboard button
                checkAdminAccess(user);
            } else {
                // User is not logged in
                authButtons.innerHTML = `
                    <button class="auth-btn" onclick="showLoginModal()">Login</button>
                `;
            }
            
            // Update mobile auth UI if function exists
            if (window.updateMobileAuthUI) {
                window.updateMobileAuthUI(user);
            }
        }
        
        // Check admin access based on email
        function checkAdminAccess(user) {
            // Define admin emails - add your specific admin email here
            const adminEmails = [
                'specifysai@gmail.com',
                'admin@specifys.ai',
                'shalom@specifys.ai'
                // Add more admin emails as needed
            ];
            
            const isAdmin = adminEmails.includes(user.email.toLowerCase());
            
            // Show/hide admin dashboard button in profile
            const adminDashboardBtn = document.getElementById('admin-dashboard-btn');
            if (adminDashboardBtn) {
                if (isAdmin) {
                    adminDashboardBtn.style.display = 'block';
                } else {
                    adminDashboardBtn.style.display = 'none';
                }
            }
            
            // Also check for admin-section if exists (for backward compatibility)
            const adminSection = document.querySelector('.admin-section');
            if (adminSection) {
                if (isAdmin) {
                    adminSection.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                }
            }
        }

        // Global auth functions
        window.showLoginModal = function() {
            const email = prompt('Email:');
            if (!email) return;
            
            const password = prompt('Password:');
            if (!password) return;
            
            signInWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await createUserDocumentInProfile(userCredential.user);
                    alert('Logged in successfully!');
                })
                .catch(error => {
                    alert('Login error: ' + error.message);
                });
        };

        window.showRegisterModal = function() {
            const email = prompt('Email:');
            if (!email) return;
            
            const password = prompt('Password (at least 6 characters):');
            if (!password) return;
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await createUserDocumentInProfile(userCredential.user);
                    alert('Registered successfully!');
                })
                .catch(error => {
                    alert('Registration error: ' + error.message);
                });
        };

        // Logout function
        window.logout = function() {
            signOut(auth)
                .then(() => {
                    console.log('Logged out successfully');
                    // Redirect to home page after successful logout
                    window.location.href = '../index.html';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('Logout error: ' + error.message);
                });
        };


        // Global function for linking spec to app
        window.linkSpecToApp = function(specId) {
            console.log('ðŸ”— Linking spec to app:', specId);
            console.log('ðŸ“± User apps available:', userApps?.length || 0);
            
            if (!userApps || userApps.length === 0) {
                alert('No apps available to link to. Please create an app first.');
                return;
            }
            
            showLinkModal('specs', specId, 'Specifications');
        };

        // Global function for linking research to app
        window.linkResearchToApp = function(researchId) {
            console.log('ðŸ”— Linking research to app:', researchId);
            console.log('ðŸ“± User apps available:', userApps?.length || 0);
            
            if (!userApps || userApps.length === 0) {
                alert('No apps available to link to. Please create an app first.');
                return;
            }
            
            showLinkModal('marketResearch', researchId, 'Market Research');
        };

        // Show modal for linking items to apps
        async function showLinkModal(collection, itemId, itemType) {
            if (!userApps || userApps.length === 0) {
                alert('You need to create an app first before linking specifications or research.');
                return;
            }

            // Get current item data to show current title
            let currentItem = null;
            try {
                if (collection === 'specs') {
                    currentItem = userSpecs.find(spec => spec.id === itemId);
                } else if (collection === 'marketResearch') {
                    currentItem = userMarketResearch.find(research => research.id === itemId);
                }
            } catch (error) {
                console.error('Error finding current item:', error);
            }

            const currentTitle = currentItem ? currentItem.title : '';

            // Create modal HTML with title editing
            const modalHTML = `
                <div id="linkModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Link ${itemType} to App</h3>
                            <button class="modal-close" onclick="closeLinkModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Select App:</label>
                                <select id="appSelect" class="form-control">
                                    ${userApps.map(app => `<option value="${app.id}">${app.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Edit Title (optional):</label>
                                <input type="text" id="itemTitle" class="form-control" value="${currentTitle}" placeholder="Enter new title or keep current">
                                <small class="form-text text-muted">This will update the title in both your profile and the app dashboard</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeLinkModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="submitLink('${collection}', '${itemId}')">Link to App</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        window.closeLinkModal = function() {
            const modal = document.getElementById('linkModal');
            if (modal) {
                modal.remove();
            }
        };

        window.submitLink = async function(collection, itemId) {
            const appSelect = document.getElementById('appSelect');
            const titleInput = document.getElementById('itemTitle');
            const appId = appSelect.value;
            const newTitle = titleInput.value.trim();
            
            if (!appId) {
                alert('Please select an app');
                return;
            }

            try {
                // Update title if changed
                if (newTitle && newTitle !== '') {
                    const itemRef = doc(db, collection, itemId);
                    await setDoc(itemRef, {
                        title: newTitle,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    // Update local data
                    if (collection === 'specs') {
                        const specIndex = userSpecs.findIndex(spec => spec.id === itemId);
                        if (specIndex !== -1) {
                            userSpecs[specIndex].title = newTitle;
                        }
                    } else if (collection === 'marketResearch') {
                        const researchIndex = userMarketResearch.findIndex(research => research.id === itemId);
                        if (researchIndex !== -1) {
                            userMarketResearch[researchIndex].title = newTitle;
                        }
                    }
                }
                
                // Update the app document to include the linked item
                const appRef = doc(db, 'apps', appId);
                const appDoc = await getDoc(appRef);
                
                if (appDoc.exists()) {
                    const appData = appDoc.data();
                    const linkedField = collection === 'specs' ? 'linkedSpecs' : 'linkedResearch';
                    const linkedItems = appData[linkedField] || [];
                    
                    if (!linkedItems.includes(itemId)) {
                        linkedItems.push(itemId);
                        
                        await setDoc(appRef, {
                            ...appData,
                            [linkedField]: linkedItems
                        }, { merge: true });
                        
                        const itemType = collection === 'specs' ? 'Specification' : 'Market Research';
                        const titleMessage = newTitle ? ` with updated title "${newTitle}"` : '';
                        showSuccess(`${itemType}${titleMessage} linked to app successfully!`);
                        
                        // Refresh the UI
                        if (collection === 'specs') {
                            renderSpecs();
                        } else {
                            renderMarketResearch();
                        }
                        
                        // Update local userApps data and button appearance
                        if (userApps) {
                            const appIndex = userApps.findIndex(app => app.id === appId);
                            if (appIndex !== -1) {
                                const linkedField = collection === 'specs' ? 'linkedSpecs' : 'linkedResearch';
                                if (!userApps[appIndex][linkedField]) {
                                    userApps[appIndex][linkedField] = [];
                                }
                                if (!userApps[appIndex][linkedField].includes(itemId)) {
                                    userApps[appIndex][linkedField].push(itemId);
                                }
                            }
                        }
                        setTimeout(updateLinkButtonAppearance, 100);
                        
                        closeLinkModal();
                    } else {
                        alert('This item is already linked to the selected app');
                    }
                }
            } catch (error) {
                console.error('Error linking item to app:', error);
                showError('Failed to link item to app');
            }
        };

        // Profile Tab Management Function
        window.switchProfileTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            console.log('Tab switched to:', tabName);
        };

        // Event listeners for link buttons (using event delegation)
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupLinkEventListeners);
        } else {
            setupLinkEventListeners();
        }

        function setupLinkEventListeners() {
            if (eventListenersSetup) return;
            
            console.log('ðŸŽ¯ Setting up link event listeners');
            document.addEventListener('click', function(event) {
                // Handle spec link buttons
                const specButton = event.target.closest('.link-spec-btn');
                if (specButton) {
                    const specId = specButton.getAttribute('data-spec-id');
                    if (specId) {
                        console.log('ðŸ”— Linking spec:', specId);
                        window.linkSpecToApp(specId);
                    }
                    return;
                }
                
                // Handle research link buttons
                const researchButton = event.target.closest('.link-research-btn');
                if (researchButton) {
                    const researchId = researchButton.getAttribute('data-research-id');
                    if (researchId) {
                        console.log('ðŸ”— Linking research:', researchId);
                        window.linkResearchToApp(researchId);
                    }
                    return;
                }
            });
            
            eventListenersSetup = true;
        }

        // Function to check if item is linked to any app
        function isItemLinkedToApp(itemId, type) {
            if (!userApps || userApps.length === 0) {
                console.log(`ðŸš« No apps available for ${type} ${itemId}`);
                return false;
            }
            
            const isLinked = userApps.some(app => {
                const linkedItems = type === 'spec' ? app.linkedSpecs : app.linkedResearch;
                const hasItem = linkedItems && linkedItems.includes(itemId);
                console.log(`ðŸ”— App "${app.name}" has ${type} ${itemId}:`, hasItem, 'linkedItems:', linkedItems);
                return hasItem;
            });
            
            console.log(`ðŸŽ¯ Final result for ${type} ${itemId}:`, isLinked);
            return isLinked;
        }

        // Debounced function to update link button appearance
        function updateLinkButtonAppearance() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                console.log('ðŸŽ¨ Updating link button appearance...');
                console.log('ðŸ“± Available apps:', userApps?.length || 0);
                
                // Update spec link buttons
                const specButtons = document.querySelectorAll('.link-spec-btn');
                console.log('ðŸ” Found spec buttons:', specButtons.length);
                
                specButtons.forEach(button => {
                    const specId = button.getAttribute('data-spec-id');
                    const isLinked = isItemLinkedToApp(specId, 'spec');
                    console.log(`ðŸ“ Spec ${specId} linked: ${isLinked}`);
                    
                    if (isLinked) {
                        button.classList.add('linked');
                        button.title = 'Already linked to app';
                        console.log(`âœ… Added 'linked' class to spec ${specId}`);
                    } else {
                        button.classList.remove('linked');
                        button.title = 'Link to App';
                        console.log(`âŒ Removed 'linked' class from spec ${specId}`);
                    }
                });

                // Update research link buttons
                const researchButtons = document.querySelectorAll('.link-research-btn');
                console.log('ðŸ” Found research buttons:', researchButtons.length);
                
                researchButtons.forEach(button => {
                    const researchId = button.getAttribute('data-research-id');
                    const isLinked = isItemLinkedToApp(researchId, 'research');
                    console.log(`ðŸ“ Research ${researchId} linked: ${isLinked}`);
                    
                    if (isLinked) {
                        button.classList.add('linked');
                        button.title = 'Already linked to app';
                        console.log(`âœ… Added 'linked' class to research ${researchId}`);
                    } else {
                        button.classList.remove('linked');
                        button.title = 'Link to App';
                        console.log(`âŒ Removed 'linked' class from research ${researchId}`);
                    }
                });
            }, 100);
        }

        // Personal Info Panel Functions
        window.openPersonalInfoPanel = function() {
            const panel = document.getElementById('personalInfoPanel');
            if (panel) {
                panel.classList.add('active');
                loadPersonalInfo();
            }
        };

        window.closePersonalInfoPanel = function() {
            const panel = document.getElementById('personalInfoPanel');
            if (panel) {
                panel.classList.remove('active');
            }
        };

        async function loadPersonalInfo() {
            if (!currentUser) return;

            try {
                // Load user data
                const userRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                // Load subscription data
                const subRef = doc(db, 'subscriptions', currentUser.uid);
                const subDoc = await getDoc(subRef);

                // Load entitlements
                const entitlementsRef = doc(db, 'entitlements', currentUser.uid);
                const entitlementsDoc = await getDoc(entitlementsRef);

                // Update display name
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                document.getElementById('info-display-name').textContent = displayName;

                // Update email
                document.getElementById('info-email').textContent = currentUser.email;

                // Update account created
                const createdAt = currentUser.metadata?.creationTime || new Date();
                document.getElementById('info-created').textContent = new Date(createdAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Update subscription info
                if (subDoc.exists()) {
                    const subData = subDoc.data();
                    const status = subData.status || 'free';
                    const planName = getPlanName(status);
                    
                    document.getElementById('info-plan').textContent = planName;
                    document.getElementById('info-status').textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    document.getElementById('info-status').className = 'status-badge ' + status;

                    // Show renewal info for active subscriptions
                    if (status === 'active' && subData.current_period_end) {
                        const renewalDate = subData.current_period_end.toDate();
                        const cost = getPlanCost(subData.variant_id);
                        
                        document.getElementById('renewal-row').style.display = 'flex';
                        document.getElementById('cost-row').style.display = 'flex';
                        document.getElementById('info-renewal-date').textContent = renewalDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        document.getElementById('info-renewal-cost').textContent = cost;
                        document.getElementById('cancelSubBtn').style.display = 'block';
                    } else {
                        document.getElementById('renewal-row').style.display = 'none';
                        document.getElementById('cost-row').style.display = 'none';
                        document.getElementById('cancelSubBtn').style.display = 'none';
                    }
                } else {
                    document.getElementById('info-plan').textContent = 'Free';
                    document.getElementById('info-status').textContent = 'Free';
                    document.getElementById('info-status').className = 'status-badge active';
                    document.getElementById('renewal-row').style.display = 'none';
                    document.getElementById('cost-row').style.display = 'none';
                    document.getElementById('cancelSubBtn').style.display = 'none';
                    document.getElementById('manageSubBtn').textContent = 'Upgrade to Pro';
                    document.getElementById('manageSubBtn').onclick = () => {
                        window.location.href = '/pages/pricing.html';
                    };
                }

                // Update specs remaining in panel
                if (entitlementsDoc.exists()) {
                    const entitlements = entitlementsDoc.data();
                    const unlimited = entitlements.unlimited || false;
                    const specCredits = entitlements.spec_credits || 0;
                    
                    if (unlimited) {
                        document.getElementById('info-specs').innerHTML = '<span style="font-size: 1.5rem;">âˆž</span> <span style="color: #28a745;">Unlimited</span>';
                    } else if (specCredits > 0) {
                        document.getElementById('info-specs').textContent = specCredits + ' specs';
                    } else if (userDoc.exists()) {
                        // Check from user doc
                        const userData = userDoc.data();
                        const freeSpecs = typeof userData.free_specs_remaining === 'number' ? userData.free_specs_remaining : 1;
                        document.getElementById('info-specs').textContent = freeSpecs + ' free specs remaining';
                    } else {
                        document.getElementById('info-specs').textContent = '1 free spec remaining';
                    }
                } else if (userDoc.exists()) {
                    // Check from user doc
                    const userData = userDoc.data();
                    const freeSpecs = typeof userData.free_specs_remaining === 'number' ? userData.free_specs_remaining : 1;
                    document.getElementById('info-specs').textContent = freeSpecs + ' free specs remaining';
                } else {
                    document.getElementById('info-specs').textContent = '1 free spec remaining';
                }

                // Update specs remaining in header
                await loadSpecsRemaining();

            } catch (error) {
                console.error('Error loading personal info:', error);
            }
        }

        function getPlanName(status) {
            switch(status) {
                case 'active':
                    return 'PRO';
                case 'cancelled':
                    return 'PRO (Cancelled)';
                case 'expired':
                    return 'Free';
                case 'payment_failed':
                    return 'PRO (Payment Failed)';
                default:
                    return 'Free';
            }
        }

        function getPlanCost(variantId) {
            // This should match your Lemon Squeezy products
            if (variantId === 'cae56dc9-f0b9-45fa-a4af-5405e08ab8c9') {
                return '$29.90/month';
            } else if (variantId === '02828cb1-3985-437f-acb0-fe49508935c6') {
                return '$299.90/year';
            }
            return 'N/A';
        }

        window.editDisplayName = function() {
            const modal = document.getElementById('editNameModal');
            const input = document.getElementById('editDisplayNameInput');
            const displayName = document.getElementById('info-display-name').textContent;
            
            input.value = displayName;
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);
        };

        window.closeEditNameModal = function() {
            document.getElementById('editNameModal').style.display = 'none';
        };

        window.saveDisplayName = async function() {
            const newName = document.getElementById('editDisplayNameInput').value.trim();
            if (!newName) {
                alert('Please enter a display name');
                return;
            }

            try {
                // Update in Firestore
                const userRef = doc(db, 'users', currentUser.uid);
                await setDoc(userRef, {
                    displayName: newName
                }, { merge: true });

                // Update in Firebase Auth
                const auth = getAuth();
                await updateProfile(auth.currentUser, { displayName: newName });

                // Update UI
                document.getElementById('info-display-name').textContent = newName;
                document.getElementById('user-name').textContent = newName;
                closeEditNameModal();
                showSuccess('Display name updated successfully!');

            } catch (error) {
                console.error('Error updating display name:', error);
                alert('Failed to update display name');
            }
        };

        window.manageSubscription = function() {
            const panel = document.getElementById('personalInfoPanel');
            const status = document.getElementById('info-status').textContent.toLowerCase();
            
            if (status.includes('free')) {
                // Upgrade
                window.location.href = '/pages/pricing.html';
            } else {
                // Manage subscription in LemonSqueezy
                window.open('https://specifysai.lemonsqueezy.com/customer', '_blank');
            }
        };

        window.cancelSubscription = function() {
            const status = document.getElementById('info-status').textContent.toLowerCase();
            
            if (!confirm('Are you sure you want to cancel your subscription? You will keep Pro access until the end of your current billing period.')) {
                return;
            }

            // Open LemonSqueezy customer portal for cancellation
            window.open('https://specifysai.lemonsqueezy.com/customer', '_blank');
            alert('Please use the LemonSqueezy customer portal to cancel your subscription. You will maintain Pro access until your current billing period ends.');
        };

    </script>

    </main>
    
    <!-- Footer -->
    <!-- Footer -->
<footer>
  <div class="footer-content">
    <div class="footer-links">
      <a href="/pages/how.html" aria-label="Learn how specifys.ai works">How It Works</a>
      <a href="/pages/about.html" aria-label="Learn more about specifys.ai">About Us</a>
      <a href="/blog/" aria-label="Visit our blog">Blog</a>
      <a href="/tools/map/vibe-coding-tools-map.html" aria-label="Explore Vibe Coding Tools Map">Vibe Coding Tools Map</a>
      <a href="/pages/ToolPicker.html" aria-label="Use our Tool Finder">Tool Finder</a>
    </div>
    <span class="footer-divider">|</span>
    <div class="footer-social">
      <a href="https://www.linkedin.com/company/specifys-ai/" target="_blank" aria-label="Follow us on LinkedIn"><i class="fab fa-linkedin-in"></i></a>
      <a href="https://www.facebook.com/profile.php?id=61576402600129&locale=he_IL" target="_blank" aria-label="Follow us on Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="mailto:specifysai@gmail.com" aria-label="Send us an email"><i class="fas fa-envelope"></i></a>
      <a href="https://www.producthunt.com/products/specifys-ai" target="_blank" aria-label="Check us out on Product Hunt"><i class="fab fa-product-hunt"></i></a>
    </div>
  </div>
  <div class="footer-copyright">
    Â© 2025 specifys.ai. All rights reserved. <span class="footer-version">v1.2.4</span>
  </div>
</footer>

    
    <!-- Scroll to top button -->
<button class="icon-btn scroll-to-top" id="scrollToTop" aria-label="Scroll">
  <i class="fas fa-arrow-up"></i>
</button>

<script>
  // Scroll button functionality
  document.addEventListener('DOMContentLoaded', function() {
    const scrollBtn = document.getElementById('scrollToTop');
    
    if (scrollBtn) {
      // Handle click - scroll to top or bottom based on current state
      scrollBtn.addEventListener("click", () => {
        if (window.scrollY > 300) {
          // If scrolled down, go to top
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          // If at top, scroll to bottom
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        }
      });
      
      // Rotate button based on scroll position
      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) {
          scrollBtn.classList.add("scrolled-down");
          scrollBtn.setAttribute("aria-label", "Scroll to top");
        } else {
          scrollBtn.classList.remove("scrolled-down");
          scrollBtn.setAttribute("aria-label", "Scroll to bottom");
        }
      });
    }
  });
</script>


    
    <!-- Firebase SDK & Auth -->
    
    
    <!-- Extra JavaScript -->
    
    
</body>
</html>
