<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#000000">
    <title>Specification Viewer - Specifys.ai (v2.0 - Optimized)</title>
    <meta name="description" content="Interactive specification viewer with approval workflow">
    <meta name="keywords" content="AI development tools, app specification generator, no-code platform, AI-powered planning, vibe coding, AI app builder, specification generator, market research tool, app planning tool, development tools, AI tools">
    <meta name="author" content="Specifys.ai">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    
    <!-- Content Security Policy - Removed to fix Google Analytics/Ads issues -->
    
    <!-- Canonical URL -->
    
    <link rel="canonical" href="https://specifys-ai.com/pages/spec-viewer.html">
    
    
    <!-- Open Graph -->
    <meta property="og:site_name" content="Specifys.ai">
    <meta property="og:title" content="Specification Viewer">
    <meta property="og:description" content="Interactive specification viewer with approval workflow">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://specifys-ai.com/pages/spec-viewer.html">
    <meta property="og:image" content="https://specifys-ai.com/assets/images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="en_US">
    
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@specifysai">
    <meta name="twitter:creator" content="@specifysai">
    <meta name="twitter:title" content="Specification Viewer">
    <meta name="twitter:description" content="Interactive specification viewer with approval workflow">
    <meta name="twitter:image" content="https://specifys-ai.com/assets/images/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/pages/spec-viewer.css">
    
    
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS Monitoring Script -->
    <script src="/assets/js/css-monitor.js"></script>
    
    <!-- Custom Icon Styles -->
    <style>
      /* Orange icons for generated tabs */
      .tab-button.generated .fa {
        color: #FF6B35 !important;
      }
      
      /* Locked edit button styles for non-PRO users */
      .btn.locked {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
      }
      
      .btn.locked:hover {
        opacity: 0.6;
      }
      
      .pro-badge {
        font-size: 1em;
        color: white;
        font-weight: 600;
        margin-left: 2px;
      }
      
      .btn.locked .fa-lock {
        margin-right: 4px;
      }
      
      /* Preview buttons styling */
      button[onclick*="openVisualizer"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3) !important;
      }
      
      button[onclick*="openVisualizer"]:active {
        transform: translateY(0);
      }
      
      /* Hide Mermaid error logo/footer - target specific error elements only */
      svg .mermaid-error,
      svg[aria-describedby*="error"],
      svg + div[class*="error"],
      .mermaid-error-message {
        display: none !important;
      }
    </style>
    
    <script>
      // Font Awesome Classic Regular Loaded
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Mermaid for diagrams (used in demo, spec, research pages) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    
    <!-- Marked for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RWBT69JCM7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-RWBT69JCM7');
</script>

<!-- Analytics functions are available via includes/analytics-events.html -->

<!-- Structured Data (JSON-LD) for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "name": "Specifys.ai",
      "url": "https://specifys-ai.com",
      "logo": "https://specifys-ai.com/favicon.ico",
      "description": "AI-powered app planning and specification generation platform",
      "sameAs": [
        "https://www.linkedin.com/company/specifys-ai/"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "email": "specifysai@gmail.com",
        "contactType": "Customer Service"
      }
    },
    {
      "@type": "WebSite",
      "name": "Specifys.ai",
      "url": "https://specifys-ai.com",
      "description": "Plan your app smarter with AI-driven insights and tools",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://specifys-ai.com/pages/ToolPicker.html?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "SoftwareApplication",
      "name": "Specifys.ai",
      "applicationCategory": "DevelopmentApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "250"
      },
      "description": "AI-powered app planning platform with specification generator, market research tools, and vibe coding tools map"
    }
  ]
}
</script>


</head>


<body>
    <!-- Header -->
    <!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Header -->
<header class="thematic-header" role="banner">
    <div class="header-center">
        <div class="logo">
            <a href="/" aria-label="Specifys.ai homepage">
                <span class="logo-text">Specifys<span class="logo-dot">.</span>AI</span>
            </a>
        </div>
    </div>
    <div class="header-right">
        <div class="credits-display" id="credits-display" style="display: none;">
            <div class="credits-container">
                <i class="fa-solid fa-file-lines"></i>
                <span id="credits-text">0</span>
            </div>
        </div>
        <div class="auth-buttons" id="auth-buttons">
            <!-- Will be populated by auth system -->
        </div>
    </div>
</header>



    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
    
    <!-- Page Introduction Section -->
    <div class="page-intro-section">
        <h1 class="page-title">Project Specifications</h1>
        <p class="page-description">
            Comprehensive specifications generated by AI to guide your development process. 
            Review, edit, and approve each section to build a complete project blueprint.
        </p>
    </div>
    
<div class="container">
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('overview')" id="overviewTab">
            <i class="fa fa-book"></i> Overview
        </button>
        <button class="tab-button" onclick="showTab('technical')" id="technicalTab" disabled>
            <i class="fa fa-cog"></i> Technical
        </button>
        <button class="tab-button" onclick="showTab('market')" id="marketTab" disabled>
            <i class="fa fa-bar-chart"></i> Market Research
        </button>
        <button class="tab-button" onclick="showTab('design')" id="designTab" disabled>
            <i class="fa fa-paint-brush"></i> Design & Branding
        </button>
        <button class="tab-button" onclick="showTab('diagrams')" id="diagramsTab" disabled>
            <i class="fa fa-sitemap"></i> Diagrams
        </button>
        <button class="tab-button" onclick="showTab('chat')" id="chatTab" disabled>
            <i class="fa fa-comments"></i> AI Chat
        </button>
        <button class="tab-button" onclick="showTab('raw')" id="rawTab" style="display: none;">
            <i class="fa fa-code"></i> Raw Data
        </button>
    </div>

    <div class="content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading specification...</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <h3><i class="fa fa-times-circle"></i> Error</h3>
            <p id="error-message"></p>
            <button onclick="retryLoad()" class="btn btn-primary">Retry</button>
        </div>
        
        <div id="content" style="display: none;">
            <!-- Approval Actions Container -->
            <div id="approval-container" class="approval-container">
                <div class="approval-message">
                    <i class="fa fa-info-circle"></i>
                    <span>Please review the Overview specification below. You can edit it if needed (PRO users only), then approve to generate Technical and Market specifications.</span>
                </div>
                <div class="approval-actions">
                    <button id="editBtn" class="btn btn-secondary" onclick="toggleEditMode()">
                        <i class="fa fa-pencil"></i> Edit
                    </button>
                    <button id="approveBtn" class="btn btn-success" onclick="approveOverview()">
                        <i class="fa fa-check"></i> Approve Overview
                    </button>
                </div>
            </div>
            
            <div id="overview-content" class="tab-content">
                <div class="content-header">
                    <h2><i class="fa fa-book"></i> Application Overview</h2>
                </div>
                <div id="overview-data" class="content-body"></div>
            </div>
            
            <div id="technical-content" class="tab-content" style="display: none;">
                <div class="content-header">
                <h2><i class="fa fa-cog"></i> Technical Specification</h2>
                    <button id="retryTechnicalBtn" class="btn btn-secondary retry-btn" onclick="retryTechnical()" style="display: none;">
                        <i class="fa fa-refresh"></i> Retry
                    </button>
                </div>
                <div id="technical-data" class="content-body"></div>
            </div>
            
            <div id="market-content" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h2><i class="fa fa-bar-chart"></i> Market Research</h2>
                    <button id="retryMarketBtn" class="btn btn-secondary retry-btn" onclick="retryMarket()" style="display: none;">
                        <i class="fa fa-refresh"></i> Retry
                    </button>
                </div>
                <div id="market-data" class="content-body"></div>
            </div>
            
            <div id="design-content" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h2><i class="fa fa-paint-brush"></i> Design & Branding</h2>
                    <button id="retryDesignBtn" class="btn btn-secondary retry-btn" onclick="retryDesign()" style="display: none;">
                        <i class="fa fa-refresh"></i> Retry
                    </button>
                </div>
                <div id="design-data" class="content-body">
                    <div class="locked-tab-message">
                        <h3><i class="fa fa-lock"></i> Design & Branding</h3>
                        <p>Please approve the Overview and generate Technical & Market specifications first to create design guidelines.</p>
                    </div>
                </div>
            </div>
            
            <div id="diagrams-content" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h2><i class="fa fa-bar-chart"></i> Diagrams</h2>
                    <button id="generateDiagramsBtn" class="btn btn-primary" onclick="generateDiagrams()" style="display: none;">
                        Generate Diagrams
                    </button>
                </div>
                <div id="diagrams-data" class="content-body">
                    <div class="locked-tab-message">
                        <h3><i class="fa fa-lock"></i> Diagrams</h3>
                        <p>Please approve the Overview and generate Technical & Market specifications first to create visual diagrams.</p>
                    </div>
                </div>
            </div>
            
            <div id="chat-content" class="tab-content" style="display: none;">
                <div class="chat-container" style="height: 600px; display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <div class="chat-header" style="padding: 15px 20px; background: white; color: #333; border-bottom: 2px solid #ff6b35; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #333;"><i class="fa fa-comments" style="color: #ff6b35;"></i> AI Chat Assistant</h2>
                            <p class="chat-subtitle" style="margin: 5px 0 0 0; color: #666; font-size: 13px;">Ask questions about your specification</p>
                        </div>
                        <button id="reset-chat-btn" class="btn btn-secondary" onclick="resetChat()" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ccc; color: #666; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                            <i class="fa fa-refresh" style="color: #666;"></i> Reset Chat
                        </button>
                    </div>
                    
                    <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9;">
                        <div class="chat-welcome" style="text-align: center; padding: 30px 20px; color: #666;">
                            <i class="fa fa-comments" style="font-size: 48px; color: #ff6b35; margin-bottom: 15px; display: block;"></i>
                            <h3 style="margin: 0 0 10px 0; color: #333;">Welcome to AI Chat</h3>
                            <p style="margin: 0; color: #666;">Ask me anything about your specification. I have access to all the details and can help clarify, explain, or suggest improvements.</p>
                        </div>
                    </div>
                    
                    <div class="chat-input-container" style="padding: 15px 20px; border-top: 1px solid #e0e0e0; background: white; display: flex; gap: 10px;">
                        <textarea 
                            id="chat-input" 
                            class="chat-input" 
                            placeholder="Ask a question about your spec..."
                            rows="2"
                            style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; font-size: 14px;"
                        ></textarea>
                        <button id="send-chat-btn" class="btn btn-primary chat-send-btn" style="padding: 10px 20px; background: #ff6b35; border: none; color: white; border-radius: 4px; white-space: nowrap; cursor: pointer;">
                            <i class="fa fa-paper-plane" style="color: white !important;"></i> Send
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="raw-content" class="tab-content" style="display: none;">
                <div class="content-header">
                <h2><i class="fa fa-search"></i> Raw JSON Data</h2>
                </div>
                <div class="content-body">
                    <div class="raw-sections">
                        <div class="raw-section">
                            <h3><i class="fa fa-book"></i> Overview Raw</h3>
                            <pre id="raw-overview" class="raw-display"></pre>
                        </div>
                        
                        <div class="raw-section">
                            <h3><i class="fa fa-cog"></i> Technical Raw</h3>
                            <pre id="raw-technical" class="raw-display"></pre>
                        </div>
                        
                        <div class="raw-section">
                            <h3><i class="fa fa-chart-line"></i> Market Raw</h3>
                            <pre id="raw-market" class="raw-display"></pre>
                        </div>
                        
                        <div class="raw-section">
                            <h3><i class="fa fa-palette"></i> Design Raw</h3>
                            <pre id="raw-design" class="raw-display"></pre>
                        </div>
                        
                        <div class="raw-section">
                            <h3><i class="fa fa-sitemap"></i> Diagrams Raw</h3>
                            <pre id="raw-diagrams" class="raw-display"></pre>
                        </div>
                        
                        <div class="raw-section">
                            <h3><i class="fa fa-database"></i> Complete Raw</h3>
                            <pre id="raw-complete" class="raw-display"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Modal for Diagrams -->
<div id="fullscreenModal" class="fullscreen-modal" style="display: none;">
    <div class="fullscreen-header">
        <h3 id="fullscreenTitle"></h3>
        <div class="fullscreen-controls">
            <button onclick="zoomIn()" class="btn-icon" title="Zoom In">
                <i class="fa fa-plus"></i>
            </button>
            <button onclick="zoomOut()" class="btn-icon" title="Zoom Out">
                <i class="fa fa-minus"></i>
            </button>
            <button onclick="resetZoom()" class="btn-icon" title="Reset Zoom">
                <i class="fa fa-home"></i>
            </button>
            <button onclick="closeFullscreen()" class="btn-icon" title="Close">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>
    <div class="fullscreen-content" id="fullscreenContent"></div>
</div>

<!-- Registration Modal for Unauthenticated Users -->
<div id="registrationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa fa-key"></i> Authentication Required</h3>
            <span class="close" onclick="closeRegistrationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>To save and manage your specifications, please sign in or create an account.</p>
            <div class="auth-buttons">
                <a href="/pages/auth.html" class="btn btn-primary">
                    Sign In / Register
                </a>
                <button onclick="continueAsGuest()" class="btn btn-secondary">
                    Continue as Guest
                </button>
            </div>
            <p class="guest-note">
                <small>As a guest, your specifications will only be saved locally and may be lost if you clear your browser data.</small>
            </p>
        </div>
    </div>
</div>

<script src="/tools/prompts.js"></script>
<script src="/assets/js/mermaid.js"></script>
<script>
let currentSpecData = null;
let currentTab = 'overview';
let isLoading = false;

// OpenAI Storage helper function
async function triggerOpenAIUploadForSpec(specId) {
    try {
        const user = firebase.auth().currentUser;
        if (!user) {

            return;
        }
        
        const token = await user.getIdToken();
        const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/specs/${specId}/upload-to-openai`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        

    } catch (error) {

    }
}

// Diagrams variables
let diagramsData = [];
let currentZoom = 1;
let currentPanX = 0;
let currentPanY = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;

// Get spec ID from URL if provided
const urlParams = new URLSearchParams(window.location.search);
const urlSpecId = urlParams.get('id');



document.addEventListener('DOMContentLoaded', function() {
    // Initialize Mermaid with custom theme
    try {
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({
                theme: 'base',
                themeVariables: {
                    primaryColor: '#FF6B35',
                    primaryTextColor: '#333333',
                    primaryBorderColor: '#FF6B35',
                    lineColor: '#333333',
                    secondaryColor: '#f5f5f5',
                    tertiaryColor: '#ffffff',
                    background: '#ffffff',
                    mainBkg: '#ffffff',
                    secondBkg: '#f5f5f5',
                    tertiaryBkg: '#ffffff'
                }
            });

        }
    } catch (error) {

    }
    
    // Initialize Firebase auth state listener
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            // Load spec after user authentication
            if (urlSpecId) {
                loadSpec(urlSpecId);
            } else {
                showError('No specification ID provided in URL');
            }
            
            // Update edit button based on PRO access
            updateEditButton();
        } else {
            showError('User must be authenticated to view specifications');
        }
        
        // Check if we need to show registration modal
        checkAuthenticationStatus(user);
        
        // Update storage status when auth state changes
        if (currentSpecData) {
            updateStorageStatus();
        }
    });
    
    // Load spec will be triggered after user authentication
    

});

// Check authentication status and show modal if needed
function checkAuthenticationStatus(user) {
    const showModal = localStorage.getItem('showRegistrationModal');
    
    if (!user && showModal === 'true') {
        showRegistrationModal();
        localStorage.removeItem('showRegistrationModal');
    }
}

// Show registration modal
function showRegistrationModal() {
    const modal = document.getElementById('registrationModal');
    if (modal) {
        modal.style.display = 'flex';

    }
}

// Close registration modal
function closeRegistrationModal() {
    const modal = document.getElementById('registrationModal');
    if (modal) {
        modal.style.display = 'none';

    }
}

// Continue as guest
function continueAsGuest() {
    closeRegistrationModal();
    
    // Show a notification about guest mode
    showNotification('You are now in guest mode. Your specifications will only be saved locally.', 'info');
}

// Show notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">
                ${type === 'success' ? '<i class="fa fa-check-circle"></i>' : 
                  type === 'error' ? '<i class="fa fa-exclamation-circle"></i>' : 
                  '<i class="fa fa-info-circle"></i>'}
            </div>
            <div class="notification-text">
                <span class="notification-message">${message}</span>
            </div>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                <i class="fa fa-times"></i>
            </button>
        </div>
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed !important;
        bottom: 150px !important;
        left: 50% !important;
        transform: translateX(-50%) translateY(100px) !important;
        background: #FF6B35 !important;
        backdrop-filter: blur(10px) !important;
        color: #ffffff !important;
        padding: 0 !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
        z-index: 10000 !important;
        font-family: 'Inter', sans-serif !important;
        font-size: 14px !important;
        max-width: 700px !important;
        width: 95% !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        animation: slideUpIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
        overflow: hidden !important;
    `;
    
    // Add CSS for notification content - update or create
    let style = document.querySelector('#notification-styles');
    if (!style) {
        style = document.createElement('style');
        style.id = 'notification-styles';
        document.head.appendChild(style);
    }
    
    style.textContent = `
        .notification {
            background: #FF6B35 !important;
            color: #ffffff !important;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            gap: 12px;
        }
        
        .notification-icon {
            font-size: 18px;
            flex-shrink: 0;
            color: #ffffff !important;
        }
        
        .notification-text {
            flex: 1;
            line-height: 1.4;
        }
        
        .notification-message {
            font-weight: 500;
            color: #ffffff !important;
        }
        
        .notification-close {
            background: none !important;
            border: none !important;
            color: #ffffff !important;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #ffffff !important;
        }
        
        @keyframes slideUpIn {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUpOut {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
        }
        
        .notification.notification-removing {
            animation: slideUpOut 0.3s ease forwards;
        }
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto remove after 6 seconds with smooth animation
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('notification-removing');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 6000);
}

async function loadSpec(specId) {
    try {
        showLoading();
        


        
        if (!specId) {
            throw new Error('No specification ID provided');
        }
        
        
        // Load from Firebase (user is always authenticated)
        const user = firebase.auth().currentUser;
        if (!user) {
            throw new Error('User must be authenticated to view specifications');
        }
        
        const doc = await firebase.firestore().collection('specs').doc(specId).get();
        if (!doc.exists) {
            throw new Error('Specification not found');
        }
        
        const specData = doc.data();
        
        // Check if user has permission to view this spec
        // Allow if: spec is public OR user owns it OR user is admin
        const adminEmails = ['specifysai@gmail.com', 'admin@specifys.ai', 'shalom@specifys.ai'];
        const isPublic = specData.isPublic === true;
        const isOwner = specData.userId === user.uid;
        const isAdmin = adminEmails.includes(user.email);
        
        if (!isPublic && !isOwner && !isAdmin) {

            showError('You do not have permission to view this specification.');
            return;
        }
        
        currentSpecData = { id: doc.id, ...specData };
        
        const technicalPreview = specData.technical ? specData.technical.substring(0, 200) + (specData.technical.length > 200 ? '...' : '') : 'null';
        const marketPreview = specData.market ? specData.market.substring(0, 200) + (specData.market.length > 200 ? '...' : '') : 'null';
        const designPreview = specData.design ? specData.design.substring(0, 200) + (specData.design.length > 200 ? '...' : '') : 'null';
        











        

        displaySpec(currentSpecData);
        
    } catch (error) {

        showError(`Error loading spec: ${error.message}`);
        showNotification('Failed to load specification. Please try again.', 'error');
    }
}

function displaySpec(data) {



    
    const technicalPreview = data.technical ? data.technical.substring(0, 200) + (data.technical.length > 200 ? '...' : '') : 'null';
    const marketPreview = data.market ? data.market.substring(0, 200) + (data.market.length > 200 ? '...' : '') : 'null';
    const designPreview = data.design ? data.design.substring(0, 200) + (data.design.length > 200 ? '...' : '') : 'null';
    



    
    // Reset chat state when switching to a different spec
    chatThreadId = null;
    chatAssistantId = null;
    chatInitialized = false;
    chatHistory = [];
    
    // Clear chat UI when switching specs
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        messagesContainer.innerHTML = `
            <div class="chat-welcome" style="text-align: center; padding: 30px 20px; color: #666;">
                <i class="fa fa-comments" style="font-size: 48px; color: #ff6b35; margin-bottom: 15px; display: block;"></i>
                <h3 style="margin: 0 0 10px 0; color: #333;">Welcome to AI Chat</h3>
                <p style="margin: 0; color: #666;">Ask me anything about your specification. I have access to all the details and can help clarify, explain, or suggest improvements.</p>
            </div>
        `;
    }
    
    hideLoading();
    hideError();
    document.getElementById('content').style.display = 'block';
    
    // Extract app name from title (first word)
    const appName = data.title ? data.title.split(' ')[0] : '';
    const fullTitle = appName ? `App Specification - ${appName}` : 'App Specification';
    
    // Update page title in browser tab
    document.title = `${fullTitle} - Specifys.ai`;
    
    // Update page title if element exists
    const specTitleElement = document.getElementById('spec-title');
    if (specTitleElement) {
        specTitleElement.textContent = fullTitle;
    }
    
        // Update status indicators
        updateStatus('overview', data.status?.overview || 'ready');
        updateStatus('technical', data.status?.technical || 'pending');
        updateStatus('market', data.status?.market || 'pending');
        
        // Update tab statuses
        setTabStatus('overviewTab', data.status?.overview === 'ready' ? 'success' : 'pending');
        setTabStatus('technicalTab', data.status?.technical === 'ready' ? 'success' : 'pending');
        setTabStatus('marketTab', data.status?.market === 'ready' ? 'success' : 'pending');
    updateStatus('design', data.status?.design || 'pending');
    updateDiagramsStatus(data.diagrams?.generated ? 'ready' : 'pending');
    updateStorageStatus(); // Add storage status update
    
    // Display content for each tab

    displayOverview(data.overview);
    displayTechnical(data.technical);
    displayMarket(data.market);
    displayDesign(data.design);
    displayDiagramsFromData(data);
    displayRaw(data);
    
    // Handle approval state
    if (data.overviewApproved) {
        // Enable AI Chat immediately when overview is approved
        enableChatTabOnly();
        
        // Only enable other tabs if their specs are ready
        if (data.status?.technical === 'ready') {
            document.getElementById('technicalTab').disabled = false;
        }
        if (data.status?.market === 'ready') {
            document.getElementById('marketTab').disabled = false;
        }
        if (data.status?.design === 'ready') {
            document.getElementById('designTab').disabled = false;
        }
        
        // Enable diagrams only if both technical and market are ready
        if (data.status?.technical === 'ready' && data.status?.market === 'ready') {
            document.getElementById('diagramsTab').disabled = false;
            // Show Generate only if no diagrams yet
            const hasDiagrams = !!(data.diagrams && Array.isArray(data.diagrams.diagrams) && data.diagrams.diagrams.length > 0);
            document.getElementById('generateDiagramsBtn').style.display = hasDiagrams ? 'none' : 'inline-block';
        }
        
        hideApproveButton();
    } else {
        showApproveButton();
        disableTechnicalTabs();
        // Show approval container when overview is not approved
        const approvalContainer = document.getElementById('approval-container');
        if (approvalContainer) {
            approvalContainer.style.display = 'flex';
        }
    }
    
    // Show overview tab by default
    showTab('overview');
    
    // Spec is already saved to Firebase from processing page
}

function displayOverview(overview) {
    const container = document.getElementById('overview-data');
    
    // Debug logging

    
    if (!overview) {
        container.innerHTML = '<p class="text-muted">Overview not available...</p>';
        return;
    }
    
    // Store original overview for editing
    window.originalOverview = overview;
    
    // Format and display
    const formattedContent = formatTextContent(overview);
    container.innerHTML = formattedContent;
    
    // Update raw data
    document.getElementById('raw-overview').textContent = JSON.stringify(overview, null, 2);
    
    // Mark tab as generated with orange icon
    const overviewTab = document.getElementById('overviewTab');
    if (overviewTab) {
        overviewTab.classList.add('generated');
    }
    
    // Update edit button based on PRO access
    updateEditButton();
}

function displayTechnical(technical) {
    
    const container = document.getElementById('technical-data');
    
    if (!technical) {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-lock"></i> Technical Specification</h3><p>Please approve the Overview first to generate the technical specification.</p></div>';
        return;
    }
    
    if (technical === 'error') {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-exclamation-triangle"></i> Error Generating Technical Specification</h3><p>There was an error generating the technical specification. Please try again.</p></div>';
        document.getElementById('retryTechnicalBtn').style.display = 'inline-block';
        return;
    }
    
    // Format the technical content
    const formattedContent = formatTextContent(technical);
    container.innerHTML = formattedContent;
    
    // Update raw data
    document.getElementById('raw-technical').textContent = JSON.stringify(technical, null, 2);
    
    // Mark tab as generated with orange icon
    const technicalTab = document.getElementById('technicalTab');
    if (technicalTab) {
        technicalTab.classList.add('generated');
    }
}

function displayMarket(market) {
    const container = document.getElementById('market-data');
    
    if (!market) {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-lock"></i> Market Research</h3><p>Please approve the Overview first to generate the market research.</p></div>';
        return;
    }
    
    if (market === 'error') {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-exclamation-triangle"></i> Error Generating Market Research</h3><p>There was an error generating the market research. Please try again.</p></div>';
        document.getElementById('retryMarketBtn').style.display = 'inline-block';
        return;
    }
    
    // Format the market content
    const formattedContent = formatTextContent(market);
    container.innerHTML = formattedContent;
    
    // Update raw data
    document.getElementById('raw-market').textContent = JSON.stringify(market, null, 2);
    
    // Mark tab as generated with orange icon
    const marketTab = document.getElementById('marketTab');
    if (marketTab) {
        marketTab.classList.add('generated');
    }
}

function displayDesign(design) {
    const container = document.getElementById('design-data');
    
    if (!design) {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-lock"></i> Design & Branding</h3><p>Please approve the Overview first to generate the design specification.</p></div>';
        return;
    }
    
    if (design === 'error') {
        container.innerHTML = '<div class="locked-tab-message"><h3><i class="fa fa-exclamation-triangle"></i> Error Generating Design Specification</h3><p>There was an error generating the design specification. Please try again.</p></div>';
        document.getElementById('retryDesignBtn').style.display = 'inline-block';
        return;
    }
    
    // Parse design data for colors and typography (for preview buttons)
    const designData = parseDesignData(design);

    // Format the remaining design content (which includes Visual Style Guide with Color Palette)
    const formattedContent = formatTextContent(design);

    // Build Preview buttons HTML to insert within Visual Style Guide
    let previewButtonsHTML = '';
    if (Object.keys(designData.colors).length > 0) {
        previewButtonsHTML = '<div style="text-align: center; margin: 20px 0;">';
        previewButtonsHTML += '<div style="display: inline-flex; gap: 15px; flex-wrap: wrap; justify-content: center;">';
        previewButtonsHTML += '<button class="btn btn-primary" onclick="openVisualizer(\'mobile\')" style="padding: 12px 24px; background: #FF6B35; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);">';
        previewButtonsHTML += '<i class="fa fa-mobile" style="font-size: 18px; color: white;"></i>';
        previewButtonsHTML += '<span>Mobile Preview</span>';
        previewButtonsHTML += '</button>';
        previewButtonsHTML += '<button class="btn btn-primary" onclick="openVisualizer(\'web\')" style="padding: 12px 24px; background: #FF6B35; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);">';
        previewButtonsHTML += '<i class="fa fa-desktop" style="font-size: 18px; color: white;"></i>';
        previewButtonsHTML += '<span>Web Preview</span>';
        previewButtonsHTML += '</button>';
        previewButtonsHTML += '</div>';
        previewButtonsHTML += '</div>';
    }

    // Add preview buttons after Visual Style Guide section
    let finalContent = formattedContent;
    if (previewButtonsHTML) {
        finalContent += previewButtonsHTML;
    }

    // Set the final content
    container.innerHTML = finalContent;
    
    // Update raw data
    document.getElementById('raw-design').textContent = JSON.stringify(design, null, 2);
    
    // Mark tab as generated with orange icon
    const designTab = document.getElementById('designTab');
    if (designTab) {
        designTab.classList.add('generated');
    }
}

function parseDesignData(designContent) {
    const result = {
        colors: {},
        typography: {},
        colorHarmony: '',
        colorReasoning: ''
    };
    

    
    try {
        let content = designContent;
        
        // Try to parse as JSON first
        let jsonData;
        try {
            jsonData = JSON.parse(designContent);

            
            // FIRST TRY: jsonData is already the design object (from generateDesignSpec)
            if (jsonData.visualStyleGuide) {
                if (jsonData.visualStyleGuide.colorHarmony) {
                    result.colorHarmony = jsonData.visualStyleGuide.colorHarmony;
                }
                if (jsonData.visualStyleGuide.colorReasoning) {
                    result.colorReasoning = jsonData.visualStyleGuide.colorReasoning;
                }
                // Extract colors from JSON
                if (jsonData.visualStyleGuide.colors) {
                    const colorsObj = jsonData.visualStyleGuide.colors;
                    Object.entries(colorsObj).forEach(([key, value]) => {
                        const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
                        result.colors[capitalizedKey] = value;
                    });
                }
                // Extract typography from JSON
                if (jsonData.visualStyleGuide.typography) {
                    const typographyObj = jsonData.visualStyleGuide.typography;
                    Object.entries(typographyObj).forEach(([key, value]) => {
                        const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
                        result.typography[capitalizedKey] = value;
                    });
                }

                return result;
            }
            // FALLBACK: jsonData has nested structure jsonData.design.visualStyleGuide
            else if (jsonData.design && jsonData.design.visualStyleGuide) {
                if (jsonData.design.visualStyleGuide.colorHarmony) {
                    result.colorHarmony = jsonData.design.visualStyleGuide.colorHarmony;
                }
                if (jsonData.design.visualStyleGuide.colorReasoning) {
                    result.colorReasoning = jsonData.design.visualStyleGuide.colorReasoning;
                }
                // Extract colors from JSON
                if (jsonData.design.visualStyleGuide.colors) {
                    const colorsObj = jsonData.design.visualStyleGuide.colors;
                    Object.entries(colorsObj).forEach(([key, value]) => {
                        const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
                        result.colors[capitalizedKey] = value;
                    });
                }
                // Extract typography from JSON
                if (jsonData.design.visualStyleGuide.typography) {
                    const typographyObj = jsonData.design.visualStyleGuide.typography;
                    Object.entries(typographyObj).forEach(([key, value]) => {
                        const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
                        result.typography[capitalizedKey] = value;
                    });
                }

                return result;
            }
        } catch (e) {

            // Not JSON, continue with text parsing
        }
        
        if (typeof designContent === 'string') {
            content = designContent;
        }
        
        // Extract colors using multiple patterns
        const colorPatterns = [
            /Colors?:\s*([\s\S]*?)(?=Typography|$)/i,
            /Color\s+Palette:\s*([\s\S]*?)(?=Typography|$)/i,
            /Primary:\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/i,
            /Secondary:\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/i,
            /Accent:\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/i,
            /Background:\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/i,
            /Text:\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/i
        ];
        
        colorPatterns.forEach(pattern => {
            const matches = content.match(pattern);
            if (matches) {
                if (pattern.source.includes('Colors?:') || pattern.source.includes('Color\\s+Palette:')) {
                    const colorText = matches[1];
                    const colorLines = colorText.split('\n');
                    
                    colorLines.forEach(line => {
                        const match = line.match(/^\s*([^:]+):\s*(#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3})/);
                        if (match) {
                            const name = match[1].trim();
                            const code = match[2].trim();
                            result.colors[name] = code;
                        }
                    });
                } else {
                    const match = content.match(pattern);
                    if (match) {
                        const name = pattern.source.match(/([^:]+):/)[1].trim();
                        const code = match[1];
                        result.colors[name] = code;
                    }
                }
            }
        });
        
        // Extract typography using multiple patterns
        const typographyPatterns = [
            /Typography:\s*([\s\S]*?)(?=\n\n|$)/i,
            /Font\s+Family:\s*([\s\S]*?)(?=\n\n|$)/i,
            /Headings?:\s*([^,\n]+(?:,\s*[^,\n]+)*)/i,
            /Body:\s*([^,\n]+(?:,\s*[^,\n]+)*)/i,
            /Captions?:\s*([^,\n]+(?:,\s*[^,\n]+)*)/i
        ];
        
        typographyPatterns.forEach(pattern => {
            const matches = content.match(pattern);
            if (matches) {
                if (pattern.source.includes('Typography:') || pattern.source.includes('Font\\s+Family:')) {
                    const typographyText = matches[1];
                    const typographyLines = typographyText.split('\n');
                    
                    typographyLines.forEach(line => {
                        const match = line.match(/^\s*([^:]+):\s*(.+)$/);
                        if (match) {
                            const name = match[1].trim();
                            const value = match[2].trim();
                            result.typography[name] = value;
                        }
                    });
                } else {
                    const match = content.match(pattern);
                    if (match) {
                        const name = pattern.source.match(/([^:]+):/)[1].trim();
                        const value = match[1].trim();
                        result.typography[name] = value;
                    }
                }
            }
        });
        
        // Fallback defaults if no colors/typography found
        if (Object.keys(result.colors).length === 0) {

            result.colors = {
                'Primary': '#4CAF50',
                'Secondary': '#FF9800',
                'Accent': '#2196F3',
                'Background': '#FFFFFF',
                'Text': '#212121'
            };
        } else {

        }
        
        if (Object.keys(result.typography).length === 0) {
            result.typography = {
                'Headings': 'Roboto, Bold, 24px',
                'Body': 'Roboto, Regular, 16px',
                'Captions': 'Roboto, Italic, 12px'
            };
        }
        
    } catch (error) {

        // Use fallback defaults
        result.colors = {
            'Primary': '#4CAF50',
            'Secondary': '#FF9800',
            'Accent': '#2196F3',
            'Background': '#FFFFFF',
            'Text': '#212121'
        };
        result.typography = {
            'Headings': 'Roboto, Bold, 24px',
            'Body': 'Roboto, Regular, 16px',
            'Captions': 'Roboto, Italic, 12px'
        };
    }
    
    return result;
}

function getTypographyStyle(value) {
    const parts = value.split(',').map(p => p.trim());
    let style = '';
    
    parts.forEach(part => {
        if (part.includes('px')) {
            style += `font-size: ${part}; `;
        } else if (part.toLowerCase() === 'bold') {
            style += 'font-weight: bold; ';
        } else if (part.toLowerCase() === 'italic') {
            style += 'font-style: italic; ';
        } else if (part.toLowerCase() === 'regular') {
            style += 'font-weight: normal; ';
        } else {
            style += `font-family: ${part}; `;
        }
    });
    
    return style;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification(`Copied ${text} to clipboard!`, 'success');
    }).catch(err => {

        showNotification('Failed to copy to clipboard', 'error');
    });
}

function openVisualizer(type) {
    const modal = document.getElementById('color-visualizer-modal');
    const title = document.getElementById('viz-title');
    const mobileTemplate = document.getElementById('mobile-template');
    const webTemplate = document.getElementById('web-template');
    
    // Hide all templates
    mobileTemplate.style.display = 'none';
    webTemplate.style.display = 'none';
    
    if (type === 'mobile') {
        title.textContent = 'Mobile App Preview';
        mobileTemplate.style.display = 'block';
        applyColorsToTemplate('mobile');
    } else {
        title.textContent = 'Web App Preview';
        webTemplate.style.display = 'block';
        applyColorsToTemplate('web');
    }
    
    modal.style.display = 'flex';
}

function applyColorsToTemplate(type) {
    const designData = parseDesignData(currentSpecData.design);
    const colors = designData.colors;
    const typography = designData.typography;
    

    
    const template = type === 'mobile' ? 
        document.getElementById('mobile-template') : 
        document.getElementById('web-template');
    
    // Helper function to get color value case-insensitive
    const getColor = (name) => {
        // Try with capitalized first
        return colors[name] || colors[name.charAt(0).toUpperCase() + name.slice(1)] || 
               colors[name.toLowerCase()] || colors[name.toUpperCase()] ||
               // Fallback based on name
               (name === 'Primary' ? '#4CAF50' : 
                name === 'Secondary' ? '#FF9800' : 
                name === 'Accent' ? '#2196F3' : 
                name === 'Background' ? '#FFFFFF' : '#212121');
    };
    
    // Replace all colors
    template.style.setProperty('--primary-color', getColor('Primary'));
    template.style.setProperty('--secondary-color', getColor('Secondary'));
    template.style.setProperty('--accent-color', getColor('Accent'));
    template.style.setProperty('--background-color', getColor('Background'));
    template.style.setProperty('--text-color', getColor('Text'));
    
    // Replace all fonts
    template.style.setProperty('--heading-font', typography.Headings || 'Roboto, Bold, 24px');
    template.style.setProperty('--body-font', typography.Body || 'Roboto, Regular, 16px');
    template.style.setProperty('--caption-font', typography.Captions || 'Roboto, Italic, 12px');
}

function closeVisualizer() {
    document.getElementById('color-visualizer-modal').style.display = 'none';
}

// Close the modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('color-visualizer-modal');
    if (e.target === modal) {
        closeVisualizer();
    }
});

// Close the modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeVisualizer();
    }
});

function displayRaw(data) {
    // Display individual sections
    document.getElementById('raw-overview').textContent = data.overview ? JSON.stringify(data.overview, null, 2) : 'No overview data available';
    document.getElementById('raw-technical').textContent = data.technical ? JSON.stringify(data.technical, null, 2) : 'No technical data available';
    document.getElementById('raw-market').textContent = data.market ? JSON.stringify(data.market, null, 2) : 'No market data available';
    document.getElementById('raw-design').textContent = data.design ? JSON.stringify(data.design, null, 2) : 'No design data available';
    document.getElementById('raw-diagrams').textContent = data.diagrams ? JSON.stringify(data.diagrams, null, 2) : 'No diagrams data available';
    
    // Display complete data
    document.getElementById('raw-complete').textContent = JSON.stringify(data, null, 2);
}



function displayDiagramsFromData(data) {
    const container = document.getElementById('diagrams-data');
    
    // FIRST CHECK: Overview must be approved
    if (!data.overviewApproved) {
        container.innerHTML = `
            <div class="locked-tab-message">
                <h3><i class="fa fa-lock"></i> Diagrams</h3>
                <p>Please approve the Overview and generate Technical & Market specifications first to create visual diagrams.</p>
            </div>
        `;
        return;
    }
    
    // SECOND CHECK: Technical and Market must be ready
    if (!data.technical || !data.market || 
        data.status?.technical !== 'ready' || 
        data.status?.market !== 'ready') {
        container.innerHTML = `
            <div class="locked-tab-message">
                <h3><i class="fa fa-lock"></i> Diagrams</h3>
                <p>Please generate Technical & Market specifications first to create visual diagrams.</p>
            </div>
        `;
        return;
    }
    
    // THIRD CHECK: Diagrams must be generated and valid
    if (!data.diagrams?.generated || 
        !data.diagrams?.diagrams || 
        !Array.isArray(data.diagrams.diagrams) || 
        data.diagrams.diagrams.length === 0) {
        container.innerHTML = `
            <div class="locked-tab-message">
                <h3><i class="fa fa-bar-chart"></i> Diagrams</h3>
                <p>Click "Generate Diagrams" to create visual representations of your specification.</p>
            </div>
        `;
        return;
    }
    
    // FOURTH CHECK: Validate that diagrams have valid mermaidCode (but keep ALL diagrams)
    const diagramsWithCode = data.diagrams.diagrams.filter(d => 
        d && d.mermaidCode && 
        typeof d.mermaidCode === 'string' && 
        d.mermaidCode.trim().length > 0
    );
    
    if (diagramsWithCode.length === 0) {
        container.innerHTML = `
            <div class="locked-tab-message">
                <h3><i class="fa fa-bar-chart"></i> Diagrams</h3>
                <p>No valid diagrams found. Click "Generate Diagrams" to create visual representations.</p>
            </div>
        `;
        return;
    }
    
    // ALL CHECKS PASSED - Display ALL diagrams (including broken ones)
    // Store ALL diagrams data globally (not just valid ones)
    diagramsData = diagramsWithCode;
    
    // Initialize flags for diagrams that don't have them
    diagramsData.forEach(diagram => {
        if (diagram._autoRepairSent === undefined) {
            diagram._autoRepairSent = false;
        }
    });
    
    // Display ALL diagrams
    displayDiagrams(diagramsData);
    
    // Check for broken diagrams that haven't been sent for auto-repair yet
    // This handles the refresh case - if user refreshes page while diagrams are broken
    autoRepairBrokenDiagrams();
    
    // Update raw data
    document.getElementById('raw-diagrams').textContent = JSON.stringify(data.diagrams, null, 2);
}

function formatTextContent(content) {
    
    if (!content) {
        return '<p>No content available</p>';
    }
    
    // Debug logging

    
    // Check if content is JSON
    let parsedContent;
    try {
        parsedContent = JSON.parse(content);

        return formatJSONContent(parsedContent);
    } catch (error) {

        return formatPlainTextContent(content);
    }
}

function formatJSONContent(jsonData) {
    let html = '';
    
    // Parse JSON strings if they exist
    if (typeof jsonData === 'string') {
        try {
            jsonData = JSON.parse(jsonData);
        } catch (e) {

            return '<div class="error">Failed to parse JSON data</div>';
        }
    }
    
    // Debug logging to understand data structure

    
    // Handle nested overview structure (overview.overview)
    if (jsonData.overview && typeof jsonData.overview === 'object') {

        jsonData = jsonData.overview;
    }
    
    // Handle new Overview structure
    if (jsonData.ideaSummary) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-lightbulb-o"></i> Idea Summary</h3>';
        html += `<p>${jsonData.ideaSummary}</p>`;
        html += '</div>';
    }
    
    // Handle new Target Audience structure
    if (jsonData.targetAudience) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bullseye"></i> Target Audience</h3>';
        
        if (jsonData.targetAudience.ageRange) {
            html += `<p><strong>Age Range:</strong> ${jsonData.targetAudience.ageRange}</p>`;
        }
        
        if (jsonData.targetAudience.sector) {
            html += `<p><strong>Sector:</strong> ${jsonData.targetAudience.sector}</p>`;
        }
        
        if (jsonData.targetAudience.interests && Array.isArray(jsonData.targetAudience.interests)) {
            html += '<h4>Interests:</h4>';
            html += '<ul>';
            jsonData.targetAudience.interests.forEach(interest => {
                html += `<li>${interest}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.targetAudience.needs && Array.isArray(jsonData.targetAudience.needs)) {
            html += '<h4>Needs:</h4>';
            html += '<ul>';
            jsonData.targetAudience.needs.forEach(need => {
                html += `<li>${need}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    }
    
    // Handle new Value Proposition
    if (jsonData.valueProposition) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-diamond"></i> Value Proposition</h3>';
        html += `<p>${jsonData.valueProposition}</p>`;
        html += '</div>';
    }
    
    // Handle new Core Features Overview
    if (jsonData.coreFeaturesOverview && Array.isArray(jsonData.coreFeaturesOverview)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-star"></i> Core Features Overview</h3>';
        html += '<ul>';
        jsonData.coreFeaturesOverview.forEach(feature => {
            html += `<li>${feature}</li>`;
        });
        html += '</ul>';
        html += '</div>';
    }
    
    // Handle new User Journey Summary
    if (jsonData.userJourneySummary) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-road"></i> User Journey Summary</h3>';
        html += `<p>${jsonData.userJourneySummary}</p>`;
        html += '</div>';
    }
    
    // Handle new Problem Statement
    if (jsonData.problemStatement) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-exclamation-triangle"></i> Problem Statement</h3>';
        html += `<p>${jsonData.problemStatement}</p>`;
        html += '</div>';
    }
    
    // Handle new Detailed User Flow
    if (jsonData.detailedUserFlow) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-list-ol"></i> Detailed User Flow</h3>';
        
        if (jsonData.detailedUserFlow.steps && Array.isArray(jsonData.detailedUserFlow.steps)) {
            html += '<h4>Steps:</h4>';
            html += '<ol>';
            jsonData.detailedUserFlow.steps.forEach((step, index) => {
                // Remove "Step X:" prefix if it already exists in the step text
                const cleanedStep = step.replace(/^Step\s+\d+:\s*/i, '').trim();
                html += `<li><strong>Step ${index + 1}:</strong> ${cleanedStep}</li>`;
            });
            html += '</ol>';
        }
        
        if (jsonData.detailedUserFlow.decisionPoints) {
            html += '<h4>Decision Points:</h4>';
            html += `<p>${jsonData.detailedUserFlow.decisionPoints}</p>`;
        }
        
        if (jsonData.detailedUserFlow.errorHandling) {
            html += '<h4>Error Handling:</h4>';
            html += `<p>${jsonData.detailedUserFlow.errorHandling}</p>`;
        }
        
        if (jsonData.detailedUserFlow.confirmations) {
            html += '<h4>Confirmations:</h4>';
            html += `<p>${jsonData.detailedUserFlow.confirmations}</p>`;
        }
        
        if (jsonData.detailedUserFlow.feedbackLoops) {
            html += '<h4>Feedback Loops:</h4>';
            html += `<p>${jsonData.detailedUserFlow.feedbackLoops}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Screen Descriptions
    if (jsonData.screenDescriptions) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-desktop"></i> Screen Descriptions</h3>';
        
        if (jsonData.screenDescriptions.screens && Array.isArray(jsonData.screenDescriptions.screens)) {
            html += '<h4>Screens (' + jsonData.screenDescriptions.screens.length + ' total):</h4>';
            jsonData.screenDescriptions.screens.forEach((screen, index) => {
                if (typeof screen === 'string') {
                    html += `<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--primary-color);">`;
                    html += `<p style="margin: 0;"><strong>Screen ${index + 1}:</strong> ${screen}</p>`;
                    html += '</div>';
                } else {
                    html += `<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--primary-color);">`;
                    html += `<p style="margin: 0;"><strong>Screen ${index + 1} - ${screen.name || 'Unnamed Screen'}:</strong> ${screen.purpose || 'No purpose specified'}</p>`;
                    if (screen.elements) {
                        html += `<p style="margin-top: 8px; margin-bottom: 0; font-size: 0.9em; color: #666;"><strong>Key Elements:</strong> ${screen.elements}</p>`;
                    }
                    if (screen.interactions) {
                        html += `<p style="margin-top: 8px; margin-bottom: 0; font-size: 0.9em; color: #666;"><strong>Interactions:</strong> ${screen.interactions}</p>`;
                    }
                    html += '</div>';
                }
            });
        }
        
        if (jsonData.screenDescriptions.uiComponents) {
            html += '<h4>UI Components:</h4>';
            // Check if uiComponents is an array or string
            if (Array.isArray(jsonData.screenDescriptions.uiComponents)) {
                html += '<ul style="margin-left: 20px;">';
                jsonData.screenDescriptions.uiComponents.forEach(component => {
                    html += `<li style="margin-bottom: 8px;">${component}</li>`;
                });
                html += '</ul>';
            } else {
                html += `<p>${jsonData.screenDescriptions.uiComponents}</p>`;
            }
        }
        
        if (jsonData.screenDescriptions.navigationStructure) {
            html += '<h4>Navigation Structure:</h4>';
            html += `<p>${jsonData.screenDescriptions.navigationStructure}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle applicationSummary
    if (jsonData.applicationSummary && jsonData.applicationSummary.paragraphs) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-clipboard"></i> Application Summary</h3>';
        jsonData.applicationSummary.paragraphs.forEach(paragraph => {
            html += `<p>${paragraph}</p>`;
        });
        html += '</div>';
    }
    
    // Handle coreFeatures
    if (jsonData.coreFeatures && Array.isArray(jsonData.coreFeatures)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-star"></i> Core Features</h3>';
        html += '<ul>';
        jsonData.coreFeatures.forEach(feature => {
            html += `<li>${feature}</li>`;
        });
        html += '</ul>';
        html += '</div>';
    }
    
    // Handle userJourney
    if (jsonData.userJourney && jsonData.userJourney.steps) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-road"></i> User Journey</h3>';
        html += '<ol>';
        jsonData.userJourney.steps.forEach(step => {
            html += `<li>${step}</li>`;
        });
        html += '</ol>';
        html += '</div>';
    }
    
    // Handle uniqueValueProposition
    if (jsonData.uniqueValueProposition) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-lightbulb-o"></i> Unique Value Proposition</h3>';
        html += `<p>${jsonData.uniqueValueProposition}</p>`;
        html += '</div>';
    }
    
    // Handle new Technical structure
    if (jsonData.techStack) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-wrench"></i> Tech Stack</h3>';
        
        if (jsonData.techStack.frontend) {
            html += `<p><strong>Frontend:</strong> ${jsonData.techStack.frontend}</p>`;
        }
        
        if (jsonData.techStack.backend) {
            html += `<p><strong>Backend:</strong> ${jsonData.techStack.backend}</p>`;
        }
        
        if (jsonData.techStack.database) {
            html += `<p><strong>Database:</strong> ${jsonData.techStack.database}</p>`;
        }
        
        if (jsonData.techStack.storage) {
            html += `<p><strong>Storage:</strong> ${jsonData.techStack.storage}</p>`;
        }
        
        if (jsonData.techStack.authentication) {
            html += `<p><strong>Authentication:</strong> ${jsonData.techStack.authentication}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Architecture Overview
    if (jsonData.architectureOverview) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-building"></i> Architecture Overview</h3>';
        html += `<p>${jsonData.architectureOverview}</p>`;
        html += '</div>';
    }
    
    // Handle new Database Schema
    if (jsonData.databaseSchema) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-database"></i> Database Schema</h3>';
        
        if (jsonData.databaseSchema.description) {
            html += `<p>${jsonData.databaseSchema.description}</p>`;
        }
        
        if (jsonData.databaseSchema.tables && Array.isArray(jsonData.databaseSchema.tables)) {
            html += '<h4>Tables:</h4>';
            jsonData.databaseSchema.tables.forEach(table => {
                // Check if table is a string or an object
                if (typeof table === 'string') {
                    // Handle string format (legacy)
                    html += `<h5>${table}</h5>`;
                } else if (typeof table === 'object' && table.name) {
                    // Handle object format with full details
                    html += `<h5 style="color: var(--primary-color); margin-top: 20px;">${table.name}</h5>`;
                    
                    if (table.purpose) {
                        html += `<p><strong>Purpose:</strong> ${table.purpose}</p>`;
                    }
                    
                    if (table.fields && Array.isArray(table.fields)) {
                        html += '<h6 style="margin-top: 10px; font-weight: bold;">Fields:</h6>';
                        // Check if fields are objects or strings
                        if (table.fields.length > 0 && typeof table.fields[0] === 'object') {
                            // Object format - create a table
                            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;">';
                            html += '<thead><tr style="background-color: #f5f5f5;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Field</th>';
                            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Type</th>';
                            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Constraints</th>';
                            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th></tr></thead><tbody>';
                            
                            table.fields.forEach(field => {
                                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;"><code>${field.name || 'N/A'}</code></td>`;
                                html += `<td style="padding: 8px; border: 1px solid #ddd;">${field.type || 'N/A'}</td>`;
                                html += `<td style="padding: 8px; border: 1px solid #ddd;">${field.constraints || 'N/A'}</td>`;
                                html += `<td style="padding: 8px; border: 1px solid #ddd;">${field.description || 'N/A'}</td></tr>`;
                            });
                            
                            html += '</tbody></table>';
                        } else {
                            // String format - simple list
                            html += '<ul style="margin-left: 20px;">';
                            table.fields.forEach(field => {
                                html += `<li style="margin-bottom: 5px;"><code>${field}</code></li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    
                    if (table.relationships) {
                        html += `<p style="margin-top: 10px;"><strong>Relationships:</strong> ${table.relationships}</p>`;
                    }
                }
            });
        }
        
        if (jsonData.databaseSchema.relationships) {
            html += '<h4>Relationships:</h4>';
            html += `<p>${jsonData.databaseSchema.relationships}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new API Endpoints
    if (jsonData.apiEndpoints && Array.isArray(jsonData.apiEndpoints)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-plug"></i> API Endpoints</h3>';
        
        jsonData.apiEndpoints.forEach(endpoint => {
            html += `<h4>${endpoint.method || 'N/A'} ${endpoint.path || 'N/A'}</h4>`;
            html += `<p><strong>Description:</strong> ${endpoint.description || 'No description provided'}</p>`;
            
            if (endpoint.requestExample) {
                html += `<p><strong>Request Example:</strong></p>`;
                html += `<pre><code>${endpoint.requestExample}</code></pre>`;
            }
            
            if (endpoint.responseExample) {
                html += `<p><strong>Response Example:</strong></p>`;
                html += `<pre><code>${endpoint.responseExample}</code></pre>`;
            }
        });
        
        html += '</div>';
    }
    
    // Handle new Security & Authentication
    if (jsonData.securityAuthentication) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-lock"></i> Security & Authentication</h3>';
        
        if (jsonData.securityAuthentication.authentication) {
            html += `<p><strong>Authentication:</strong> ${jsonData.securityAuthentication.authentication}</p>`;
        }
        
        if (jsonData.securityAuthentication.authorization) {
            html += `<p><strong>Authorization:</strong> ${jsonData.securityAuthentication.authorization}</p>`;
        }
        
        if (jsonData.securityAuthentication.encryption) {
            html += `<p><strong>Encryption:</strong> ${jsonData.securityAuthentication.encryption}</p>`;
        }
        
        if (jsonData.securityAuthentication.securityMeasures) {
            html += `<p><strong>Security Measures:</strong> ${jsonData.securityAuthentication.securityMeasures}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Integration & External APIs
    if (jsonData.integrationExternalApis) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-link"></i> Integration & External APIs</h3>';
        
        if (jsonData.integrationExternalApis.thirdPartyServices && Array.isArray(jsonData.integrationExternalApis.thirdPartyServices)) {
            html += '<h4>Third Party Services:</h4>';
            html += '<ul>';
            jsonData.integrationExternalApis.thirdPartyServices.forEach(service => {
                html += `<li>${service}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.integrationExternalApis.integrations) {
            html += `<p><strong>Integrations:</strong> ${jsonData.integrationExternalApis.integrations}</p>`;
        }
        
        if (jsonData.integrationExternalApis.dataFlow) {
            html += `<p><strong>Data Flow:</strong> ${jsonData.integrationExternalApis.dataFlow}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new DevOps
    if (jsonData.devops) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-server"></i> DevOps</h3>';
        
        if (jsonData.devops.deploymentStrategy) {
            html += `<p><strong>Deployment Strategy:</strong> ${jsonData.devops.deploymentStrategy}</p>`;
        }
        
        if (jsonData.devops.infrastructure) {
            html += `<p><strong>Infrastructure:</strong> ${jsonData.devops.infrastructure}</p>`;
        }
        
        if (jsonData.devops.monitoring) {
            html += `<p><strong>Monitoring:</strong> ${jsonData.devops.monitoring}</p>`;
        }
        
        if (jsonData.devops.scaling) {
            html += `<p><strong>Scaling:</strong> ${jsonData.devops.scaling}</p>`;
        }
        
        if (jsonData.devops.backup) {
            html += `<p><strong>Backup:</strong> ${jsonData.devops.backup}</p>`;
        }
        
        if (jsonData.devops.automation) {
            html += `<p><strong>Automation:</strong> ${jsonData.devops.automation}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Data Storage
    if (jsonData.dataStorage) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-hdd-o"></i> Data Storage Strategy</h3>';
        
        if (jsonData.dataStorage.storageStrategy) {
            html += `<p><strong>Storage Strategy:</strong> ${jsonData.dataStorage.storageStrategy}</p>`;
        }
        
        if (jsonData.dataStorage.dataRetention) {
            html += `<p><strong>Data Retention:</strong> ${jsonData.dataStorage.dataRetention}</p>`;
        }
        
        if (jsonData.dataStorage.dataBackup) {
            html += `<p><strong>Data Backup:</strong> ${jsonData.dataStorage.dataBackup}</p>`;
        }
        
        if (jsonData.dataStorage.storageArchitecture) {
            html += `<p><strong>Storage Architecture:</strong> ${jsonData.dataStorage.storageArchitecture}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Analytics
    if (jsonData.analytics) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-line-chart"></i> Analytics</h3>';
        
        if (jsonData.analytics.analyticsStrategy) {
            html += `<p><strong>Analytics Strategy:</strong> ${jsonData.analytics.analyticsStrategy}</p>`;
        }
        
        if (jsonData.analytics.trackingMethods) {
            html += `<p><strong>Tracking Methods:</strong> ${jsonData.analytics.trackingMethods}</p>`;
        }
        
        if (jsonData.analytics.analysisTools) {
            html += `<p><strong>Analysis Tools:</strong> ${jsonData.analytics.analysisTools}</p>`;
        }
        
        if (jsonData.analytics.reporting) {
            html += `<p><strong>Reporting:</strong> ${jsonData.analytics.reporting}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Detailed Data Models
    if (jsonData.detailedDataModels) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-database"></i> Detailed Data Models</h3>';
        
        if (jsonData.detailedDataModels.models && Array.isArray(jsonData.detailedDataModels.models)) {
            jsonData.detailedDataModels.models.forEach(model => {
                html += `<h4>${model.name || 'Unnamed Model'}</h4>`;
                
                if (model.purpose) {
                    html += `<p><strong>Purpose:</strong> ${model.purpose}</p>`;
                }
                
                if (model.fields && Array.isArray(model.fields)) {
                    html += '<h5>Fields:</h5>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background-color: #f5f5f5;"><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Name</th>';
                    html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Type</th>';
                    html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Required</th>';
                    html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Constraints</th>';
                    html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th></tr></thead><tbody>';
                    
                    model.fields.forEach(field => {
                        html += `<tr><td style="padding: 10px; border: 1px solid #ddd;"><code>${field.name || 'N/A'}</code></td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${field.type || 'N/A'}</td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${field.required ? 'Yes' : 'No'}</td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${field.constraints || '-'}</td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${field.description || 'N/A'}</td></tr>`;
                    });
                    
                    html += '</tbody></table>';
                }
                
                if (model.relationships) {
                    html += '<h5>Relationships:</h5>';
                    html += `<p>${model.relationships}</p>`;
                }
                
                if (model.validationRules) {
                    html += '<h5>Validation Rules:</h5>';
                    html += `<p>${model.validationRules}</p>`;
                }
                
                if (model.indexes) {
                    html += '<h5>Database Indexes:</h5>';
                    html += `<p>${model.indexes}</p>`;
                }
                
                if (model.sampleData) {
                    html += '<h5>Sample Data:</h5>';
                    html += `<p>${model.sampleData}</p>`;
                }
            });
        }
        
        if (jsonData.detailedDataModels.overallStructure) {
            html += '<h4>Overall Structure:</h4>';
            html += `<p>${jsonData.detailedDataModels.overallStructure}</p>`;
        }
        
        if (jsonData.detailedDataModels.totalModelsCount) {
            html += '<h4>Total Models Count:</h4>';
            html += `<p>${jsonData.detailedDataModels.totalModelsCount}</p>`;
        }
        
        if (jsonData.detailedDataModels.crudOperations) {
            html += '<h4>CRUD Operations:</h4>';
            html += `<p>${jsonData.detailedDataModels.crudOperations}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Data Flow Detailed
    if (jsonData.dataFlowDetailed) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-share-alt"></i> Detailed Data Flow</h3>';
        
        if (jsonData.dataFlowDetailed.authenticationFlow) {
            html += '<h4>Authentication Flow:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.authenticationFlow}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.dataSubmissionFlow) {
            html += '<h4>Data Submission Flow:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.dataSubmissionFlow}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.queryPatterns) {
            html += '<h4>Query Patterns:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.queryPatterns}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.cachingStrategy) {
            html += '<h4>Caching Strategy:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.cachingStrategy}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.errorScenarios) {
            html += '<h4>Error Scenarios:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.errorScenarios}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.dataValidation) {
            html += '<h4>Data Validation:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.dataValidation}</p>`;
        }
        
        if (jsonData.dataFlowDetailed.transactionFlow) {
            html += '<h4>Transaction Flow:</h4>';
            html += `<p>${jsonData.dataFlowDetailed.transactionFlow}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle Data Models (only if they exist)
    if (jsonData.dataModels && jsonData.dataModels.entities && Array.isArray(jsonData.dataModels.entities)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-building"></i> Data Models</h3>';
        
        jsonData.dataModels.entities.forEach(entity => {
            html += `<h4>${entity.name || 'Unnamed Entity'}</h4>`;
            html += '<p>This entity represents the following data structure:</p>';
            html += '<ul>';
            if (entity.attributes && Array.isArray(entity.attributes)) {
                entity.attributes.forEach(attr => {
                    html += `<li><strong>${attr.name || 'Unnamed'}</strong> (${attr.type || 'Unknown'})${attr.required ? ' - Required' : ''}${attr.enum ? ` - Options: ${attr.enum.join(', ')}` : ''}</li>`;
                });
            }
            html += '</ul>';
        });
        
        html += '</div>';
    }
    
    // Handle old Database Schema format (legacy)
    if (jsonData.databaseSchema && !jsonData.databaseSchema.description) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-database"></i> Database Schema (Legacy Format)</h3>';
        
        if (jsonData.databaseSchema.tables && Array.isArray(jsonData.databaseSchema.tables)) {
            jsonData.databaseSchema.tables.forEach(table => {
                // Check if table is a string or an object
                if (typeof table === 'string') {
                    html += `<h4>${table}</h4>`;
                    html += '<p>This table stores the following information:</p>';
                } else if (typeof table === 'object' && table.name) {
                    html += `<h4>${table.name} Table</h4>`;
                    html += '<p>This table stores the following information:</p>';
                    html += '<ul>';
                    if (table.columns && Array.isArray(table.columns)) {
                        table.columns.forEach(column => {
                            html += `<li><strong>${column.name || 'Unnamed'}</strong> (${column.type || 'Unknown'})${column.constraints ? ` - ${column.constraints.join(', ')}` : ''}</li>`;
                        });
                    }
                    html += '</ul>';
                }
            });
        }
        html += '</div>';
    }
    
    // Handle old API Endpoints format (legacy)
    if (jsonData.api) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-plug"></i> API Endpoints (Legacy Format)</h3>';
        
        if (jsonData.api.endpoints && Array.isArray(jsonData.api.endpoints)) {
            jsonData.api.endpoints.forEach(endpoint => {
                html += `<h4>${endpoint.method || 'N/A'} ${endpoint.path || 'N/A'}</h4>`;
                html += `<p>${endpoint.description || 'No description provided'}</p>`;
                if (endpoint.requestBody) {
                    html += '<p><strong>Request Body:</strong> ' + (endpoint.requestBody.type || 'N/A') + '</p>';
                }
                if (endpoint.responses) {
                    html += '<p><strong>Responses:</strong></p>';
                    html += '<ul>';
                    Object.keys(endpoint.responses).forEach(statusCode => {
                        html += `<li>${statusCode}: ${endpoint.responses[statusCode].description || 'No description'}</li>`;
                    });
                    html += '</ul>';
                }
            });
        }
        html += '</div>';
    }
    
    // Handle old Security format (legacy)
    if (jsonData.security) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-lock"></i> Security (Legacy Format)</h3>';
        
        if (jsonData.security.authentication) {
            html += `<h4>Authentication</h4>`;
            html += `<p>Type: ${jsonData.security.authentication.type || 'N/A'}</p>`;
            html += `<p>${jsonData.security.authentication.description || 'No description'}</p>`;
        }
        
        if (jsonData.security.authorization && jsonData.security.authorization.roles) {
            html += '<h4>Authorization</h4>';
            html += '<p>The system supports the following user roles:</p>';
            html += '<ul>';
            jsonData.security.authorization.roles.forEach(role => {
                html += `<li><strong>${role.role || 'N/A'}</strong>: ${role.permissions ? role.permissions.join(', ') : 'No permissions'}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.security.dataProtection) {
            html += '<h4>Data Protection</h4>';
            if (jsonData.security.dataProtection.encryption) {
                html += `<p>Encryption: ${jsonData.security.dataProtection.encryption.algorithm || 'N/A'} (${jsonData.security.dataProtection.encryption.enabled ? 'Enabled' : 'Disabled'})</p>`;
            }
            if (jsonData.security.dataProtection.passwordHashing) {
                html += `<p>Password Hashing: ${jsonData.security.dataProtection.passwordHashing.algorithm || 'N/A'} (Work Factor: ${jsonData.security.dataProtection.passwordHashing.workFactor || 'N/A'})</p>`;
            }
        }
        html += '</div>';
    }
    
    // Handle old Integration Points format (legacy)
    if (jsonData.integrationPoints) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-link"></i> Integration Points (Legacy Format)</h3>';
        
        if (jsonData.integrationPoints.externalAPIs && Array.isArray(jsonData.integrationPoints.externalAPIs)) {
            html += '<h4>External APIs</h4>';
            html += '<ul>';
            jsonData.integrationPoints.externalAPIs.forEach(api => {
                html += `<li><strong>${api.name || 'N/A'}</strong>: ${api.description || 'No description'}${api.url ? ` (${api.url})` : ''}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.integrationPoints.internalServices && Array.isArray(jsonData.integrationPoints.internalServices)) {
            html += '<h4>Internal Services</h4>';
            html += '<ul>';
            jsonData.integrationPoints.internalServices.forEach(service => {
                html += `<li><strong>${service.name || 'N/A'}</strong>: ${service.description || 'No description'}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    }
    
    // Handle new Market structure
    if (jsonData.industryOverview) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bar-chart"></i> Industry Overview</h3>';
        
        if (jsonData.industryOverview.trends) {
            html += `<p><strong>Trends:</strong> ${jsonData.industryOverview.trends}</p>`;
        }
        
        if (jsonData.industryOverview.marketData) {
            html += `<p><strong>Market Data:</strong> ${jsonData.industryOverview.marketData}</p>`;
        }
        
        if (jsonData.industryOverview.growthProjections) {
            html += `<p><strong>Growth Projections:</strong> ${jsonData.industryOverview.growthProjections}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Search Trends with chart
    if (jsonData.searchTrends) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-line-chart"></i> Search Trends</h3>';
        
        if (jsonData.searchTrends.keywords && Array.isArray(jsonData.searchTrends.keywords)) {
            html += '<h4>Keywords:</h4>';
            html += '<ul>';
            jsonData.searchTrends.keywords.forEach(keyword => {
                html += `<li>${keyword}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.searchTrends.historicalData && Array.isArray(jsonData.searchTrends.historicalData)) {
            html += '<h4>Historical Data (Last 3+ Months):</h4>';
            
            // Create a simple table for the data
            html += '<div style="overflow-x: auto;"><table class="search-trends-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background-color: #f5f5f5;"><th style="padding: 10px; border: 1px solid #ddd;">Month</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Search Volume</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Trend</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Competition</th></tr></thead><tbody>';
            
            jsonData.searchTrends.historicalData.forEach(data => {
                html += `<tr><td style="padding: 10px; border: 1px solid #ddd;">${data.month || 'N/A'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${data.searchVolume || 'N/A'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${data.trend || 'N/A'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${data.competition || 'N/A'}</td></tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Add simple visualization suggestion
            html += '<p style="margin-top: 15px; color: #666;"><i class="fa fa-info-circle"></i> This data can be visualized as a line chart showing search volume trends over time.</p>';
        }
        
        if (jsonData.searchTrends.insights) {
            html += `<p><strong>Insights:</strong> ${jsonData.searchTrends.insights}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Target Audience Insights
    if (jsonData.targetAudienceInsights) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-users"></i> Target Audience Insights</h3>';
        
        if (jsonData.targetAudienceInsights.needsAnalysis) {
            html += `<p><strong>Needs Analysis:</strong> ${jsonData.targetAudienceInsights.needsAnalysis}</p>`;
        }
        
        if (jsonData.targetAudienceInsights.usageHabits) {
            html += `<p><strong>Usage Habits:</strong> ${jsonData.targetAudienceInsights.usageHabits}</p>`;
        }
        
        if (jsonData.targetAudienceInsights.demographics) {
            html += `<p><strong>Demographics:</strong> ${jsonData.targetAudienceInsights.demographics}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Competitive Landscape
    if (jsonData.competitiveLandscape && Array.isArray(jsonData.competitiveLandscape)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-building"></i> Competitive Landscape</h3>';
        
        jsonData.competitiveLandscape.forEach(competitor => {
            html += `<h4>${competitor.competitor || 'Unnamed Competitor'}</h4>`;
            html += `<p><strong>Advantages:</strong> ${competitor.advantages || 'No advantages listed'}</p>`;
            html += `<p><strong>Disadvantages:</strong> ${competitor.disadvantages || 'No disadvantages listed'}</p>`;
            html += `<p><strong>Market Position:</strong> ${competitor.marketPosition || 'No market position specified'}</p>`;
        });
        
        html += '</div>';
    }
    
    // Handle new SWOT Analysis
    if (jsonData.swotAnalysis) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-search"></i> SWOT Analysis</h3>';
        
        if (jsonData.swotAnalysis.strengths && Array.isArray(jsonData.swotAnalysis.strengths)) {
            html += '<h4>Strengths:</h4>';
            html += '<ul>';
            jsonData.swotAnalysis.strengths.forEach(strength => {
                html += `<li>${strength || 'No strength specified'}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.swotAnalysis.weaknesses && Array.isArray(jsonData.swotAnalysis.weaknesses)) {
            html += '<h4>Weaknesses:</h4>';
            html += '<ul>';
            jsonData.swotAnalysis.weaknesses.forEach(weakness => {
                html += `<li>${weakness || 'No weakness specified'}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.swotAnalysis.opportunities && Array.isArray(jsonData.swotAnalysis.opportunities)) {
            html += '<h4>Opportunities:</h4>';
            html += '<ul>';
            jsonData.swotAnalysis.opportunities.forEach(opportunity => {
                html += `<li>${opportunity || 'No opportunity specified'}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.swotAnalysis.threats && Array.isArray(jsonData.swotAnalysis.threats)) {
            html += '<h4>Threats:</h4>';
            html += '<ul>';
            jsonData.swotAnalysis.threats.forEach(threat => {
                html += `<li>${threat || 'No threat specified'}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    }
    
    // Handle new Monetization Model
    if (jsonData.monetizationModel) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-money"></i> Monetization Model</h3>';
        
        if (jsonData.monetizationModel.proposedModels && Array.isArray(jsonData.monetizationModel.proposedModels)) {
            html += '<h4>Proposed Models:</h4>';
            html += '<ul>';
            jsonData.monetizationModel.proposedModels.forEach(model => {
                html += `<li>${model}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.monetizationModel.recommendations) {
            html += `<p><strong>Recommendations:</strong> ${jsonData.monetizationModel.recommendations}</p>`;
        }
        
        if (jsonData.monetizationModel.pricingStrategy) {
            html += `<p><strong>Pricing Strategy:</strong> ${jsonData.monetizationModel.pricingStrategy}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Pain Points
    if (jsonData.painPoints && Array.isArray(jsonData.painPoints)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-exclamation-circle"></i> Pain Points</h3>';
        
        jsonData.painPoints.forEach((painPoint, index) => {
            html += '<div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid #dc3545; background: #fff5f5;">';
            html += `<h4>Pain Point ${index + 1}</h4>`;
            
            if (painPoint.pain) {
                html += `<p><strong>Problem:</strong> ${painPoint.pain}</p>`;
            }
            
            if (painPoint.impact) {
                html += `<p><strong>Impact:</strong> ${painPoint.impact}</p>`;
            }
            
            if (painPoint.frequency) {
                html += `<p><strong>Frequency:</strong> ${painPoint.frequency}</p>`;
            }
            
            if (painPoint.emotionalImpact) {
                html += `<p><strong>Emotional Impact:</strong> ${painPoint.emotionalImpact}</p>`;
            }
            
            if (painPoint.currentWorkarounds) {
                html += `<p><strong>Current Workarounds:</strong> ${painPoint.currentWorkarounds}</p>`;
            }
            
            if (painPoint.severity) {
                html += `<p><strong>Severity:</strong> ${painPoint.severity}</p>`;
            }
            
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    // Handle new Business Models Analysis
    if (jsonData.businessModelsAnalysis && Array.isArray(jsonData.businessModelsAnalysis)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-money"></i> Business Models Analysis</h3>';
        
        jsonData.businessModelsAnalysis.forEach((model, index) => {
            html += `<div style="margin-bottom: 25px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">`;
            html += `<h4><i class="fa fa-cog"></i> ${model.model || 'Model ' + (index + 1)}</h4>`;
            
            if (model.description) {
                html += `<p><strong>Description:</strong> ${model.description}</p>`;
            }
            
            if (model.advantages && Array.isArray(model.advantages)) {
                html += '<h5>Advantages:</h5>';
                html += '<ul>';
                model.advantages.forEach(adv => {
                    html += `<li>${adv}</li>`;
                });
                html += '</ul>';
            }
            
            if (model.disadvantages && Array.isArray(model.disadvantages)) {
                html += '<h5>Disadvantages:</h5>';
                html += '<ul>';
                model.disadvantages.forEach(dis => {
                    html += `<li>${dis}</li>`;
                });
                html += '</ul>';
            }
            
            if (model.revenuePotential) {
                html += `<p><strong>Revenue Potential:</strong> ${model.revenuePotential}</p>`;
            }
            
            if (model.fitScore) {
                html += `<p><strong>Fit Score:</strong> ${model.fitScore}</p>`;
            }
            
            if (model.implementationComplexity) {
                html += `<p><strong>Implementation Complexity:</strong> ${model.implementationComplexity}</p>`;
            }
            
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    // Handle new Quality Assessment
    if (jsonData.qualityAssessment) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-check-circle"></i> Quality Assessment</h3>';
        
        if (jsonData.qualityAssessment.marketFitRating) {
            html += `<p><strong>Market Fit Rating:</strong> ${jsonData.qualityAssessment.marketFitRating}</p>`;
        }
        
        if (jsonData.qualityAssessment.technicalFeasibility) {
            html += `<p><strong>Technical Feasibility:</strong> ${jsonData.qualityAssessment.technicalFeasibility}</p>`;
        }
        
        if (jsonData.qualityAssessment.executionRiskFactors && Array.isArray(jsonData.qualityAssessment.executionRiskFactors)) {
            html += '<h4>Execution Risk Factors:</h4>';
            html += '<ul>';
            jsonData.qualityAssessment.executionRiskFactors.forEach(risk => {
                html += `<li>${risk}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.qualityAssessment.marketReadiness) {
            html += `<p><strong>Market Readiness:</strong> ${jsonData.qualityAssessment.marketReadiness}</p>`;
        }
        
        if (jsonData.qualityAssessment.keySuccessFactors && Array.isArray(jsonData.qualityAssessment.keySuccessFactors)) {
            html += '<h4>Key Success Factors:</h4>';
            html += '<ul>';
            jsonData.qualityAssessment.keySuccessFactors.forEach(factor => {
                html += `<li>${factor}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.qualityAssessment.goToMarketReadiness) {
            html += `<p><strong>Go-To-Market Readiness:</strong> ${jsonData.qualityAssessment.goToMarketReadiness}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Unique Selling Proposition
    if (jsonData.uniqueSellingProposition) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-star"></i> Unique Selling Proposition</h3>';
        
        if (jsonData.uniqueSellingProposition.coreValue) {
            html += `<p><strong>Core Value:</strong> ${jsonData.uniqueSellingProposition.coreValue}</p>`;
        }
        
        if (jsonData.uniqueSellingProposition.differentiationFactors && Array.isArray(jsonData.uniqueSellingProposition.differentiationFactors)) {
            html += '<h4>Differentiation Factors:</h4>';
            html += '<ul>';
            jsonData.uniqueSellingProposition.differentiationFactors.forEach(factor => {
                html += `<li>${factor}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.uniqueSellingProposition.competitiveAdvantages && Array.isArray(jsonData.uniqueSellingProposition.competitiveAdvantages)) {
            html += '<h4>Competitive Advantages:</h4>';
            html += '<ul>';
            jsonData.uniqueSellingProposition.competitiveAdvantages.forEach(adv => {
                html += `<li>${adv}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.uniqueSellingProposition.sustainability) {
            html += `<p><strong>Sustainability:</strong> ${jsonData.uniqueSellingProposition.sustainability}</p>`;
        }
        
        if (jsonData.uniqueSellingProposition.proofPoints) {
            html += `<p><strong>Proof Points:</strong> ${jsonData.uniqueSellingProposition.proofPoints}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Monetization Model
    if (jsonData.monetizationModel) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-dollar"></i> Monetization Model</h3>';
        
        if (jsonData.monetizationModel.proposedModels && Array.isArray(jsonData.monetizationModel.proposedModels)) {
            html += '<h4>Proposed Models:</h4>';
            html += '<ul>';
            jsonData.monetizationModel.proposedModels.forEach(model => {
                html += `<li>${model}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.monetizationModel.recommendations) {
            html += `<p><strong>Recommendations:</strong> ${jsonData.monetizationModel.recommendations}</p>`;
        }
        
        if (jsonData.monetizationModel.pricingStrategy) {
            html += `<p><strong>Pricing Strategy:</strong> ${jsonData.monetizationModel.pricingStrategy}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Pricing Strategy
    if (jsonData.pricingStrategy) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-tag"></i> Detailed Pricing Strategy</h3>';
        
        if (jsonData.pricingStrategy.recommendations) {
            html += `<p><strong>Recommendations:</strong> ${jsonData.pricingStrategy.recommendations}</p>`;
        }
        
        if (jsonData.pricingStrategy.pricingComparison && Array.isArray(jsonData.pricingStrategy.pricingComparison)) {
            html += '<h4>Pricing Comparison:</h4>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background-color: #f5f5f5;"><th style="padding: 10px; border: 1px solid #ddd;">Competitor</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Pricing</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Features</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Value Prop</th></tr></thead><tbody>';
            
            jsonData.pricingStrategy.pricingComparison.forEach(comp => {
                html += `<tr><td style="padding: 10px; border: 1px solid #ddd;"><strong>${comp.competitor || 'N/A'}</strong></td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${comp.pricing || 'N/A'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${comp.features || 'N/A'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${comp.valueProposition || 'N/A'}</td></tr>`;
            });
            
            html += '</tbody></table>';
        }
        
        if (jsonData.pricingStrategy.justification) {
            html += '<h4>Justification:</h4>';
            html += `<p>${jsonData.pricingStrategy.justification}</p>`;
        }
        
        if (jsonData.pricingStrategy.suggestedPricing) {
            html += '<h4>Suggested Pricing:</h4>';
            html += `<p>${jsonData.pricingStrategy.suggestedPricing}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Expected ROI
    if (jsonData.expectedROI) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-chart-line"></i> Expected ROI</h3>';
        
        if (jsonData.expectedROI.scenarios && Array.isArray(jsonData.expectedROI.scenarios)) {
            jsonData.expectedROI.scenarios.forEach((scenario, index) => {
                html += `<div style="margin-bottom: 25px; padding: 20px; border: 1px solid ${index === 1 ? '#28a745' : index === 2 ? '#ffc107' : '#dc3545'}; border-radius: 8px; background: ${index === 1 ? '#f8fff8' : index === 2 ? '#fffef0' : '#fff5f5'};">`;
                html += `<h4>${scenario.scenario || 'Scenario ' + (index + 1)}</h4>`;
                
                if (scenario.assumptions) {
                    html += `<p><strong>Assumptions:</strong> ${scenario.assumptions}</p>`;
                }
                
                if (scenario.userProjections) {
                    html += `<p><strong>User Projections:</strong> ${scenario.userProjections}</p>`;
                }
                
                if (scenario.revenueProjections) {
                    html += `<p><strong>Revenue Projections:</strong> ${scenario.revenueProjections}</p>`;
                }
                
                if (scenario.costBreakdown) {
                    html += `<p><strong>Cost Breakdown:</strong> ${scenario.costBreakdown}</p>`;
                }
                
                if (scenario.roiCalculation) {
                    html += `<p><strong>ROI Calculation:</strong> ${scenario.roiCalculation}</p>`;
                }
                
                html += '</div>';
            });
        }
        
        if (jsonData.expectedROI.riskFactors && Array.isArray(jsonData.expectedROI.riskFactors)) {
            html += '<h4>Risk Factors:</h4>';
            html += '<ul>';
            jsonData.expectedROI.riskFactors.forEach(risk => {
                html += `<li>${risk}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.expectedROI.sensitivityAnalysis) {
            html += '<h4>Sensitivity Analysis:</h4>';
            html += `<p>${jsonData.expectedROI.sensitivityAnalysis}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new KPI Framework
    if (jsonData.kpiFramework) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-key"></i> KPI Framework</h3>';
        
        if (jsonData.kpiFramework.userMetrics && Array.isArray(jsonData.kpiFramework.userMetrics)) {
            html += '<h4>User Metrics:</h4>';
            jsonData.kpiFramework.userMetrics.forEach(metric => {
                html += '<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
                html += `<h5>${metric.metric || 'Unnamed Metric'}</h5>`;
                
                if (metric.definition) {
                    html += `<p><strong>Definition:</strong> ${metric.definition}</p>`;
                }
                
                if (metric.targetValue) {
                    html += `<p><strong>Target Value:</strong> ${metric.targetValue}</p>`;
                }
                
                if (metric.measurementMethod) {
                    html += `<p><strong>Measurement Method:</strong> ${metric.measurementMethod}</p>`;
                }
                
                if (metric.importance) {
                    html += `<p><strong>Importance:</strong> ${metric.importance}</p>`;
                }
                
                html += '</div>';
            });
        }
        
        if (jsonData.kpiFramework.businessMetrics && Array.isArray(jsonData.kpiFramework.businessMetrics)) {
            html += '<h4>Business Metrics:</h4>';
            html += '<ul>';
            jsonData.kpiFramework.businessMetrics.forEach(metric => {
                html += `<li>${metric}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.kpiFramework.productMetrics && Array.isArray(jsonData.kpiFramework.productMetrics)) {
            html += '<h4>Product Metrics:</h4>';
            html += '<ul>';
            jsonData.kpiFramework.productMetrics.forEach(metric => {
                html += `<li>${metric}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    }
    
    // Handle new Niche Information
    if (jsonData.nicheInformation) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bullseye"></i> Niche Information</h3>';
        
        if (jsonData.nicheInformation.nicheDefinition) {
            html += `<p><strong>Niche Definition:</strong> ${jsonData.nicheInformation.nicheDefinition}</p>`;
        }
        
        if (jsonData.nicheInformation.trends && Array.isArray(jsonData.nicheInformation.trends)) {
            html += '<h4>Trends:</h4>';
            html += '<ul>';
            jsonData.nicheInformation.trends.forEach(trend => {
                html += `<li>${trend}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.nicheInformation.opportunities && Array.isArray(jsonData.nicheInformation.opportunities)) {
            html += '<h4>Opportunities:</h4>';
            html += '<ul>';
            jsonData.nicheInformation.opportunities.forEach(opp => {
                html += `<li>${opp}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.nicheInformation.challenges && Array.isArray(jsonData.nicheInformation.challenges)) {
            html += '<h4>Challenges:</h4>';
            html += '<ul>';
            jsonData.nicheInformation.challenges.forEach(challenge => {
                html += `<li>${challenge}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.nicheInformation.growthFactors && Array.isArray(jsonData.nicheInformation.growthFactors)) {
            html += '<h4>Growth Factors:</h4>';
            html += '<ul>';
            jsonData.nicheInformation.growthFactors.forEach(factor => {
                html += `<li>${factor}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.nicheInformation.marketMaturity) {
            html += `<p><strong>Market Maturity:</strong> ${jsonData.nicheInformation.marketMaturity}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Market Statistics
    if (jsonData.marketStatistics) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bar-chart"></i> Market Statistics</h3>';
        
        if (jsonData.marketStatistics.globalStatistics && Array.isArray(jsonData.marketStatistics.globalStatistics)) {
            html += '<h4>Global Statistics:</h4>';
            html += '<ul>';
            jsonData.marketStatistics.globalStatistics.forEach(stat => {
                html += `<li>${stat}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.marketStatistics.targetMarketSize) {
            html += `<p><strong>Target Market Size (TAM/SAM/SOM):</strong> ${jsonData.marketStatistics.targetMarketSize}</p>`;
        }
        
        if (jsonData.marketStatistics.growthRate) {
            html += `<p><strong>Growth Rate:</strong> ${jsonData.marketStatistics.growthRate}</p>`;
        }
        
        if (jsonData.marketStatistics.keyNumbers) {
            html += '<h4>Key Numbers:</h4>';
            html += `<p>${jsonData.marketStatistics.keyNumbers}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Threats Overview
    if (jsonData.threatsOverview) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-shield"></i> Threats Overview</h3>';
        
        if (jsonData.threatsOverview.externalThreats && Array.isArray(jsonData.threatsOverview.externalThreats)) {
            html += '<h4>External Threats:</h4>';
            jsonData.threatsOverview.externalThreats.forEach(threat => {
                html += '<div style="margin-bottom: 15px; padding: 15px; border-left: 4px solid #dc3545; background: #fff5f5;">';
                html += `<h5>${threat.threat || 'Unknown Threat'}</h5>`;
                
                if (threat.probability) {
                    html += `<p><strong>Probability:</strong> ${threat.probability}</p>`;
                }
                
                if (threat.impact) {
                    html += `<p><strong>Impact:</strong> ${threat.impact}</p>`;
                }
                
                if (threat.mitigation) {
                    html += `<p><strong>Mitigation:</strong> ${threat.mitigation}</p>`;
                }
                
                html += '</div>';
            });
        }
        
        if (jsonData.threatsOverview.competitiveThreats && Array.isArray(jsonData.threatsOverview.competitiveThreats)) {
            html += '<h4>Competitive Threats:</h4>';
            html += '<ul>';
            jsonData.threatsOverview.competitiveThreats.forEach(threat => {
                html += `<li>${threat}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.threatsOverview.regulatoryThreats && Array.isArray(jsonData.threatsOverview.regulatoryThreats)) {
            html += '<h4>Regulatory Threats:</h4>';
            html += '<ul>';
            jsonData.threatsOverview.regulatoryThreats.forEach(threat => {
                html += `<li>${threat}</li>`;
            });
            html += '</ul>';
        }
        
        if (jsonData.threatsOverview.marketThreats && Array.isArray(jsonData.threatsOverview.marketThreats)) {
            html += '<h4>Market Threats:</h4>';
            html += '<ul>';
            jsonData.threatsOverview.marketThreats.forEach(threat => {
                html += `<li>${threat}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    }
    
    // Handle new Complexity Rating
    if (jsonData.complexityRating) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-cogs"></i> Complexity Rating</h3>';
        
        if (jsonData.complexityRating.overallRating) {
            html += `<p><strong>Overall Rating:</strong> ${jsonData.complexityRating.overallRating}/10</p>`;
        }
        
        if (jsonData.complexityRating.technicalComplexity) {
            html += `<p><strong>Technical Complexity:</strong> ${jsonData.complexityRating.technicalComplexity}</p>`;
        }
        
        if (jsonData.complexityRating.marketComplexity) {
            html += `<p><strong>Market Complexity:</strong> ${jsonData.complexityRating.marketComplexity}</p>`;
        }
        
        if (jsonData.complexityRating.operationalComplexity) {
            html += `<p><strong>Operational Complexity:</strong> ${jsonData.complexityRating.operationalComplexity}</p>`;
        }
        
        if (jsonData.complexityRating.mitigationStrategies) {
            html += '<h4>Mitigation Strategies:</h4>';
            html += `<p>${jsonData.complexityRating.mitigationStrategies}</p>`;
        }
        
        if (jsonData.complexityRating.developmentTimeline) {
            html += '<h4>Development Timeline:</h4>';
            html += `<p>${jsonData.complexityRating.developmentTimeline}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Actionable Insights
    if (jsonData.actionableInsights) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-lightbulb-o"></i> Actionable Insights</h3>';
        
        if (jsonData.actionableInsights.development) {
            html += '<div style="margin-bottom: 25px;">';
            html += '<h4><i class="fa fa-code"></i> Development Insights</h4>';
            
            if (jsonData.actionableInsights.development.priorities && Array.isArray(jsonData.actionableInsights.development.priorities)) {
                html += '<h5>Priorities:</h5>';
                html += '<ul>';
                jsonData.actionableInsights.development.priorities.forEach(priority => {
                    html += `<li>${priority}</li>`;
                });
                html += '</ul>';
            }
            
            if (jsonData.actionableInsights.development.recommendations) {
                html += `<p><strong>Recommendations:</strong> ${jsonData.actionableInsights.development.recommendations}</p>`;
            }
            
            if (jsonData.actionableInsights.development.phases) {
                html += `<p><strong>Phases:</strong> ${jsonData.actionableInsights.development.phases}</p>`;
            }
            
            if (jsonData.actionableInsights.development.mvpFeatures) {
                html += `<p><strong>MVP Features:</strong> ${jsonData.actionableInsights.development.mvpFeatures}</p>`;
            }
            
            html += '</div>';
        }
        
        if (jsonData.actionableInsights.marketFit) {
            html += '<div style="margin-bottom: 25px;">';
            html += '<h4><i class="fa fa-rocket"></i> Market Fit Insights</h4>';
            
            if (jsonData.actionableInsights.marketFit.strategies && Array.isArray(jsonData.actionableInsights.marketFit.strategies)) {
                html += '<h5>Strategies:</h5>';
                html += '<ul>';
                jsonData.actionableInsights.marketFit.strategies.forEach(strategy => {
                    html += `<li>${strategy}</li>`;
                });
                html += '</ul>';
            }
            
            if (jsonData.actionableInsights.marketFit.partnerships) {
                html += `<p><strong>Partnerships:</strong> ${jsonData.actionableInsights.marketFit.partnerships}</p>`;
            }
            
            if (jsonData.actionableInsights.marketFit.timing) {
                html += `<p><strong>Timing:</strong> ${jsonData.actionableInsights.marketFit.timing}</p>`;
            }
            
            if (jsonData.actionableInsights.marketFit.targetMarkets) {
                html += `<p><strong>Target Markets:</strong> ${jsonData.actionableInsights.marketFit.targetMarkets}</p>`;
            }
            
            html += '</div>';
        }
        
        if (jsonData.actionableInsights.productPositioning) {
            html += '<div style="margin-bottom: 25px;">';
            html += '<h4><i class="fa fa-bullseye"></i> Product Positioning Insights</h4>';
            
            if (jsonData.actionableInsights.productPositioning.branding) {
                html += `<p><strong>Branding:</strong> ${jsonData.actionableInsights.productPositioning.branding}</p>`;
            }
            
            if (jsonData.actionableInsights.productPositioning.messaging) {
                html += `<p><strong>Messaging:</strong> ${jsonData.actionableInsights.productPositioning.messaging}</p>`;
            }
            
            if (jsonData.actionableInsights.productPositioning.differentiation) {
                html += `<p><strong>Differentiation:</strong> ${jsonData.actionableInsights.productPositioning.differentiation}</p>`;
            }
            
            if (jsonData.actionableInsights.productPositioning.marketPosition) {
                html += `<p><strong>Market Position:</strong> ${jsonData.actionableInsights.productPositioning.marketPosition}</p>`;
            }
            
            html += '</div>';
        }
        
        html += '</div>';
    }
    
    // Handle new Marketing Strategy
    if (jsonData.marketingStrategy) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bullhorn"></i> Marketing Strategy</h3>';
        
        if (jsonData.marketingStrategy.channels) {
            html += `<p><strong>Channels:</strong> ${jsonData.marketingStrategy.channels}</p>`;
        }
        
        if (jsonData.marketingStrategy.community) {
            html += `<p><strong>Community:</strong> ${jsonData.marketingStrategy.community}</p>`;
        }
        
        if (jsonData.marketingStrategy.partnerships) {
            html += `<p><strong>Partnerships:</strong> ${jsonData.marketingStrategy.partnerships}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Design structure
    if (jsonData.visualStyleGuide) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-paint-brush"></i> Visual Style Guide</h3>';
        
        if (jsonData.visualStyleGuide.colors) {
            html += '<h4>Color Palette</h4>';
            html += '<div class="feature-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">';
            
            // Limit to 5 colors maximum
            const colorEntries = Object.entries(jsonData.visualStyleGuide.colors).slice(0, 5);
            
            colorEntries.forEach(([key, value]) => {
                // Extract color code (everything before the first space or dash)
                const colorMatch = String(value).match(/^#?[0-9A-Fa-f]{6}/);
                const color = colorMatch ? colorMatch[0] : (String(value).startsWith('#') ? value : '#6366F1');
                
                // Extract description if available (after dash)
                const dashIndex = String(value).indexOf(' - ');
                const description = dashIndex > 0 ? String(value).substring(dashIndex + 3) : '';
                
                html += '<div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e0e0e0; text-align: center;">';
                html += `<div style="width: 60px; height: 60px; border-radius: 12px; background: ${color}; margin: 0 auto 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>`;
                html += `<div style="font-weight: 600; margin-bottom: 5px;">${key.charAt(0).toUpperCase() + key.slice(1)}</div>`;
                html += `<div style="color: #666; font-size: 14px;">${color}</div>`;
                if (description) {
                    html += `<div style="color: #888; font-size: 13px; margin-top: 5px;">${description}</div>`;
                }
                html += '</div>';
            });
            
            html += '</div>';
        }
        
        // Handle Color Harmony and Reasoning (new fields)
        if (jsonData.visualStyleGuide.colorHarmony) {
            html += '<div style="margin-top: 15px; padding: 15px; background-color: #f0f8ff; border-left: 4px solid #2196F3; border-radius: 4px;">';
            html += '<h4><i class="fa fa-palette"></i> Color Harmony</h4>';
            html += `<p>${jsonData.visualStyleGuide.colorHarmony}</p>`;
            
            if (jsonData.visualStyleGuide.colorReasoning) {
                html += '<h4><i class="fa fa-lightbulb-o"></i> Color Reasoning</h4>';
                html += `<p>${jsonData.visualStyleGuide.colorReasoning}</p>`;
            }
            
            html += '</div>';
        }
        
        if (jsonData.visualStyleGuide.typography) {
            html += '<h4>Typography:</h4>';
            html += '<ul>';
            if (jsonData.visualStyleGuide.typography.headings) {
                html += `<li><strong>Headings:</strong> ${jsonData.visualStyleGuide.typography.headings}</li>`;
            }
            if (jsonData.visualStyleGuide.typography.body) {
                html += `<li><strong>Body:</strong> ${jsonData.visualStyleGuide.typography.body}</li>`;
            }
            if (jsonData.visualStyleGuide.typography.captions) {
                html += `<li><strong>Captions:</strong> ${jsonData.visualStyleGuide.typography.captions}</li>`;
            }
            html += '</ul>';
        }
        
        if (jsonData.visualStyleGuide.spacing) {
            html += `<p><strong>Spacing:</strong> ${jsonData.visualStyleGuide.spacing}</p>`;
        }
        
        if (jsonData.visualStyleGuide.buttons) {
            html += `<p><strong>Buttons:</strong> ${jsonData.visualStyleGuide.buttons}</p>`;
        }
        
        if (jsonData.visualStyleGuide.animations) {
            html += `<p><strong>Animations:</strong> ${jsonData.visualStyleGuide.animations}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new Logo & Iconography
    if (jsonData.logoIconography) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-picture-o"></i> Logo & Iconography</h3>';
        
        if (jsonData.logoIconography.logoConcepts) {
            html += `<p><strong>Logo Concepts:</strong> ${jsonData.logoIconography.logoConcepts}</p>`;
        }
        
        if (jsonData.logoIconography.colorVersions) {
            html += `<p><strong>Color Versions:</strong> ${jsonData.logoIconography.colorVersions}</p>`;
        }
        
        if (jsonData.logoIconography.iconSet) {
            html += `<p><strong>Icon Set:</strong> ${jsonData.logoIconography.iconSet}</p>`;
        }
        
        // App Icon Design (like in demo-spec.html)
        if (jsonData.logoIconography.appIcon) {
            html += '<h4 style="margin-top: 25px; margin-bottom: 20px;"><i class="fa fa-mobile"></i> App Icon Design</h4>';
            html += '<div style="display: flex; gap: 30px; align-items: center; flex-wrap: wrap;">';
            
            const appIcon = jsonData.logoIconography.appIcon;
            const letters = appIcon.letters || 'AA'; // Default to AA if not provided
            const bgColor = appIcon.bgColor || 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)'; // Default gradient
            
            // iOS App Icon
            html += '<div style="text-align: center;">';
            html += `<div style="width: 120px; height: 120px; border-radius: 25px; background: ${bgColor}; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: white; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);">${letters}</div>`;
            html += '<p style="margin-top: 15px; font-weight: 600;">iOS App Icon</p>';
            html += '</div>';
            
            // Android App Icon
            html += '<div style="text-align: center;">';
            html += `<div style="width: 120px; height: 120px; border-radius: 20px; background: ${bgColor}; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: white; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);">${letters}</div>`;
            html += '<p style="margin-top: 15px; font-weight: 600;">Android App Icon</p>';
            html += '</div>';
            
            // Description
            if (appIcon.description) {
                html += '<div style="flex: 1; padding: 20px; min-width: 250px;">';
                html += `<p>${appIcon.description}</p>`;
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        html += '</div>';
    }
    
    // Handle new UI Layout
    if (jsonData.uiLayout) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-mobile"></i> UI Layout</h3>';
        
        if (jsonData.uiLayout.landingPage) {
            html += `<p><strong>Landing Page:</strong> ${jsonData.uiLayout.landingPage}</p>`;
        }
        
        if (jsonData.uiLayout.dashboard) {
            html += `<p><strong>Dashboard:</strong> ${jsonData.uiLayout.dashboard}</p>`;
        }
        
        if (jsonData.uiLayout.navigation) {
            html += `<p><strong>Navigation:</strong> ${jsonData.uiLayout.navigation}</p>`;
        }
        
        if (jsonData.uiLayout.responsiveDesign) {
            html += `<p><strong>Responsive Design:</strong> ${jsonData.uiLayout.responsiveDesign}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle new UX Principles
    if (jsonData.uxPrinciples) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bullseye"></i> UX Principles</h3>';
        
        if (jsonData.uxPrinciples.userFlow) {
            html += `<p><strong>User Flow:</strong> ${jsonData.uxPrinciples.userFlow}</p>`;
        }
        
        if (jsonData.uxPrinciples.accessibility) {
            html += `<p><strong>Accessibility:</strong> ${jsonData.uxPrinciples.accessibility}</p>`;
        }
        
        if (jsonData.uxPrinciples.informationHierarchy) {
            html += `<p><strong>Information Hierarchy:</strong> ${jsonData.uxPrinciples.informationHierarchy}</p>`;
        }
        
        html += '</div>';
    }
    
    // Handle Market Content
    if (jsonData.marketOverview) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-bar-chart"></i> Market Overview</h3>';
        html += `<p>${jsonData.marketOverview}</p>`;
        html += '</div>';
    }
    
    if (jsonData.competitors && jsonData.competitors.list && Array.isArray(jsonData.competitors.list)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-building"></i> Competitors Analysis</h3>';
        html += '<ul>';
        jsonData.competitors.list.forEach(competitor => {
            if (typeof competitor === 'object' && competitor.name && competitor.description) {
                html += `<li><strong>${competitor.name}</strong>: ${competitor.description}</li>`;
            } else if (typeof competitor === 'string') {
                html += `<li>${competitor}</li>`;
            } else {
                html += `<li>${JSON.stringify(competitor)}</li>`;
            }
        });
        html += '</ul>';
        html += '</div>';
    }
    
    if (jsonData.targetAudience && jsonData.targetAudience.personas && Array.isArray(jsonData.targetAudience.personas)) {
        html += '<div class="content-section">';
        html += '<h3><i class="fa fa-users"></i> Target Audience Personas</h3>';
        html += '<ul>';
        jsonData.targetAudience.personas.forEach(persona => {
            if (typeof persona === 'object' && persona.name && persona.description) {
                html += `<li><strong>${persona.name}</strong> (Age: ${persona.age || 'N/A'}): ${persona.description}</li>`;
            } else if (typeof persona === 'string') {
                html += `<li>${persona}</li>`;
            } else {
                html += `<li>${JSON.stringify(persona)}</li>`;
            }
        });
        html += '</ul>';
        html += '</div>';
    }
    
    return html || '<div class="content-section"><p>No structured content available</p></div>';
}

function formatPlainTextContent(content) {
    if (!content || typeof content !== 'string') {
        return '<p>No content available</p>';
    }
    
    // Helper function to get icon based on section title
    function getIconForSection(title) {
        const lowerTitle = title.toLowerCase();
        if (lowerTitle.match(/summary|overview|introduction/i)) return 'fa-book';
        if (lowerTitle.match(/features|functionality|capabilities/i)) return 'fa-star';
        if (lowerTitle.match(/audience|users|target|demographics/i)) return 'fa-users';
        if (lowerTitle.match(/problem|issue|challenge/i)) return 'fa-exclamation-triangle';
        if (lowerTitle.match(/solution|value|proposition/i)) return 'fa-lightbulb-o';
        if (lowerTitle.match(/technology|tech|stack|architecture/i)) return 'fa-cog';
        if (lowerTitle.match(/design|ui|ux|interface|branding/i)) return 'fa-paint-brush';
        if (lowerTitle.match(/market|competition|competitor|analysis/i)) return 'fa-bar-chart';
        if (lowerTitle.match(/monetization|pricing|revenue|business|model/i)) return 'fa-dollar-sign';
        if (lowerTitle.match(/timeline|schedule|roadmap/i)) return 'fa-calendar';
        if (lowerTitle.match(/security|privacy|authentication/i)) return 'fa-shield';
        if (lowerTitle.match(/integration|api|third.party/i)) return 'fa-link';
        if (lowerTitle.match(/database|storage|data/i)) return 'fa-database';
        if (lowerTitle.match(/scalability|performance|optimization/i)) return 'fa-line-chart';
        if (lowerTitle.match(/sector|industry|vertical/i)) return 'fa-building';
        if (lowerTitle.match(/journey|flow|process/i)) return 'fa-road';
        if (lowerTitle.match(/screen|interface|ui|components/i)) return 'fa-desktop';
        return 'fa-check-circle';
    }
    
    // Helper function to format section content (handles bullets and paragraphs)
    function formatSectionContent(text) {
        if (!text) return '';
        
        const lines = text.split('\n').filter(line => line.trim());
        let html = '';
        let inList = false;
        let currentParagraph = '';
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) return;
            
            // Detect bullet points
            if (trimmed.match(/^[-*]\s/) || trimmed.match(/^\d+[\.\)]\s/)) {
                // Close paragraph if open
                if (currentParagraph) {
                    html += `<p>${currentParagraph}</p>`;
                    currentParagraph = '';
                }
                
                // Start list if not already in list
                if (!inList) {
                    html += '<ul>';
                    inList = true;
                }
                
                const listItem = trimmed.replace(/^[-*]\s/, '').replace(/^\d+[\.\)]\s/, '');
                html += `<li>${listItem}</li>`;
            } 
            // Detect lines with colons (sub-headers)
            else if (trimmed.includes(':') && trimmed.length < 200 && !trimmed.startsWith('---')) {
                // Close paragraph/list if open
                if (currentParagraph) {
                    html += `<p>${currentParagraph}</p>`;
                    currentParagraph = '';
                }
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                
                const parts = trimmed.split(':');
                const subHeader = parts[0].trim();
                const subContent = parts.slice(1).join(':').trim();
                
                html += `<h4>${subHeader}:</h4>`;
                if (subContent) {
                    html += `<p>${subContent}</p>`;
                }
            }
            else {
                // Regular text - build paragraph
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                currentParagraph += (currentParagraph ? ' ' : '') + trimmed;
            }
        });
        
        // Add remaining paragraph
        if (currentParagraph) {
            html += `<p>${currentParagraph}</p>`;
        }
        
        // Close list if still open
        if (inList) {
            html += '</ul>';
        }
        
        return html;
    }
    
    // Split by the "---" separators that mark different sections
    let sections;
    if (content.includes('---')) {
        sections = content.split(/---+/).filter(s => s.trim().length > 0);
    } else {
        // Fallback: split by newlines if no separators found
        sections = content.split('\n').filter(s => s.trim().length > 0);
    }
    
    let html = '';
    
    sections.forEach((section, index) => {
        const trimmedSection = section.trim();
        if (!trimmedSection) return;
        
        // Find the section title (usually the first line or key phrase)
        const lines = trimmedSection.split('\n');
        let sectionTitle = '';
        let sectionContent = '';
        
        // Try to find a title in the first line
        const firstLine = lines[0].trim();
        
        // Check if first line is a title (contains colon, is short, or matches known patterns)
        if (firstLine.includes(':') && firstLine.length < 150 && !firstLine.startsWith('- ') && !firstLine.startsWith('* ')) {
            const parts = firstLine.split(':');
            sectionTitle = parts[0].trim();
            sectionContent = (parts.slice(1).join(':').trim() + '\n' + lines.slice(1).join('\n')).trim();
        } else {
            // Look for key phrases that indicate section titles
            const titlePatterns = [
                /^(Value Proposition|Problem Statement|User Journey|Screen Descriptions|Detailed User Flow|Sector|Target Audience|Technology Stack|Security|Integration)/i
            ];
            
            let foundTitle = false;
            for (const pattern of titlePatterns) {
                const match = trimmedSection.match(pattern);
                if (match) {
                    sectionTitle = match[1];
                    sectionContent = trimmedSection.replace(pattern, '').trim();
                    foundTitle = true;
                    break;
                }
            }
            
            // If no title pattern found, use first few words as title
            if (!foundTitle) {
                const words = trimmedSection.split(' ').slice(0, 4).join(' ');
                sectionTitle = words;
                sectionContent = trimmedSection.replace(words, '').trim();
            }
        }
        
        // If we couldn't extract a title, use index
        if (!sectionTitle || sectionTitle.length === 0) {
            sectionTitle = `Section ${index + 1}`;
            sectionContent = trimmedSection;
        }
        
        // Get appropriate icon
        const icon = getIconForSection(sectionTitle);
        
        // Build HTML for this section
        html += '<div class="content-section">';
        html += `<h3><i class="fa ${icon}"></i> ${sectionTitle}</h3>`;
        html += formatSectionContent(sectionContent);
        html += '</div>';
    });
    
    // Fallback if no sections were created
    if (!html) {
        html = `<div class="content-section"><p>${content.replace(/\n/g, '<br>')}</p></div>`;
    }
    
    return html;
}

function updateStatus(type, status) {
    const element = document.getElementById(`${type}Status`);
    if (element) {
        element.textContent = status;
        element.className = `status-value ${status}`;

    }
}

function updateTabLoadingState(type, isLoading) {
    // Tab loading animations removed - using notification system instead
    const tabButton = document.getElementById(`${type}Tab`);
    if (!tabButton) return;
    
    // Minimal visual feedback - just enable/disable the tab
    if (isLoading) {
        tabButton.disabled = true;
    } else {
        tabButton.disabled = false;
    }
}


function updateStorageStatus() {
    
    const user = firebase.auth().currentUser;
    const hasSpecId = currentSpecData && currentSpecData.id;
    const hasUserId = currentSpecData && currentSpecData.userId;
    
    let status, statusClass;
    
    if (hasSpecId && hasUserId && user && currentSpecData.userId === user.uid) {
        // Spec is saved in Firebase and belongs to current user
        status = 'Firebase';
        statusClass = 'firebase';
    } else {
        // Spec belongs to current user but not saved to Firebase yet (shouldn't happen now)
        status = 'Local';
        statusClass = 'local';
    }
    
    
    const element = document.getElementById('storageStatus');
    if (element) {
        element.textContent = status;
        element.className = `status-value ${statusClass}`;

    }
}

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(`${tabName}-content`).style.display = 'block';
    
    // Add active class to selected button
    const tabButton = document.getElementById(`${tabName}Tab`);
    if (tabButton && !tabButton.disabled) {
        tabButton.classList.add('active');
    }
    
    currentTab = tabName;
}

// Functions for tab loading states
function setTabLoading(tabId, isLoading = true) {
    const tabButton = document.getElementById(tabId);
    if (!tabButton) return;
    
    if (isLoading) {
        tabButton.classList.add('loading');
        // No spinner - just loading state
    } else {
        tabButton.classList.remove('loading');
    }
}

function setTabStatus(tabId, status) {
    const tabButton = document.getElementById(tabId);
    if (!tabButton) return;
    
    // Remove all status classes
    tabButton.classList.remove('success', 'error', 'pending', 'loading');
    
    // Add new status class
    if (status) {
        tabButton.classList.add(status);
    }
}

// Edit mode variables and functions
let isEditMode = false;
let originalHTML = '';
let userHasProAccess = false;

// Check if user has PRO access
async function checkProAccess() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) {
            return false;
        }
        
        // Check entitlements for unlimited access
        const entitlementsDoc = await firebase.firestore().collection('entitlements').doc(user.uid).get();
        if (entitlementsDoc.exists) {
            const entitlements = entitlementsDoc.data();
            if (entitlements.unlimited === true) {
                return true;
            }
        }
        
        // Also check user plan as fallback
        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.plan === 'pro') {
                return true;
            }
        }
        
        return false;
    } catch (error) {

        return false;
    }
}

// Update edit button based on PRO access
async function updateEditButton() {
    const editBtn = document.getElementById('editBtn');
    if (!editBtn) return;
    
    userHasProAccess = await checkProAccess();
    
    if (userHasProAccess) {
        // PRO user - enable editing
        editBtn.disabled = false;
        editBtn.classList.remove('btn-disabled', 'locked');
        editBtn.innerHTML = '<i class="fa fa-pencil"></i> Edit';
        editBtn.onclick = toggleEditMode;
    } else {
        // Non-PRO user - disable editing
        editBtn.disabled = true;
        editBtn.classList.add('btn-disabled', 'locked');
        editBtn.innerHTML = '<i class="fa fa-lock"></i> Edit <span class="pro-badge">(PRO)</span>';
        editBtn.onclick = null;
        editBtn.title = 'Editing is available for PRO users only';
    }
}

function toggleEditMode() {
    // Check PRO access before allowing edit
    if (!userHasProAccess) {
        showNotification('Editing is available for PRO users only. Please upgrade to PRO to edit specifications.', 'error');
        return;
    }
    
    const editBtn = document.getElementById('editBtn');
    const container = document.getElementById('overview-data');
    
    if (!isEditMode) {
        // Enter edit mode
        isEditMode = true;
        editBtn.innerHTML = '<i class="fa fa-save"></i> Save';
        editBtn.classList.remove('btn-secondary');
        editBtn.classList.add('btn-success');
        editBtn.onclick = saveOverviewEdit;
        
        // Save current HTML structure
        originalHTML = container.innerHTML;
        window.editModeHTML = originalHTML;
        
        // Make all content sections editable but preserve icons
        const contentSections = container.querySelectorAll('.content-section');
        contentSections.forEach(section => {
            section.classList.add('editing');
            
            // Lock icons - make them non-editable
            const icons = section.querySelectorAll('i');
            icons.forEach(icon => {
                icon.setAttribute('contenteditable', 'false');
                icon.classList.add('icon-locked');
            });
            
            // Make paragraphs editable
            const paragraphs = section.querySelectorAll('p');
            paragraphs.forEach(p => {
                p.setAttribute('contenteditable', 'true');
            });
            
            // Make headings editable - wrap text nodes in spans for finer control
            const headings = section.querySelectorAll('h3');
            headings.forEach(heading => {
                heading.setAttribute('contenteditable', 'true');
            });
        });
        
        container.classList.add('edit-mode-active');
    }
}

async function saveOverviewEdit() {
    const editBtn = document.getElementById('editBtn');
    const container = document.getElementById('overview-data');
    
    try {
        // Exit edit mode first
        const contentSections = container.querySelectorAll('.content-section');
        contentSections.forEach(section => {
            section.setAttribute('contenteditable', 'false');
            section.classList.remove('editing');
        });
        
        container.classList.remove('edit-mode-active');
        
        // Get the original content for comparison
        const originalContent = window.originalOverview || currentSpecData.overview;
        
        // Extract text content from HTML structure while preserving the original structure
        const sections = [];
        contentSections.forEach(section => {
            const heading = section.querySelector('h3');
            // Get all paragraphs, preserving their order and structure
            const paragraphs = Array.from(section.querySelectorAll('p'));
            const content = paragraphs.map(p => {
                // Preserve the text content, but handle multiple paragraphs correctly
                const text = p.textContent.trim();
                return text;
            }).filter(t => t);
            
            if (heading) {
                // Extract text from heading, ignoring icons
                const headingText = Array.from(heading.childNodes)
                    .filter(node => node.nodeType === 3 || (node.nodeType === 1 && node.tagName !== 'I'))
                    .map(node => {
                        if (node.nodeType === 3) {
                            return node.textContent;
                        } else if (node.nodeType === 1 && node.tagName !== 'I') {
                            // Get text from child text nodes only
                            return Array.from(node.childNodes)
                                .filter(n => n.nodeType === 3)
                                .map(n => n.textContent)
                                .join('');
                        }
                        return '';
                    })
                    .join('')
                    .trim();
                
                if (headingText && content.length > 0) {
                    // Join paragraphs with double newlines to preserve structure
                    const sectionContent = content.join('\n\n');
                    sections.push(headingText + '\n' + sectionContent);
                } else if (headingText && content.length === 0 && sections.length > 0) {
                    // If heading exists but no content, don't add it separately
                    // This prevents breaking the structure
                }
            }
        });
        
        const editedContent = sections.join('\n\n---\n\n');
        
        // Compare with original - if no changes, use original to preserve structure
        let finalContent = editedContent;
        
        // Check if content actually changed by comparing normalized versions
        const normalizedOriginal = (originalContent || '').trim().replace(/\s+/g, ' ');
        const normalizedEdited = editedContent.trim().replace(/\s+/g, ' ');
        
        if (normalizedOriginal === normalizedEdited && originalContent) {
            // No actual changes - keep original to preserve exact structure
            finalContent = originalContent;
        }
        
        // Update local data
        currentSpecData.overview = finalContent;
        window.originalOverview = finalContent;
        
        // Only save to Firebase if content actually changed
        if (normalizedOriginal !== normalizedEdited || !originalContent) {
            // Save to Firebase
            const user = firebase.auth().currentUser;
            if (user && currentSpecData.id) {
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    overview: finalContent,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reset chat history since spec was updated
                autoResetChatOnSpecUpdate();
                
                showNotification('Overview saved successfully!', 'success');
            }
        }
        
        // Exit edit mode
        isEditMode = false;
        editBtn.innerHTML = '<i class="fa fa-pencil"></i> Edit';
        editBtn.classList.remove('btn-success');
        editBtn.classList.add('btn-secondary');
        editBtn.onclick = toggleEditMode;
        
        // Display updated content (will use original if no changes)
        displayOverview(finalContent);
        
    } catch (error) {

        showNotification('Failed to save overview: ' + error.message, 'error');
    }
}

function enableAllTabs() {
    document.getElementById('technicalTab').disabled = false;
    document.getElementById('marketTab').disabled = false;
    document.getElementById('designTab').disabled = false;
    document.getElementById('diagramsTab').disabled = false;
    // Enable chat tab after overview approval
    enableChatTab();
}

function enableChatTabOnly() {
    // Enable AI Chat tab immediately after overview approval
    // without waiting for other specs to be generated
    enableChatTab();
}

function disableTechnicalTabs() {
    document.getElementById('technicalTab').disabled = true;
    document.getElementById('marketTab').disabled = true;
    document.getElementById('designTab').disabled = true;
    document.getElementById('diagramsTab').disabled = true;
    // Note: AI Chat tab is NOT disabled here - it stays enabled after overview approval
}

function showApproveButton() {
    document.getElementById('approveBtn').style.display = 'inline-block';
}

function hideApproveButton() {
    document.getElementById('approveBtn').style.display = 'none';
    // Hide the entire approval container after approval
    const approvalContainer = document.getElementById('approval-container');
    if (approvalContainer) {
        approvalContainer.style.display = 'none';
    }
}

// Function to save spec to Firebase
async function saveSpecToFirebase(user, specData) {
    try {

        
        if (!user) {
            throw new Error('User must be authenticated to save to Firebase');
        }
        
        const specDoc = {
            title: specData.title || 'App Specification',
            overview: specData.overview,
            technical: specData.technical,
            market: specData.market,
            status: specData.status || {
                overview: "ready",
                technical: "pending",
                market: "pending"
            },
            overviewApproved: specData.overviewApproved || false,
            answers: specData.answers || [],
            userId: user.uid,
            userName: user.displayName || user.email || 'Anonymous User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        

        
        const docRef = await firebase.firestore().collection('specs').add(specDoc);

        
        // Show success notification
        showNotification('Specification saved successfully!', 'success');
        
        // Update storage status
        updateStorageStatus();
        
        return docRef.id;
        
    } catch (error) {

        
        // Show error notification
        showNotification(`Failed to save specification: ${error.message}`, 'error');
        
        throw error;
    }
}

// Helper function to check content size
function checkContentSize(content, contentType) {
    if (!content || typeof content !== 'string') {
        return { tooLarge: false, size: 0 };
    }
    const sizeInBytes = new Blob([content]).size;
    const maxSize = 1000000; // 1MB Firestore limit
    const sizeInMB = (sizeInBytes / 1024 / 1024).toFixed(2);
    

    
    return {
        tooLarge: sizeInBytes > maxSize,
        size: sizeInBytes,
        sizeInMB: sizeInMB,
        percentage: ((sizeInBytes / maxSize) * 100).toFixed(2)
    };
}

async function approveOverview() {
    if (isLoading) return;
    
    try {




        
        isLoading = true;
        const approveBtn = document.getElementById('approveBtn');
        approveBtn.disabled = true;
        approveBtn.innerHTML = '<span class="loading-spinner"></span> Generating specifications...';
        
        showNotification('Starting specification generation...', 'info');
        

        
        // Check if user is authenticated
        const user = firebase.auth().currentUser;
        if (!user) {
            showRegistrationModal();
            return;
        }
        
        // Note: Spec should already be saved to Firebase from index.js
        // Only update the approval status here
        
        // Update Firebase if user is authenticated and spec has ID
        if (user && currentSpecData && currentSpecData.id) {
            try {



                
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    overviewApproved: true,
                    status: {
                        overview: "ready",
                        technical: "generating",
                        market: "generating",
                        design: "generating"
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reset chat history since spec status changed
                autoResetChatOnSpecUpdate();
                

                showNotification('Overview approved successfully', 'success');
            } catch (error) {

                showNotification('Failed to update database. Continuing locally...', 'error');
            }
        }
        
        // Update local data
        currentSpecData.overviewApproved = true;
        currentSpecData.status.technical = "generating";
        currentSpecData.status.market = "generating";
        currentSpecData.status.design = "generating";
        
        // Enable AI Chat immediately after overview approval
        enableChatTabOnly();
        
        // Update UI
        updateTabLoadingState('technical', true);
        updateTabLoadingState('market', true);
        updateTabLoadingState('design', true);
        
        // Generate technical, market, and design specs sequentially

        
        // Generate Technical Spec first

        let technicalContent;
        try {
            technicalContent = await generateTechnicalSpec();

        } catch (error) {

            technicalContent = 'error';
        }
        
        // Update UI and Firebase for Technical
        currentSpecData.technical = technicalContent;
        currentSpecData.status.technical = technicalContent === 'error' ? "error" : "ready";
        updateStatus('technical', currentSpecData.status.technical);
        updateTabLoadingState('technical', false);
        
        // Enable Technical tab when ready
        if (technicalContent !== 'error') {
            document.getElementById('technicalTab').disabled = false;
            
            // If Market is also ready, enable Diagrams tab
            if (currentSpecData.status.market === 'ready') {
                document.getElementById('diagramsTab').disabled = false;
                const hasDiagrams = !!(currentSpecData.diagrams && Array.isArray(currentSpecData.diagrams.diagrams) && currentSpecData.diagrams.diagrams.length > 0);
                document.getElementById('generateDiagramsBtn').style.display = hasDiagrams ? 'none' : 'inline-block';
            }
        }
        
        displayTechnical(technicalContent);
        
        if (technicalContent !== 'error') {
            showNotification('Technical specification created successfully', 'success');
        }
        
        if (user && currentSpecData && currentSpecData.id) {
            try {
                // Check content size before updating
                const sizeCheck = checkContentSize(technicalContent, 'Technical');
                
                if (sizeCheck.tooLarge) {

                    showNotification(`Technical spec too large (${sizeCheck.sizeInMB}MB). Saved locally only.`, 'warning');
                } else {
                    const contentPreview = technicalContent.substring(0, 200) + (technicalContent.length > 200 ? '...' : '');






                    
                    await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                        technical: technicalContent,
                        'status.technical': currentSpecData.status.technical,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    

                    
                    // Reset chat since new content added to spec
                    autoResetChatOnSpecUpdate();
                    
                    // Trigger OpenAI upload (non-blocking)
                    triggerOpenAIUploadForSpec(currentSpecData.id).catch(err => {

                    });
                }
            } catch (error) {


                showNotification('Failed to save technical spec to database. Saved locally.', 'error');
            }
        }
        
        // Generate Market Spec second

        let marketContent;
        try {
            marketContent = await generateMarketSpec();

        } catch (error) {

            marketContent = 'error';
        }
        
        // Update UI and Firebase for Market
        currentSpecData.market = marketContent;
        currentSpecData.status.market = marketContent === 'error' ? "error" : "ready";
        updateStatus('market', currentSpecData.status.market);
        updateTabLoadingState('market', false);
        
        // Enable Market tab when ready
        if (marketContent !== 'error') {
            document.getElementById('marketTab').disabled = false;
            
            // If Technical is also ready, enable Diagrams tab
            if (currentSpecData.status.technical === 'ready') {
                document.getElementById('diagramsTab').disabled = false;
                const hasDiagrams = !!(currentSpecData.diagrams && Array.isArray(currentSpecData.diagrams.diagrams) && currentSpecData.diagrams.diagrams.length > 0);
                document.getElementById('generateDiagramsBtn').style.display = hasDiagrams ? 'none' : 'inline-block';
            }
        }
        
        displayMarket(marketContent);
        
        if (marketContent !== 'error') {
            showNotification('Market research completed successfully', 'success');
        }
        
        if (user && currentSpecData && currentSpecData.id) {
            try {
                // Check content size before updating
                const sizeCheck = checkContentSize(marketContent, 'Market');
                
                if (sizeCheck.tooLarge) {

                    showNotification(`Market research too large (${sizeCheck.sizeInMB}MB). Saved locally only.`, 'warning');
                } else {
                    const contentPreview = marketContent.substring(0, 200) + (marketContent.length > 200 ? '...' : '');






                    
                    await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                        market: marketContent,
                        'status.market': currentSpecData.status.market,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    

                    
                    // Reset chat since new content added to spec
                    autoResetChatOnSpecUpdate();
                    
                    // Trigger OpenAI upload (non-blocking)
                    triggerOpenAIUploadForSpec(currentSpecData.id).catch(err => {

                    });
                }
            } catch (error) {


                showNotification('Failed to save market research to database. Saved locally.', 'error');
            }
        }
        
        // Generate Design Spec third

        let designContent;
        try {
            designContent = await generateDesignSpec();

        } catch (error) {

            designContent = 'error';
        }
        
        // Update UI and Firebase for Design
        currentSpecData.design = designContent;
        currentSpecData.status.design = designContent === 'error' ? "error" : "ready";
        updateStatus('design', currentSpecData.status.design);
        updateTabLoadingState('design', false);
        
        // Enable Design tab when ready
        if (designContent !== 'error') {
            document.getElementById('designTab').disabled = false;
        }
        
        displayDesign(designContent);
        
        if (designContent !== 'error') {
            showNotification('Design specification created successfully', 'success');
        }
        
        if (user && currentSpecData && currentSpecData.id) {
            try {
                // Check content size before updating
                const sizeCheck = checkContentSize(designContent, 'Design');
                
                if (sizeCheck.tooLarge) {

                    showNotification(`Design spec too large (${sizeCheck.sizeInMB}MB). Saved locally only.`, 'warning');
                } else {
                    const contentPreview = designContent.substring(0, 200) + (designContent.length > 200 ? '...' : '');






                    
                    await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                        design: designContent,
                        'status.design': currentSpecData.status.design,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    

                    
                    // Reset chat since new content added to spec
                    autoResetChatOnSpecUpdate();
                    
                    // Trigger OpenAI upload (non-blocking)
                    triggerOpenAIUploadForSpec(currentSpecData.id).catch(err => {

                    });
                }
            } catch (error) {


                showNotification('Failed to save design spec to database. Saved locally.', 'error');
            }
        }
        
        // Update localStorage (for both authenticated and unauthenticated users)
        localStorage.setItem('generatedOverviewContent', currentSpecData.overview);
        localStorage.setItem('generatedTechnicalContent', technicalContent);
        localStorage.setItem('generatedMarketContent', marketContent);
        localStorage.setItem('generatedDesignContent', designContent);
        if (currentSpecData.id) {
            localStorage.setItem(`specBackup_${currentSpecData.id}`, JSON.stringify(currentSpecData));
        }
        
        hideApproveButton();
        
        // Enable Diagrams tab only if both technical and market are ready
        if (currentSpecData.status.technical === 'ready' && currentSpecData.status.market === 'ready') {
            document.getElementById('diagramsTab').disabled = false;
            const hasDiagrams = !!(currentSpecData.diagrams && Array.isArray(currentSpecData.diagrams.diagrams) && currentSpecData.diagrams.diagrams.length > 0);
            document.getElementById('generateDiagramsBtn').style.display = hasDiagrams ? 'none' : 'inline-block';
        }
        
        // Show success message
        if (technicalContent !== 'error' && marketContent !== 'error' && designContent !== 'error') {
            showNotification('All specifications generated successfully!', 'success');
        } else {
            showNotification('Some specifications failed to generate. You can retry using the retry buttons.', 'error');
        }
        

        
    } catch (error) {



        
        // Show error notification
        showNotification(`Error generating specifications: ${error.message}`, 'error');
        
        // Update status to error
        updateStatus('technical', 'error');
        updateStatus('market', 'error');
        updateStatus('design', 'error');
        
        // Remove loading animations
        updateTabLoadingState('technical', false);
        updateTabLoadingState('market', false);
        updateTabLoadingState('design', false);
        
        displayTechnical('error');
        displayMarket('error');
        displayDesign('error');
        
        hideApproveButton();
        
    } finally {
        isLoading = false;
        const approveBtn = document.getElementById('approveBtn');
        approveBtn.disabled = false;
        approveBtn.innerHTML = '<i class="fa fa-check"></i> Approve Overview';
    }
}

async function generateTechnicalSpec(retryCount = 0, maxRetries = 2) {

    
    // Use reference if spec has ID, otherwise fallback to full content
    const firstParam = currentSpecData.id ? currentSpecData.id : currentSpecData.overview;
    let prompt = PROMPTS.technical(firstParam, currentSpecData.answers);
    
    // If using reference (specId), replace it with actual overview content
    if (currentSpecData.id && currentSpecData.overview) {
        const referencePattern = /\[SPEC_REFERENCE\]\s+Spec ID: [^\n]+\s+Overview Location: [^\n]+\s+Note: [^\n]+\./s;
        if (prompt.includes('[SPEC_REFERENCE]')) {
            // Replace reference with actual overview content
            prompt = prompt.replace(referencePattern, `Application Overview:\n${currentSpecData.overview}`);

        }
    }
    
    const requestBody = {
        stage: 'technical',
        locale: 'en-US',
        temperature: 0,
        prompt: {
            system: 'You are a highly experienced software architect and lead developer. Generate a detailed technical specification.',
            developer: 'Create a comprehensive technical specification including data models, database schema, API design, security, and integration points.',
            user: prompt
        }
    };
    
    
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout (2 minutes)
    
    try {
        const response = await fetch('https://spspec.shalom-cohen-111.workers.dev/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        



        
        if (!response.ok) {
            const errorText = await response.text();

            throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const responseText = await response.text();
        
        const data = JSON.parse(responseText);

        
        const result = data.technical ? JSON.stringify(data.technical, null, 2) : 'No technical specification generated';
        
        return result;
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {

            
            // Auto-retry on timeout if we haven't exceeded max retries
            if (retryCount < maxRetries) {

                showNotification(`Technical API timeout, retrying... (${retryCount + 1}/${maxRetries})`, 'info');
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
                return await generateTechnicalSpec(retryCount + 1, maxRetries);
            } else {
                showNotification('Technical API timed out after multiple attempts. Please try again.', 'error');
                throw new Error('API call timed out after 120 seconds. Please try again.');
            }
        } else {

            throw error;
        }
    }
}

async function generateMarketSpec(retryCount = 0, maxRetries = 2) {

    
    // Use reference if spec has ID, otherwise fallback to full content
    const firstParam = currentSpecData.id ? currentSpecData.id : currentSpecData.overview;
    let prompt = PROMPTS.market(firstParam, currentSpecData.answers);
    
    // If using reference (specId), replace it with actual overview content
    if (currentSpecData.id && currentSpecData.overview) {
        const referencePattern = /\[SPEC_REFERENCE\]\s+Spec ID: [^\n]+\s+Overview Location: [^\n]+\s+Note: [^\n]+\./s;
        if (prompt.includes('[SPEC_REFERENCE]')) {
            // Replace reference with actual overview content
            prompt = prompt.replace(referencePattern, `Application Overview:\n${currentSpecData.overview}`);

        }
    }
    
    const requestBody = {
        stage: 'market',
        locale: 'en-US',
        temperature: 0,
        prompt: {
            system: 'You are a market research specialist and business analyst. Generate comprehensive market research insights.',
            developer: 'Create detailed market analysis including market overview, competitors analysis, target audience personas, and pricing strategy.',
            user: prompt
        }
    };
    
    
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout (2 minutes)
    
    try {
        const response = await fetch('https://spspec.shalom-cohen-111.workers.dev/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        



        
        if (!response.ok) {
            const errorText = await response.text();

            throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const responseText = await response.text();
        
        const data = JSON.parse(responseText);

        
        const result = data.market ? JSON.stringify(data.market, null, 2) : 'No market research generated';
        
        return result;
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {

            
            // Auto-retry on timeout if we haven't exceeded max retries
            if (retryCount < maxRetries) {

                showNotification(`Market API timeout, retrying... (${retryCount + 1}/${maxRetries})`, 'info');
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
                return await generateMarketSpec(retryCount + 1, maxRetries);
            } else {
                showNotification('Market API timed out after multiple attempts. Please try again.', 'error');
                throw new Error('API call timed out after 120 seconds. Please try again.');
            }
        } else {

            showNotification(`Market API error: ${error.message}`, 'error');
            throw error;
        }
    }
}

async function generateDesignSpec(retryCount = 0, maxRetries = 2) {

    
    // Use reference if spec has ID, otherwise fallback to full content
    const firstParam = currentSpecData.id ? currentSpecData.id : currentSpecData.overview;
    let prompt = PROMPTS.design(firstParam, currentSpecData.answers);
    
    // If using reference (specId), replace it with actual overview content
    if (currentSpecData.id && currentSpecData.overview) {
        const referencePattern = /\[SPEC_REFERENCE\]\s+Spec ID: [^\n]+\s+Overview Location: [^\n]+\s+Note: [^\n]+\./s;
        if (prompt.includes('[SPEC_REFERENCE]')) {
            // Replace reference with actual overview content
            prompt = prompt.replace(referencePattern, `Application Overview:\n${currentSpecData.overview}`);

        }
    }
    
    const requestBody = {
        stage: 'design',
        locale: 'en-US',
        temperature: 0,
        prompt: {
            system: 'You are a UX/UI design specialist and branding expert. Generate comprehensive design guidelines and branding elements.',
            developer: 'Create detailed design specifications including color schemes, typography, UI components, user experience guidelines, and branding elements.',
            user: prompt
        }
    };
    
    
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout (2 minutes)
    
    try {
        const response = await fetch('https://spspec.shalom-cohen-111.workers.dev/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        



        
        if (!response.ok) {
            const errorText = await response.text();

            throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const responseText = await response.text();
        
        const data = JSON.parse(responseText);

        
        const result = data.design ? JSON.stringify(data.design, null, 2) : 'No design specification generated';
        
        return result;
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {

            
            // Auto-retry on timeout if we haven't exceeded max retries
            if (retryCount < maxRetries) {

                showNotification(`Design API timeout, retrying... (${retryCount + 1}/${maxRetries})`, 'info');
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
                return await generateDesignSpec(retryCount + 1, maxRetries);
            } else {
                showNotification('Design API timed out after multiple attempts. Please try again.', 'error');
                throw new Error('API call timed out after 120 seconds. Please try again.');
            }
        } else {

            showNotification(`Design API error: ${error.message}`, 'error');
            throw error;
        }
    }
}

async function retryTechnical() {
    const maxRetries = 3;
    let retryCount = 0;
    
    while (retryCount < maxRetries) {
        try {
            document.getElementById('retryTechnicalBtn').disabled = true;
            document.getElementById('retryTechnicalBtn').textContent = ` Retrying... (${retryCount + 1}/${maxRetries})`;
            
            // Add loading animation
            updateTabLoadingState('technical', true);
            
            const technicalContent = await generateTechnicalSpec();
            
            // Update Firebase
            const user = firebase.auth().currentUser;
            if (user && currentSpecData) {
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    technical: technicalContent,
                    status: {
                        ...currentSpecData.status,
                        technical: "ready"
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Update local data
            currentSpecData.technical = technicalContent;
            currentSpecData.status.technical = "ready";
            
            // Update localStorage backup
            localStorage.setItem(`specBackup_${currentSpecData.id}`, JSON.stringify(currentSpecData));
            
            // Update UI
            updateStatus('technical', 'ready');
            updateTabLoadingState('technical', false);
            displayTechnical(technicalContent);
            document.getElementById('retryTechnicalBtn').style.display = 'none';
            
            showNotification('Technical specification generated successfully!', 'success');

            return;
            
        } catch (error) {
            retryCount++;

            
            if (retryCount >= maxRetries) {
                // Final failure
                document.getElementById('retryTechnicalBtn').disabled = false;
                document.getElementById('retryTechnicalBtn').textContent = 'Retry';
                updateTabLoadingState('technical', false);
                
                showNotification(`Failed to generate technical specification after ${maxRetries} attempts. ${error.message}`, 'error');
                updateStatus('technical', 'error');

                return;
            } else {
                // Wait before next retry
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
    }
}

async function retryMarket() {
    const maxRetries = 3;
    let retryCount = 0;
    
    while (retryCount < maxRetries) {
        try {
            document.getElementById('retryMarketBtn').disabled = true;
            document.getElementById('retryMarketBtn').textContent = ` Retrying... (${retryCount + 1}/${maxRetries})`;
            
            // Add loading animation
            updateTabLoadingState('market', true);
            
            const marketContent = await generateMarketSpec();
            
            // Update Firebase
            const user = firebase.auth().currentUser;
            if (user && currentSpecData) {
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    market: marketContent,
                    status: {
                        ...currentSpecData.status,
                        market: "ready"
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Update local data
            currentSpecData.market = marketContent;
            currentSpecData.status.market = "ready";
            
            // Update localStorage backup
            localStorage.setItem(`specBackup_${currentSpecData.id}`, JSON.stringify(currentSpecData));
            
            // Update UI
            updateStatus('market', 'ready');
            updateTabLoadingState('market', false);
            displayMarket(marketContent);
            document.getElementById('retryMarketBtn').style.display = 'none';
            
            showNotification('Market research generated successfully!', 'success');

            return;
            
        } catch (error) {
            retryCount++;

            
            if (retryCount >= maxRetries) {
                // Final failure
                document.getElementById('retryMarketBtn').disabled = false;
                document.getElementById('retryMarketBtn').textContent = 'Retry';
                updateTabLoadingState('market', false);
                
                showNotification(`Failed to generate market research after ${maxRetries} attempts. ${error.message}`, 'error');
                updateStatus('market', 'error');

                return;
            } else {
                // Wait before next retry
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
    }
}

async function retryDesign() {
    const maxRetries = 3;
    let retryCount = 0;
    
    while (retryCount < maxRetries) {
        try {
            document.getElementById('retryDesignBtn').disabled = true;
            document.getElementById('retryDesignBtn').textContent = ` Retrying... (${retryCount + 1}/${maxRetries})`;
            
            // Add loading animation
            updateTabLoadingState('design', true);
            
            const designContent = await generateDesignSpec();
            
            // Update Firebase
            const user = firebase.auth().currentUser;
            if (user && currentSpecData) {
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    design: designContent,
                    'status.design': 'ready',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Update local data
            currentSpecData.design = designContent;
            currentSpecData.status.design = "ready";
            
            // Update localStorage backup
            localStorage.setItem(`specBackup_${currentSpecData.id}`, JSON.stringify(currentSpecData));
            
            // Update UI
            updateStatus('design', 'ready');
            updateTabLoadingState('design', false);
            displayDesign(designContent);
            document.getElementById('retryDesignBtn').style.display = 'none';
            
            showNotification('Design specification generated successfully!', 'success');

            return;
            
        } catch (error) {
            retryCount++;

            
            if (retryCount >= maxRetries) {
                // Final failure
                document.getElementById('retryDesignBtn').disabled = false;
                document.getElementById('retryDesignBtn').textContent = 'Retry';
                updateTabLoadingState('design', false);
                
                showNotification(`Failed to generate design specification after ${maxRetries} attempts. ${error.message}`, 'error');
                updateStatus('design', 'error');

                return;
            } else {
                // Wait before next retry
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
    }
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('content').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
    document.getElementById('content').style.display = 'none';
}

function hideError() {
    document.getElementById('error').style.display = 'none';
}

function retryLoad() {
    if (urlSpecId) {
        loadSpec(urlSpecId);
    }
}

// Diagrams Functions

/**
 * Auto-repair broken diagrams (one time only per diagram)
 * This function sends broken diagrams for repair automatically in the background
 */
async function autoRepairBrokenDiagrams() {
    if (!currentSpecData || !currentSpecData.id) {

        return;
    }
    
    // Find broken diagrams that haven't been sent for auto-repair yet
    const brokenDiagrams = diagramsData.filter(diagram => 
        diagram._isValid === false && 
        !diagram._autoRepairSent &&
        diagram.mermaidCode && 
        typeof diagram.mermaidCode === 'string' && 
        diagram.mermaidCode.trim().length > 0
    );
    
    if (brokenDiagrams.length === 0) {
        return; // No broken diagrams to repair
    }
    

    
    // Send each broken diagram for repair in parallel (fire and forget)
    // We don't wait for completion to avoid blocking
    brokenDiagrams.forEach((diagram) => {
        // Mark as sent immediately to prevent duplicates
        diagram._autoRepairSent = true;
        
        // Update UI to show "Auto-repairing..." status
        const statusIndicator = document.querySelector(`#diagram-${diagram.id} .status-indicator`);
        const statusText = document.querySelector(`#diagram-${diagram.id} .status-text`);
        if (statusIndicator) statusIndicator.className = 'status-indicator repairing';
        if (statusText) statusText.textContent = 'Auto-repairing...';
        
        // Start repair process (don't await - run in background)
        (async () => {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {

                    return;
                }
                
                const token = await user.getIdToken();
                
                // Call repair endpoint
                const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/diagrams/repair`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        specId: currentSpecData.id,
                        diagramId: diagram.id,
                        brokenCode: diagram.mermaidCode,
                        diagramType: diagram.type,
                        errorMessage: diagram._lastError || ''
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to repair diagram');
                }
                
                const result = await response.json();
                
                if (result.repairedDiagram && result.repairedDiagram.mermaidCode) {
                    // Update the diagram data with repaired code
                    diagram.mermaidCode = result.repairedDiagram.mermaidCode;
                    
                    // Try to re-render the diagram to validate it works
                    await renderSingleDiagram(diagram, `diagram-${diagram.id}-content`, true);
                    
                    // Check if diagram is now valid
                    if (diagram._isValid === true) {
                        // Save to Firebase if diagram renders successfully
                        await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                            'diagrams.diagrams': diagramsData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        
                        // Update local data
                        if (currentSpecData.diagrams) {
                            currentSpecData.diagrams.diagrams = diagramsData;
                        }
                        
                        showNotification(`Diagram "${diagram.title}" auto-repaired successfully!`, 'success');
                    } else {
                        // Diagram still has errors even after repair
                        // Retry once more with error details if first attempt didn't work
                        if (!diagram._retryAttempted && diagram._lastError) {
                            diagram._retryAttempted = true;


                            
                            // Update UI to show retry status
                            const statusIndicator = document.querySelector(`#diagram-${diagram.id} .status-indicator`);
                            const statusText = document.querySelector(`#diagram-${diagram.id} .status-text`);
                            if (statusIndicator) statusIndicator.className = 'status-indicator repairing';
                            if (statusText) statusText.textContent = 'Retrying repair...';
                            
                            // Retry repair with error message
                            try {
                                const retryResponse = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/diagrams/repair`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        specId: currentSpecData.id,
                                        diagramId: diagram.id,
                                        brokenCode: diagram.mermaidCode,
                                        diagramType: diagram.type,
                                        errorMessage: diagram._lastError
                                    })
                                });
                                
                                if (retryResponse.ok) {
                                    const retryResult = await retryResponse.json();
                                    
                                    if (retryResult.repairedDiagram && retryResult.repairedDiagram.mermaidCode) {
                                        diagram.mermaidCode = retryResult.repairedDiagram.mermaidCode;
                                        await renderSingleDiagram(diagram, `diagram-${diagram.id}-content`, true);
                                        
                                        if (diagram._isValid === true) {
                                            await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                                                'diagrams.diagrams': diagramsData,
                                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                            });

                                            if (currentSpecData.diagrams) {
                                                currentSpecData.diagrams.diagrams = diagramsData;
                                            }
                                            showNotification(`Diagram "${diagram.title}" auto-repaired successfully after retry!`, 'success');
                                            return; // Success - exit early
                                        }
                                    }
                                }
                            } catch (retryError) {

                            }
                        }
                        
                        // If we get here, both attempts failed




                        const statusIndicator = document.querySelector(`#diagram-${diagram.id} .status-indicator`);
                        const statusText = document.querySelector(`#diagram-${diagram.id} .status-text`);
                        if (statusIndicator) statusIndicator.className = 'status-indicator error';
                        if (statusText) statusText.textContent = 'Repair failed';
                    }
                }
                
            } catch (error) {

                
                // Reset status
                const statusIndicator = document.querySelector(`#diagram-${diagram.id} .status-indicator`);
                const statusText = document.querySelector(`#diagram-${diagram.id} .status-text`);
                if (statusIndicator) statusIndicator.className = 'status-indicator error';
                if (statusText) statusText.textContent = 'Auto-repair failed';
                
                // Note: We don't reset _autoRepairSent so we don't retry automatically
                // User can manually repair if needed
            }
            
            // Save updated flags to Firebase (even if repair failed)
            try {
                await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                    'diagrams.diagrams': diagramsData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {

            }
        })();
    });
}

async function generateDiagrams() {
    if (isLoading) return;
    
    try {
        isLoading = true;
        const generateBtn = document.getElementById('generateDiagramsBtn');
        
        // Store original background color and styles
        const originalBgColor = window.getComputedStyle(generateBtn).backgroundColor;
        const originalClasses = generateBtn.className;
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating Diagrams...';
        
        // Keep the original background color and prevent it from changing (important to override any CSS)
        generateBtn.style.backgroundColor = originalBgColor || '';
        generateBtn.style.opacity = '1'; // Prevent opacity changes on disabled
        
        // Starting diagram generation...
        
        // Check if technical spec exists
        if (!currentSpecData.technical || currentSpecData.technical === 'error') {
            throw new Error('Technical specification must be generated first');
        }
        
        // Get Firebase auth token
        const user = firebase.auth().currentUser;
        if (!user) {
            throw new Error('User must be authenticated');
        }
        
        const token = await user.getIdToken();
        
        // Call new memory-based API endpoint - only send specId
        const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/diagrams/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                specId: currentSpecData.id
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to generate diagrams');
        }
        
        const result = await response.json();

        
        if (result.diagrams && Array.isArray(result.diagrams)) {
            // Store ALL diagrams data globally (including broken ones)
            diagramsData = result.diagrams;
            
            // Initialize flags for all diagrams
            diagramsData.forEach(diagram => {
                if (!diagram._autoRepairSent) {
                    diagram._autoRepairSent = false;
                }
            });
            
            // Display ALL diagrams first (to validate them)
            displayDiagrams(diagramsData);
            
            // Wait a bit for diagrams to render
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Count valid diagrams
            const validDiagramsCount = diagramsData.filter(d => d._isValid === true).length;
            

            
            // Save ALL diagrams to Firebase (including broken ones)
            if (currentSpecData && currentSpecData.id) {
                try {
                    await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                        diagrams: {
                            generated: true,
                            diagrams: diagramsData,
                            validatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        },
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Update local spec data immediately so UI reflects without refresh
                    currentSpecData.diagrams = { generated: true, diagrams: diagramsData };
                } catch (error) {

                }
            }
            
            // Send broken diagrams for auto-repair (one time only)
            autoRepairBrokenDiagrams();
            
            // Update status
            updateDiagramsStatus('ready');
            
            // Reset button before hiding (in case it's shown again)
            generateBtn.innerHTML = 'Generate Diagrams';
            generateBtn.style.backgroundColor = '';
            
            // Hide generate button
            generateBtn.style.display = 'none';
            
            // Show notification based on results
            if (validDiagramsCount === result.diagrams.length) {
                showNotification(`All ${result.diagrams.length} diagrams generated successfully!`, 'success');
            } else {
                showNotification(`${validDiagramsCount} out of ${result.diagrams.length} diagrams working. ${result.diagrams.length - validDiagramsCount} being auto-repaired.`, 'warning');
            }
            
        } else {
            throw new Error('Invalid response format: missing diagrams array');
        }
        
    } catch (error) {

        showNotification(`Failed to generate diagrams: ${error.message}`, 'error');
        
        // Reset button
        const generateBtn = document.getElementById('generateDiagramsBtn');
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Generate Diagrams';
        
        // Reset background color if it was changed
        generateBtn.style.backgroundColor = '';
    } finally {
        isLoading = false;
    }
}

function displayDiagrams(diagramsArray) {
    const container = document.getElementById('diagrams-data');
    
    if (!diagramsArray || diagramsArray.length === 0) {
        container.innerHTML = '<div class="diagram-error"><h3><i class="fa fa-times-circle"></i> No Diagrams Generated</h3><p>Failed to generate diagrams. Please try again.</p></div>';
        return;
    }
    
    // Validate diagrams - filter out any without valid mermaidCode
    const validDiagrams = diagramsArray.filter(d => 
        d && d.id && d.title && 
        d.mermaidCode && 
        typeof d.mermaidCode === 'string' && 
        d.mermaidCode.trim().length > 0
    );
    
    if (validDiagrams.length === 0) {
        container.innerHTML = '<div class="diagram-error"><h3><i class="fa fa-times-circle"></i> No Valid Diagrams</h3><p>No diagrams with valid content found. Please regenerate.</p></div>';
        return;
    }
    
    // Clear container
    container.innerHTML = '';
    
    // Create diagram containers for each VALID diagram
    validDiagrams.forEach((diagram, index) => {
        const diagramContainer = document.createElement('div');
        diagramContainer.className = 'diagram-container';
        diagramContainer.id = `diagram-${diagram.id}`;
        
        // Create header
        const header = document.createElement('div');
        header.className = 'diagram-header';
        header.innerHTML = `
            <h3>${diagram.title}</h3>
            <div class="diagram-controls">
                <button onclick="openFullscreen('${diagram.id}')" class="btn-icon" title="Fullscreen">
                    <i class="fa fa-expand"></i>
                </button>
                <button onclick="refreshDiagram('${diagram.id}')" class="btn-icon" title="Refresh" style="display: none;">
                    <i class="fa fa-refresh"></i>
                </button>
                <button onclick="repairDiagram('${diagram.id}')" class="btn-icon" title="Repair Diagram" style="display: none;">
                    <i class="fa fa-tools"></i>
                </button>
            </div>
        `;
        
        // Create content area
        const content = document.createElement('div');
        content.className = 'diagram-content';
        content.id = `diagram-${diagram.id}-content`;
        
        // Create status indicator
        const status = document.createElement('div');
        status.className = 'diagram-status';
        status.innerHTML = `
            <div class="status-indicator generating"></div>
            <span class="status-text">Generating...</span>
        `;
        
        content.appendChild(status);
        
        // Add loading placeholder
        content.innerHTML += '<div class="diagram-loading"> Rendering diagram...</div>';
        
        diagramContainer.appendChild(header);
        diagramContainer.appendChild(content);
        container.appendChild(diagramContainer);
        
        // Render diagram immediately
        renderSingleDiagram(diagram, `diagram-${diagram.id}-content`);
    });
}

/**
 * Check if Mermaid code has syntax errors (requires AI repair)
 * vs rendering errors (just needs re-render)
 */
function isSyntaxError(error) {
    if (!error || !error.message) return false;
    
    const errorMsg = error.message.toLowerCase();
    const syntaxErrorKeywords = [
        'syntax', 'parse', 'invalid', 'expecting', 'unexpected', 
        'missing', 'malformed', 'broken', 'error parsing',
        'syntax error', 'invalid character', 'unknown token'
    ];
    
    return syntaxErrorKeywords.some(keyword => errorMsg.includes(keyword));
}

async function renderSingleDiagram(diagramData, containerId, isRefresh = false) {
    const container = document.getElementById(containerId);
    if (!container) {

        return;
    }
    
    // Get parent element BEFORE clearing container
    const parentElement = container.parentElement;
    const statusIndicator = parentElement?.querySelector('.status-indicator');
    const statusText = parentElement?.querySelector('.status-text');

    try {
        // Validate Mermaid code before rendering
        if (!diagramData.mermaidCode || typeof diagramData.mermaidCode !== 'string' || diagramData.mermaidCode.trim().length === 0) {
            throw new Error('Invalid or empty Mermaid code');
        }

        // Clear loading state
        container.innerHTML = '';

        // Create Mermaid element
        const mermaidElement = document.createElement('div');
        mermaidElement.className = 'mermaid';
        mermaidElement.id = `mermaid-${diagramData.id}`;
        mermaidElement.textContent = diagramData.mermaidCode;
        container.appendChild(mermaidElement);

        // Initialize Mermaid
        if (typeof mermaid !== 'undefined') {
            try {
                // Use mermaid.render() for specific element (more reliable than mermaid.run())
                const uniqueId = `mermaid-render-${diagramData.id}-${Date.now()}`;
                const { svg } = await mermaid.render(uniqueId, diagramData.mermaidCode);
                
                // Replace the mermaid element with the rendered SVG
                mermaidElement.innerHTML = svg;
                mermaidElement.className = 'mermaid-rendered';
                
                if (statusIndicator) statusIndicator.className = 'status-indicator ready';
                if (statusText) statusText.textContent = 'Ready';

                
                // Hide repair and refresh buttons when diagram is working
                hideDiagramControls(diagramData.id);
                
                // Mark diagram as valid in memory
                diagramData._isValid = true;
                diagramData._lastRenderAttempt = Date.now();
                
            } catch (initError) {

                
                // Store error info for debugging
                diagramData._lastError = initError.message;
                diagramData._isValid = false;
                
                throw initError;
            }
        } else {
            // Fallback: show raw code if Mermaid not available
            container.innerHTML = `<pre style="background: #f8f9fa; padding: 20px; border-radius: 4px; overflow-x: auto;">${diagramData.mermaidCode}</pre>`;
            if (statusIndicator) statusIndicator.className = 'status-indicator ready';
            if (statusText) statusText.textContent = 'Ready (Raw)';

            
            // Mark as valid (displayed as text)
            diagramData._isValid = true;
        }

    } catch (error) {

        if (statusIndicator) statusIndicator.className = 'status-indicator error';
        if (statusText) statusText.textContent = 'Error';
        
        // System automatically repairs broken diagrams - no manual buttons needed
        // Removed showDiagramControls call - system handles auto-repair
        
        // Determine if this is a syntax error (needs AI repair) or rendering error (just needs retry)
        const needsAIRepair = isSyntaxError(error);
        
        const errorUI = `
            <div class="diagram-error">
                <h4><i class="fa fa-exclamation-triangle"></i> ${needsAIRepair ? 'Syntax Error' : 'Rendering Error'}</h4>
                <p>${needsAIRepair ? 'Diagram has syntax errors. The system is automatically repairing this diagram...' : 'Failed to render diagram: ' + error.message + '. The system is automatically retrying...'}</p>
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #666;">Show Mermaid code</summary>
                    <pre style="background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 12px;">${diagramData.mermaidCode}</pre>
                </details>
            </div>
        `;
        
        container.innerHTML = errorUI;
    }
}

function openFullscreen(diagramId) {
    const diagramData = diagramsData.find(d => d.id === diagramId);
    if (!diagramData) return;
    
    const modal = document.getElementById('fullscreenModal');
    const title = document.getElementById('fullscreenTitle');
    const content = document.getElementById('fullscreenContent');
    
    title.textContent = diagramData.title;
    
    // Clear content initially
    content.innerHTML = '<div class="diagram-loading">Loading...</div>';
    
    // Re-render Mermaid in fullscreen
    if (typeof mermaid !== 'undefined') {
        // Render the diagram for fullscreen using mermaid.render()
        const uniqueId = `mermaid-fullscreen-${diagramId}-${Date.now()}`;
        mermaid.render(uniqueId, diagramData.mermaidCode)
            .then(({ svg }) => {
                // Replace content with rendered SVG
                content.innerHTML = `<div class="mermaid-fullscreen">${svg}</div>`;
                // Apply transform after rendering
                updateTransform();
            })
            .catch(error => {

                // Try MermaidManager as fallback
                if (mermaidManager && mermaidManager.isInitialized) {
                    mermaidManager.renderChart(`${uniqueId}-fallback`, diagramData.mermaidCode).catch(managerError => {

                        content.innerHTML = `<pre style="color: white; padding: 20px;">${diagramData.mermaidCode}</pre>`;
                    });
                } else {
                    content.innerHTML = `<pre style="color: white; padding: 20px;">${diagramData.mermaidCode}</pre>`;
                }
            });
    } else if (mermaidManager && mermaidManager.isInitialized) {
        // Try MermaidManager if mermaid not available
        const uniqueId = `mermaid-fullscreen-${diagramId}-${Date.now()}`;
        mermaidManager.renderChart(uniqueId, diagramData.mermaidCode).catch(error => {

            content.innerHTML = `<pre style="color: white; padding: 20px;">${diagramData.mermaidCode}</pre>`;
        });
    }
    
    // Reset zoom and pan
    currentZoom = 1;
    currentPanX = 0;
    currentPanY = 0;
    updateTransform();
    
    // Show modal
    modal.style.display = 'flex';
    
    // Remove any existing listeners first to avoid duplicates
    document.removeEventListener('keydown', handleEscKey);
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    
    // Add ESC key listener
    document.addEventListener('keydown', handleEscKey);
    
    // Add mouse event listeners for panning on the whole content area
    content.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Set initial transform
    content.style.transformOrigin = 'center center';
    content.style.transform = `translate(${currentPanX}px, ${currentPanY}px) scale(${currentZoom})`;
    

}

function closeFullscreen() {

    const modal = document.getElementById('fullscreenModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Remove event listeners
    document.removeEventListener('keydown', handleEscKey);
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    
    // Reset zoom and pan
    currentZoom = 1;
    currentPanX = 0;
    currentPanY = 0;
    
    // Reset dragging state
    isDragging = false;
    
    // Clean up content
    const content = document.getElementById('fullscreenContent');
    if (content) {
        content.innerHTML = '';
    }
}

function handleEscKey(event) {
    if (event.key === 'Escape') {
        closeFullscreen();
    }
}

function handleMouseDown(event) {
    // Allow dragging on the fullscreen content area or mermaid diagrams
    const content = document.getElementById('fullscreenContent');
    if (content && (event.target.closest('.mermaid') || event.target.closest('.mermaid-rendered') || event.target.closest('.mermaid-fullscreen') || content.contains(event.target))) {
        isDragging = true;
        dragStartX = event.clientX - currentPanX;
        dragStartY = event.clientY - currentPanY;
        event.preventDefault();
    }
}

function handleMouseMove(event) {
    if (isDragging) {
        currentPanX = event.clientX - dragStartX;
        currentPanY = event.clientY - dragStartY;
        updateTransform();
    }
}

function handleMouseUp() {
    isDragging = false;
}

function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 3);
    updateTransform();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.5);
    updateTransform();
}

function resetZoom() {
    currentZoom = 1;
    currentPanX = 0;
    currentPanY = 0;
    updateTransform();
}

function updateTransform() {
    const content = document.getElementById('fullscreenContent');
    if (content) {
        content.style.transform = `translate(${currentPanX}px, ${currentPanY}px) scale(${currentZoom})`;
        content.style.transformOrigin = 'center center';
    }
}

/**
 * Hide repair and refresh buttons when diagram is working
 */
function hideDiagramControls(diagramId) {
    const controls = document.querySelector(`#diagram-${diagramId} .diagram-controls`);
    if (controls) {
        const refreshBtn = controls.querySelector('button[onclick*="refreshDiagram"]');
        const repairBtn = controls.querySelector('button[onclick*="repairDiagram"]');
        
        if (refreshBtn) refreshBtn.style.display = 'none';
        if (repairBtn) repairBtn.style.display = 'none';
    }
}

/**
 * Show repair and refresh buttons when there's an error
 */
function showDiagramControls(diagramId, error) {
    const controls = document.querySelector(`#diagram-${diagramId} .diagram-controls`);
    if (controls) {
        const refreshBtn = controls.querySelector('button[onclick*="refreshDiagram"]');
        const repairBtn = controls.querySelector('button[onclick*="repairDiagram"]');
        
        const needsAIRepair = isSyntaxError(error);
        
        // Always show refresh button for errors
        if (refreshBtn) {
            refreshBtn.style.display = 'flex';
        }
        
        // Show repair button only for syntax errors
        if (repairBtn) {
            repairBtn.style.display = needsAIRepair ? 'flex' : 'none';
        }
    }
}

async function refreshDiagram(diagramId) {
    const diagramData = diagramsData.find(d => d.id === diagramId);
    if (!diagramData) return;
    
    const statusIndicator = document.querySelector(`#diagram-${diagramId} .status-indicator`);
    const statusText = document.querySelector(`#diagram-${diagramId} .status-text`);
    
    if (statusIndicator) {
        statusIndicator.className = 'status-indicator refreshing';
    }
    if (statusText) {
        statusText.textContent = 'Refreshing...';
    }
    
    try {
        await renderSingleDiagram(diagramData, `diagram-${diagramId}-content`, true);

    } catch (error) {

    }
}

/**
 * Repair a broken diagram using AI
 */
async function repairDiagram(diagramId) {
    const diagramData = diagramsData.find(d => d.id === diagramId);
    if (!diagramData) return;
    
    const statusIndicator = document.querySelector(`#diagram-${diagramId} .status-indicator`);
    const statusText = document.querySelector(`#diagram-${diagramId} .status-text`);
    
    if (statusIndicator) {
        statusIndicator.className = 'status-indicator repairing';
    }
    if (statusText) {
        statusText.textContent = 'Repairing...';
    }
    
    try {
        // Get user authentication
        const user = firebase.auth().currentUser;
        if (!user) {
            throw new Error('Please log in to use repair');
        }
        
        const token = await user.getIdToken();
        
        // Call Assistant API repair endpoint
        const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/diagrams/repair`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                specId: currentSpecData?.id,
                diagramId: diagramId,
                brokenCode: diagramData.mermaidCode,
                diagramType: diagramData.type,
                errorMessage: diagramData._lastError || ''
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to repair diagram');
        }
        
        const result = await response.json();
        
        if (result.repairedDiagram && result.repairedDiagram.mermaidCode) {
            // Update the diagram data with repaired code
            diagramData.mermaidCode = result.repairedDiagram.mermaidCode;
            
            // Try to re-render the diagram to validate it works
            try {
                await renderSingleDiagram(diagramData, `diagram-${diagramId}-content`, true);
                
                // Check if diagram is now valid before saving to Firebase
                if (diagramData._isValid === true) {
                    // Save to Firebase only if diagram renders successfully
                    if (currentSpecData && currentSpecData.id) {
                        await firebase.firestore().collection('specs').doc(currentSpecData.id).update({
                            'diagrams.diagrams': diagramsData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        
                        // Update local spec data immediately
                        if (currentSpecData.diagrams) {
                            currentSpecData.diagrams.diagrams = diagramsData;
                        }
                    }
                    
                    if (statusIndicator) statusIndicator.className = 'status-indicator ready';
                    if (statusText) statusText.textContent = 'Repaired';
                    
                    showNotification('Diagram repaired and saved successfully!', 'success');
                } else {
                    // Diagram still has errors even after repair

                    
                    if (statusIndicator) statusIndicator.className = 'status-indicator error';
                    if (statusText) statusText.textContent = 'Still has errors';
                    
                    showNotification('Diagram repaired but still has rendering issues. Try again.', 'warning');
                }
                
            } catch (renderError) {

                
                if (statusIndicator) statusIndicator.className = 'status-indicator error';
                if (statusText) statusText.textContent = 'Repair failed';
                
                showNotification('Failed to render repaired diagram: ' + renderError.message, 'error');
            }
        } else {
            throw new Error('No repaired diagram code received');
        }
        
    } catch (error) {

        
        if (statusIndicator) statusIndicator.className = 'status-indicator error';
        if (statusText) statusText.textContent = 'Repair failed';
        
        showNotification(`Failed to repair diagram: ${error.message}`, 'error');
    }
}

function updateDiagramsStatus(status) {
    const statusElement = document.getElementById('diagramsStatus');
    if (statusElement) {
        statusElement.textContent = status === 'ready' ? 'Ready' : 'Pending';
        statusElement.className = `status-value ${status}`;
    }
}


</script>
    </main>
    
    <!-- Footer -->
    <!-- Footer -->
<footer>
  <div class="footer-content">
    <div class="footer-links">
      <a href="/pages/how.html" aria-label="Learn how specifys.ai works">How It Works</a>
      <a href="/pages/about.html" aria-label="Learn more about specifys.ai">About Us</a>
      <a href="/blog/" aria-label="Visit our blog">Blog</a>
      <a href="/tools/map/vibe-coding-tools-map.html" aria-label="Explore Vibe Coding Tools Map">Vibe Coding Tools Map</a>
      <a href="/pages/ToolPicker.html" aria-label="Use our Tool Finder">Tool Finder</a>
    </div>
    <span class="footer-divider">|</span>
    <div class="footer-social">
      <a href="https://www.linkedin.com/company/specifys-ai/" target="_blank" aria-label="Follow us on LinkedIn">
        <i class="fab fa-linkedin-in"></i>
      </a>
      <a href="https://www.facebook.com/profile.php?id=61576402600129&locale=he_IL" target="_blank" aria-label="Follow us on Facebook">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="mailto:specifysai@gmail.com" aria-label="Send us an email">
        <i class="fas fa-envelope"></i>
      </a>
      <a href="https://www.producthunt.com/products/specifys-ai" target="_blank" aria-label="Check us out on Product Hunt">
        <i class="fab fa-product-hunt"></i>
      </a>
    </div>
  </div>
  <div class="footer-copyright">
     2025 specifys.ai. All rights reserved. <span class="footer-version">v1.2.4</span>
  </div>
</footer>

    
    <!-- Scroll to top button -->
<button class="icon-btn scroll-to-top" id="scrollToTop" aria-label="Scroll">
  <i class="fas fa-arrow-up"></i>
</button>

<script>
  // Scroll button functionality
  document.addEventListener('DOMContentLoaded', function() {
    const scrollBtn = document.getElementById('scrollToTop');
    
    if (scrollBtn) {
      // Handle click - scroll to top or bottom based on current state
      scrollBtn.addEventListener("click", () => {
        if (window.scrollY > 300) {
          // If scrolled down, go to top
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          // If at top, scroll to bottom
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        }
      });
      
      // Rotate button based on scroll position
      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) {
          scrollBtn.classList.add("scrolled-down");
          scrollBtn.setAttribute("aria-label", "Scroll to top");
        } else {
          scrollBtn.classList.remove("scrolled-down");
          scrollBtn.setAttribute("aria-label", "Scroll to bottom");
        }
      });
    }
  });
</script>


    
    <!-- Firebase SDK & Auth -->
    
    <!-- API Configuration - Must load before all API calls -->
    <script src="/assets/js/config.js"></script>
    
    <!-- Entitlements Cache -->
    <script src="/assets/js/entitlements-cache.js"></script>
    
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB9hr0IWM4EREzkKDxBxYoYinV6LJXWXV4",
    authDomain: "specify-ai.firebaseapp.com",
    projectId: "specify-ai",
    storageBucket: "specify-ai.firebasestorage.app",
    messagingSenderId: "734278787482",
    appId: "1:734278787482:web:0e312fb6f197e849695a23",
    measurementId: "G-4YR9LK63MR"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>


    <script>
  // Auth UI functions
  function updateAuthUI(user) {
    const authButtons = document.getElementById('auth-buttons');
    if (!authButtons) return;
    
    if (user) {
      // User is logged in
      const displayName = user.displayName || user.email.split('@')[0];
      const firstLetter = displayName.charAt(0).toUpperCase();
      
      authButtons.innerHTML = `
        <a href="/pages/profile.html" class="user-info" style="text-decoration: none;">
          <div class="user-avatar">${firstLetter}</div>
          <span>${displayName}</span>
        </a>
      `;
    } else {
      // User is not logged in
      authButtons.innerHTML = `
        <button class="auth-btn" onclick="showLoginModal()">Login</button>
      `;
    }
  }

  // Global auth functions
  window.showLoginModal = function() {
    if (typeof trackButtonClick !== 'undefined') {
      trackButtonClick('Show Login', 'Authentication', 'header');
    }
    window.location.href = '/pages/auth.html';
  };

  window.showRegisterModal = function() {
    if (typeof trackButtonClick !== 'undefined') {
      trackButtonClick('Show Register', 'Authentication', 'header');
    }
    window.location.href = '/pages/auth.html';
  };

  window.logout = function() {
    if (typeof trackAuthEvent !== 'undefined') {
      trackAuthEvent('logout', 'email');
    }
    auth.signOut()
      .then(() => {

      })
      .catch(error => {

      });
  };

  // Listen to auth state changes
  auth.onAuthStateChanged((user) => {
    updateAuthUI(user);
  });

  // Initialize auth buttons with default state
  document.addEventListener('DOMContentLoaded', function() {
    const authButtons = document.getElementById('auth-buttons');
    if (authButtons && !authButtons.innerHTML.trim()) {
      authButtons.innerHTML = `
        <button class="auth-btn login-btn">Login</button>
      `;
      
      const loginBtn = authButtons.querySelector('.login-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          window.location.href = '/pages/auth.html';
        });
      }
    }
    
    // Font Awesome icons initialization completed
  });
</script>


    
    
    <!-- Extra JavaScript -->
    
    <!-- Color Visualization Modal -->
    <div id="color-visualizer-modal" class="viz-modal">
        <div class="viz-modal-content">
            <div class="viz-header">
                <h3 id="viz-title">Mobile App Preview</h3>
                <button class="viz-close" onclick="closeVisualizer()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="viz-body">
                <div id="mobile-template" class="template-container">
                    <div class="mobile-mockup">
                        <div class="mobile-screen">
                            <!-- Header with search, notifications, profile -->
                            <div class="mobile-header" style="background: var(--primary-color); display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                                <div style="color: white; font-weight: bold; font-family: var(--heading-font);">AppHub</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div style="color: white; font-size: 18px;"></div>
                                    <div style="position: relative; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
                                        <span style="position: absolute; top: -4px; right: -4px; background: var(--accent-color); color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-family: var(--body-font);">3</span>
                                    </div>
                                    <div style="background: var(--background-color); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-weight: bold; font-family: var(--heading-font);">JD</div>
                                </div>
                            </div>
                            
                            <!-- Hero Section -->
                            <div style="background: var(--secondary-color); padding: 32px 20px; text-align: center;">
                                <h2 style="color: var(--text-color); font-family: var(--heading-font); font-size: 24px; margin-bottom: 8px;">Dashboard Overview</h2>
                                <p style="color: var(--text-color); font-family: var(--body-font); font-size: 14px; margin-bottom: 20px; opacity: 0.8;">Manage your projects efficiently</p>
                                <button style="background: var(--accent-color); color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; font-family: var(--body-font); font-size: 14px;">New Project</button>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div style="background: var(--background-color); padding: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="background: white; border-radius: 8px; padding: 12px 8px; text-align: center; border: 1px solid var(--primary-color);">
                                        <div style="font-size: 18px; font-weight: bold; color: var(--primary-color); font-family: var(--heading-font);">1.2K</div>
                                        <div style="font-size: 10px; color: var(--text-color); font-family: var(--caption-font); margin-top: 4px;">Users</div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px 8px; text-align: center; border: 1px solid var(--accent-color);">
                                        <div style="font-size: 18px; font-weight: bold; color: var(--accent-color); font-family: var(--heading-font);">98%</div>
                                        <div style="font-size: 10px; color: var(--text-color); font-family: var(--caption-font); margin-top: 4px;">Uptime</div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px 8px; text-align: center; border: 1px solid var(--secondary-color);">
                                        <div style="font-size: 18px; font-weight: bold; color: var(--secondary-color); font-family: var(--heading-font);">+15%</div>
                                        <div style="font-size: 10px; color: var(--text-color); font-family: var(--caption-font); margin-top: 4px;">Growth</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Features List -->
                            <div style="background: var(--background-color); padding: 0 20px 16px;">
                                <div style="display: grid; gap: 12px;">
                                    <div style="background: white; border-radius: 8px; padding: 16px; border-left: 3px solid var(--primary-color);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--primary-color); opacity: 0.2; display: flex; align-items: center; justify-content: center; font-size: 20px;"></div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--primary-color); font-family: var(--heading-font); font-size: 14px;">Analytics</div>
                                                <div style="font-size: 12px; color: var(--text-color); font-family: var(--body-font); opacity: 0.7;">Track performance metrics</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 16px; border-left: 3px solid var(--accent-color);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--accent-color); opacity: 0.2; display: flex; align-items: center; justify-content: center; font-size: 20px;"></div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--accent-color); font-family: var(--heading-font); font-size: 14px;">Security</div>
                                                <div style="font-size: 12px; color: var(--text-color); font-family: var(--body-font); opacity: 0.7;">Enterprise-grade protection</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 16px; border-left: 3px solid var(--secondary-color);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--secondary-color); opacity: 0.2; display: flex; align-items: center; justify-content: center; font-size: 20px;"></div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--secondary-color); font-family: var(--heading-font); font-size: 14px;">Fast Sync</div>
                                                <div style="font-size: 12px; color: var(--text-color); font-family: var(--body-font); opacity: 0.7;">Real-time updates</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Table -->
                            <div style="background: var(--background-color); padding: 0 20px 16px;">
                                <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0;">
                                    <div style="background: var(--primary-color); color: white; padding: 12px 16px; font-weight: 600; font-family: var(--heading-font); font-size: 13px;">Recent Activity</div>
                                    <div style="padding: 8px 0;">
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 8px 16px; border-bottom: 1px solid #f0f0f0; font-size: 11px;">
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Project A</div>
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Active</div>
                                            <div style="color: var(--primary-color); font-family: var(--caption-font);">$1.2K</div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 8px 16px; border-bottom: 1px solid #f0f0f0; font-size: 11px;">
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Project B</div>
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Pending</div>
                                            <div style="color: var(--accent-color); font-family: var(--caption-font);">$800</div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 8px 16px; font-size: 11px;">
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Project C</div>
                                            <div style="color: var(--text-color); font-family: var(--body-font);">Active</div>
                                            <div style="color: var(--secondary-color); font-family: var(--caption-font);">$2.1K</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Analytics Chart -->
                            <div style="background: var(--background-color); padding: 0 20px 20px;">
                                <div style="background: white; border-radius: 8px; padding: 16px; border: 1px solid #e0e0e0;">
                                    <div style="color: var(--primary-color); font-family: var(--heading-font); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Monthly Growth</div>
                                    <div style="display: flex; align-items: end; gap: 6px; height: 80px; justify-content: center;">
                                        <div style="background: var(--primary-color); height: 65%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--secondary-color); height: 80%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--accent-color); height: 50%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--primary-color); height: 75%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--secondary-color); height: 60%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--accent-color); height: 90%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--primary-color); height: 55%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: var(--secondary-color); height: 70%; width: 22px; border-radius: 4px 4px 0 0;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="web-template" class="template-container">
                    <div class="web-mockup">
                        <div class="web-screen">
                            <!-- Navigation Bar -->
                            <nav style="background: var(--primary-color); padding: 14px 30px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="color: white; font-size: 20px; font-weight: bold; font-family: var(--heading-font);">AppHub</div>
                                <div style="display: flex; align-items: center; gap: 24px;">
                                    <div style="color: white; font-size: 14px; font-family: var(--body-font); cursor: pointer;">Home</div>
                                    <div style="color: white; font-size: 14px; font-family: var(--body-font); cursor: pointer;">Dashboard</div>
                                    <div style="color: white; font-size: 14px; font-family: var(--body-font); cursor: pointer;">Reports</div>
                                    <div style="position: relative; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 6px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <span style="color: white; font-size: 14px; font-family: var(--body-font); opacity: 0.8;"> Search</span>
                                    </div>
                                    <div style="position: relative; width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                        <span style="position: absolute; top: -6px; right: -6px; background: var(--accent-color); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; font-family: var(--body-font);">5</span>
                                    </div>
                                    <div style="background: var(--background-color); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-weight: bold; cursor: pointer; font-family: var(--heading-font);">JD</div>
                                </div>
                            </nav>
                            
                            <!-- Hero Section -->
                            <section style="background: var(--secondary-color); padding: 60px 40px; text-align: center;">
                                <h1 style="color: var(--text-color); font-family: var(--heading-font); font-size: 36px; font-weight: bold; margin-bottom: 16px;">Welcome to Dashboard</h1>
                                <p style="color: var(--text-color); font-family: var(--body-font); font-size: 16px; margin-bottom: 28px; opacity: 0.85;">Manage your business operations from one place</p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button style="background: var(--accent-color); color: white; border: none; padding: 12px 28px; border-radius: 6px; font-weight: 600; font-family: var(--body-font); font-size: 14px; cursor: pointer;">Get Started</button>
                                    <button style="background: white; color: var(--primary-color); border: 2px solid var(--primary-color); padding: 12px 28px; border-radius: 6px; font-weight: 600; font-family: var(--body-font); font-size: 14px; cursor: pointer;">Learn More</button>
                                </div>
                            </section>
                            
                            <!-- Stats Row -->
                            <section style="background: var(--background-color); padding: 30px 40px;">
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--primary-color); text-align: center;">
                                        <div style="font-size: 32px; font-weight: bold; color: var(--primary-color); font-family: var(--heading-font); margin-bottom: 8px;">10K+</div>
                                        <div style="font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Active Users</div>
                                    </div>
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--accent-color); text-align: center;">
                                        <div style="font-size: 32px; font-weight: bold; color: var(--accent-color); font-family: var(--heading-font); margin-bottom: 8px;">$24K</div>
                                        <div style="font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Revenue</div>
                                    </div>
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--secondary-color); text-align: center;">
                                        <div style="font-size: 32px; font-weight: bold; color: var(--secondary-color); font-family: var(--heading-font); margin-bottom: 8px;">156</div>
                                        <div style="font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Projects</div>
                                    </div>
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--primary-color); text-align: center;">
                                        <div style="font-size: 32px; font-weight: bold; color: var(--primary-color); font-family: var(--heading-font); margin-bottom: 8px;">98%</div>
                                        <div style="font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Uptime</div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Content & Table Section -->
                            <section style="background: var(--background-color); padding: 0 40px 30px;">
                                <div style="display: grid; grid-template-columns: 2fr 3fr; gap: 24px;">
                                    <!-- Left: Feature Card -->
                                    <div style="background: white; border-radius: 8px; padding: 24px; border: 1px solid #e0e0e0;">
                                        <div style="width: 50px; height: 50px; border-radius: 10px; background: var(--primary-color); opacity: 0.15; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 16px;"></div>
                                        <h3 style="color: var(--primary-color); font-family: var(--heading-font); font-size: 18px; margin-bottom: 8px;">Advanced Analytics</h3>
                                        <p style="color: var(--text-color); font-family: var(--body-font); font-size: 14px; line-height: 1.6; opacity: 0.8;">Track your performance metrics in real-time with comprehensive dashboards and detailed reports.</p>
                                        <button style="margin-top: 16px; background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; font-family: var(--body-font); cursor: pointer;">View Details</button>
                                    </div>
                                    
                                    <!-- Right: Data Table -->
                                    <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0;">
                                        <div style="background: var(--primary-color); color: white; padding: 16px 20px; font-weight: 600; font-family: var(--heading-font); font-size: 15px;">Recent Activity</div>
                                        <div style="padding: 16px 0;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                                        <th style="padding: 10px 20px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-color); font-family: var(--body-font);">Project</th>
                                                        <th style="padding: 10px 20px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-color); font-family: var(--body-font);">Status</th>
                                                        <th style="padding: 10px 20px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-color); font-family: var(--body-font);">Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr style="border-bottom: 1px solid #f5f5f5;">
                                                        <td style="padding: 12px 20px; font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Website Redesign</td>
                                                        <td style="padding: 12px 20px;"><span style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-family: var(--caption-font);">Active</span></td>
                                                        <td style="padding: 12px 20px; text-align: right; font-weight: 600; color: var(--primary-color); font-family: var(--caption-font);">$12.5K</td>
                                                    </tr>
                                                    <tr style="border-bottom: 1px solid #f5f5f5;">
                                                        <td style="padding: 12px 20px; font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Mobile App</td>
                                                        <td style="padding: 12px 20px;"><span style="background: var(--accent-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-family: var(--caption-font);">Pending</span></td>
                                                        <td style="padding: 12px 20px; text-align: right; font-weight: 600; color: var(--accent-color); font-family: var(--caption-font);">$8.2K</td>
                                                    </tr>
                                                    <tr style="border-bottom: 1px solid #f5f5f5;">
                                                        <td style="padding: 12px 20px; font-size: 13px; color: var(--text-color); font-family: var(--body-font);">Dashboard</td>
                                                        <td style="padding: 12px 20px;"><span style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-family: var(--caption-font);">Active</span></td>
                                                        <td style="padding: 12px 20px; text-align: right; font-weight: 600; color: var(--primary-color); font-family: var(--caption-font);">$3.8K</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding: 12px 20px; font-size: 13px; color: var(--text-color); font-family: var(--body-font);">API Integration</td>
                                                        <td style="padding: 12px 20px;"><span style="background: var(--secondary-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-family: var(--caption-font);">Complete</span></td>
                                                        <td style="padding: 12px 20px; text-align: right; font-weight: 600; color: var(--secondary-color); font-family: var(--caption-font);">$5.4K</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Analytics Chart -->
                            <section style="background: var(--background-color); padding: 0 40px 40px;">
                                <div style="background: white; border-radius: 8px; padding: 30px; border: 1px solid #e0e0e0;">
                                    <h3 style="color: var(--primary-color); font-family: var(--heading-font); font-size: 18px; margin-bottom: 20px;">Revenue Analytics</h3>
                                    <div style="display: flex; align-items: end; gap: 12px; height: 140px; margin-bottom: 16px; padding: 0 20px;">
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--primary-color); height: 65%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">Jan</div>
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--secondary-color); height: 80%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">Feb</div>
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--accent-color); height: 50%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">Mar</div>
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--primary-color); height: 75%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">Apr</div>
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--secondary-color); height: 60%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">May</div>
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                            <div style="width: 100%; max-width: 50px; background: var(--accent-color); height: 95%; border-radius: 4px 4px 0 0;"></div>
                                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-color); font-family: var(--caption-font);">Jun</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 24px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%;"></div>
                                            <span style="font-size: 12px; color: var(--text-color); font-family: var(--caption-font);">Q1</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; background: var(--secondary-color); border-radius: 50%;"></div>
                                            <span style="font-size: 12px; color: var(--text-color); font-family: var(--caption-font);">Q2</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; background: var(--accent-color); border-radius: 50%;"></div>
                                            <span style="font-size: 12px; color: var(--text-color); font-family: var(--caption-font);">Revenue</span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Footer -->
                            <footer style="background: var(--primary-color); padding: 20px 40px; color: white; font-size: 13px; font-family: var(--caption-font); text-align: center;"> 2024 AppHub Dashboard. All rights reserved.</footer>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Credits Display Script -->
    <script src="/assets/js/credits-display.js"></script>

<!-- Chat functionality - Add before closing </script> tag -->
<script>
// Chat functionality
let chatThreadId = null;
let chatAssistantId = null;
let chatHistory = [];
let chatInitialized = false;

// Enable chat tab after overview approval
function enableChatTab() {
    const chatTab = document.getElementById('chatTab');
    if (chatTab) {
        chatTab.disabled = false;
    }
}

/**
 * Initialize chat when tab is opened
 */
async function initializeChat() {
    if (chatInitialized) {
        return; // Already initialized
    }
    
    try {
        // Don't show loading for init - it's too fast
        const user = firebase.auth().currentUser;
        if (!user) {
            throw new Error('Please log in to use chat');
        }
        
        if (!currentSpecData || !currentSpecData.id) {
            throw new Error('No specification loaded');
        }
        
        const token = await user.getIdToken();
        const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/init`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                specId: currentSpecData.id
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to initialize chat');
        }
        
        const data = await response.json();
        chatThreadId = data.threadId;
        chatAssistantId = data.assistantId;
        chatInitialized = true;
        
        // Load history from localStorage
        loadChatHistory();
        
    } catch (error) {

        showNotification('Failed to initialize chat: ' + error.message, 'error');
    }
}

/**
 * Send chat message
 */
async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!chatInitialized) {
        await initializeChat();
    }
    
    // Add user message to UI
    addChatMessage('user', message);
    input.value = '';
    
    // Save to history
    chatHistory.push({ role: 'user', content: message, timestamp: Date.now() });
    saveChatHistory();
    
    // Show loading
    showChatLoading('AI is thinking...');
    
    try {
        const user = firebase.auth().currentUser;
        const token = await user.getIdToken();
        
        const response = await fetch(`${window.API_BASE_URL || 'http://localhost:10000'}/api/chat/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                specId: currentSpecData.id,
                threadId: chatThreadId,
                assistantId: chatAssistantId,
                message: message
            })
        });
        
        if (!response.ok) {
            let errorMessage = 'Failed to send message';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorData.details || errorMessage;
                if (errorData.details) {
                    errorMessage += ': ' + errorData.details;
                }
            } catch (e) {
                errorMessage = `Server error (${response.status})`;
            }
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // Add assistant response to UI
        addChatMessage('assistant', data.response);
        
        // Save to history
        chatHistory.push({ role: 'assistant', content: data.response, timestamp: Date.now() });
        saveChatHistory();
        
        hideChatLoading();
        
    } catch (error) {

        showNotification('Failed to send message: ' + error.message, 'error');
        hideChatLoading();
    }
}

/**
 * Detect if text is RTL (Hebrew, Arabic, etc.)
 */
function isRTL(text) {
    if (!text || text.length === 0) return false;
    
    // Check for Hebrew characters (Unicode range: \u0590-\u05FF)
    const hebrewPattern = /[\u0590-\u05FF]/;
    // Check for Arabic characters (Unicode range: \u0600-\u06FF)
    const arabicPattern = /[\u0600-\u06FF]/;
    
    // Check if text contains RTL characters
    const hasRTLChars = hebrewPattern.test(text) || arabicPattern.test(text);
    
    // If more than 30% of characters are RTL, consider it RTL
    if (hasRTLChars) {
        const rtlChars = text.match(/[\u0590-\u05FF\u0600-\u06FF]/g);
        if (rtlChars && rtlChars.length / text.length > 0.3) {
            return true;
        }
    }
    
    // Check for RTL text content (content contains mainly Hebrew/Arabic)
    const nonWhitespaceChars = text.replace(/\s/g, '');
    if (nonWhitespaceChars.length > 0) {
        const rtlChars = nonWhitespaceChars.match(/[\u0590-\u05FF\u0600-\u06FF]/g);
        if (rtlChars && rtlChars.length / nonWhitespaceChars.length > 0.5) {
            return true;
        }
    }
    
    return false;
}

/**
 * Add message to chat UI
 */
function addChatMessage(role, content) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    // Remove welcome message if exists
    const welcome = messagesContainer.querySelector('.chat-welcome');
    if (welcome) {
        welcome.remove();
    }
    
    // Detect text direction (only for content alignment, not message position)
    const isRTLText = isRTL(content);
    const textDir = isRTLText ? 'rtl' : 'ltr';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    
    // Message position: always user on right, assistant on left
    messageDiv.style.alignItems = role === 'user' ? 'flex-end' : 'flex-start';
    messageDiv.style.cssText += 'margin-bottom: 16px; display: flex; flex-direction: column;';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-message-bubble';
    bubble.setAttribute('dir', textDir);
    bubble.style.cssText = 'max-width: 70%; padding: 12px 16px; border-radius: 8px; word-wrap: break-word; word-break: break-word;';
    
    if (role === 'user') {
        bubble.style.background = 'white';
        bubble.style.color = '#333';
        bubble.style.border = '1px solid #ff6b35';
    } else {
        bubble.style.background = 'white';
        bubble.style.color = '#333';
        bubble.style.border = '1px solid #ddd';
    }
    
    // Handle RTL-specific styling
    if (isRTLText) {
        bubble.style.direction = 'rtl';
        bubble.style.textAlign = 'right';
        bubble.style.unicodeBidi = 'embed';
    }
    
    // Parse markdown if available
    if (typeof marked !== 'undefined') {
        const parsedContent = marked.parse(content);
        
        // Wrap content in RTL-aware div
        if (isRTLText) {
            bubble.innerHTML = `<div dir="rtl" style="direction: rtl; text-align: right; unicode-bidi: embed;">${parsedContent}</div>`;
        } else {
            bubble.innerHTML = parsedContent;
        }
    } else {
        bubble.textContent = content;
    }
    
    const time = document.createElement('div');
    time.className = 'chat-message-time';
    time.style.cssText = 'font-size: 11px; color: #999; margin-top: 4px;';
    time.textContent = new Date().toLocaleTimeString();
    
    messageDiv.appendChild(bubble);
    messageDiv.appendChild(time);
    messagesContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

/**
 * Show loading indicator
 */
function showChatLoading(text = 'Loading...') {
    // Check if loading already exists, if so just update it
    const existingLoading = document.getElementById('chat-loading');
    if (existingLoading) {
        const textSpan = existingLoading.querySelector('span');
        if (textSpan) {
            textSpan.textContent = text;
        }
        return;
    }
    
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message assistant';
    loadingDiv.id = 'chat-loading';
    loadingDiv.style.cssText = 'margin-bottom: 16px; display: flex; flex-direction: column; align-items: flex-start;';
    
    const loading = document.createElement('div');
    loading.className = 'chat-loading';
    loading.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border-radius: 4px; border: 1px solid #ddd; max-width: 70%;';
    loading.innerHTML = `
        <span>${text}</span>
        <div class="chat-loading-dots" style="display: flex; gap: 4px;">
            <div class="chat-loading-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff6b35; animation: bounce 1.4s infinite ease-in-out;"></div>
            <div class="chat-loading-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff6b35; animation: bounce 1.4s infinite ease-in-out; animation-delay: -0.32s;"></div>
            <div class="chat-loading-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff6b35; animation: bounce 1.4s infinite ease-in-out; animation-delay: -0.16s;"></div>
        </div>
    `;
    
    loadingDiv.appendChild(loading);
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

/**
 * Hide loading indicator
 */
function hideChatLoading() {
    const loading = document.getElementById('chat-loading');
    if (loading) {
        loading.remove();
    }
}

/**
 * Save chat history to localStorage
 */
function saveChatHistory() {
    if (currentSpecData && currentSpecData.id) {
        localStorage.setItem(`chat_${currentSpecData.id}`, JSON.stringify(chatHistory));
    }
}

/**
 * Load chat history from localStorage
 */
function loadChatHistory() {
    if (currentSpecData && currentSpecData.id) {
        const saved = localStorage.getItem(`chat_${currentSpecData.id}`);
        if (saved) {
            chatHistory = JSON.parse(saved);
            chatHistory.forEach(msg => {
                addChatMessage(msg.role, msg.content);
            });
        }
    }
}

// Add CSS for RTL support in chat messages
document.addEventListener('DOMContentLoaded', function() {
    // Add RTL-specific styles
    const style = document.createElement('style');
    style.textContent = `
        /* RTL support for chat messages */
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
            unicode-bidi: embed;
        }
        
        /* Ensure proper punctuation in RTL */
        [dir="rtl"] p, [dir="rtl"] div, [dir="rtl"] span {
            direction: rtl;
            text-align: right;
        }
        
        /* Mixed content support */
        .chat-message-bubble[dir="rtl"] {
            direction: rtl;
            text-align: right;
            unicode-bidi: embed;
        }
        
        .chat-message-bubble[dir="ltr"] {
            direction: ltr;
            text-align: left;
        }
        
        /* Hebrew punctuation and quotation marks */
        [dir="rtl"] {
            font-variant-ligatures: none;
        }
        
        /* Proper handling of Hebrew quotation marks   - technical note for RTL support */
        [dir="rtl"]::before {
            direction: rtl;
        }
        
        /* Ensure Hebrew text is properly aligned */
        .hebrew-text, [lang="he"] {
            direction: rtl;
            text-align: right;
            unicode-bidi: embed;
        }
    `;
    document.head.appendChild(style);
});

/**
 * Clear chat history - manual reset
 */
function clearChatHistory() {
    if (currentSpecData && currentSpecData.id) {
        localStorage.removeItem(`chat_${currentSpecData.id}`);
    }
    chatHistory = [];
}

/**
 * Reset chat - clear UI and history
 */
function resetChat() {
    // Clear chat history
    clearChatHistory();
    
    // Clear chat UI
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        messagesContainer.innerHTML = `
            <div class="chat-welcome" style="text-align: center; padding: 30px 20px; color: #666;">
                <i class="fa fa-comments" style="font-size: 48px; color: #ff6b35; margin-bottom: 15px; display: block;"></i>
                <h3 style="margin: 0 0 10px 0; color: #333;">Welcome to AI Chat</h3>
                <p style="margin: 0; color: #666;">Ask me anything about your specification. I have access to all the details and can help clarify, explain, or suggest improvements.</p>
            </div>
        `;
    }
    
    // Reset input field
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.value = '';
        chatInput.style.direction = 'ltr';
        chatInput.style.textAlign = 'left';
    }
    
    // Reset chat variables (will create new thread on next message)
    chatThreadId = null;
    chatInitialized = false;
    
    showNotification('Chat reset successfully', 'success');
}

/**
 * Auto-reset chat when spec is updated
 */
function autoResetChatOnSpecUpdate() {
    // Clear chat history when spec is updated
    clearChatHistory();
    
    // Reset chat initialization to force re-upload to OpenAI
    chatThreadId = null;
    chatInitialized = false;
    chatAssistantId = null;
    

}

// Event listeners for chat
document.addEventListener('DOMContentLoaded', function() {
    const sendBtn = document.getElementById('send-chat-btn');
    const chatInput = document.getElementById('chat-input');
    
    if (sendBtn) {
        sendBtn.addEventListener('click', sendChatMessage);
    }
    
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // Auto-detect text direction and update input field
        chatInput.addEventListener('input', (e) => {
            const value = e.target.value;
            if (isRTL(value)) {
                e.target.style.direction = 'rtl';
                e.target.style.textAlign = 'right';
            } else {
                e.target.style.direction = 'ltr';
                e.target.style.textAlign = 'left';
            }
        });
    }
    
    // Initialize chat when chat tab is clicked
    const chatTab = document.getElementById('chatTab');
    if (chatTab) {
        chatTab.addEventListener('click', function() {
            if (!chatInitialized && currentSpecData) {
                initializeChat();
            }
        });
    }
});

// Update showTab to handle chat initialization
const originalShowTab = showTab;
showTab = function(tabName) {
    originalShowTab(tabName);
    
    if (tabName === 'chat' && !chatInitialized && currentSpecData) {
        initializeChat();
    }
};
</script>
</html>
