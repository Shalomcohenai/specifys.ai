---
layout: default
title: "Market Research - Specifys.ai"
description: "View your saved market research with specifys.ai"
permalink: /pages/research.html
extra_css:
  - /assets/css/pages/research.css
---

<div class="research-container">
  <div class="research-header" id="researchHeader">
    <div class="title-container">
      <h1 id="researchTitle">Loading Market Research...</h1>
      <button class="edit-title-btn" id="editTitleBtn" title="Edit title">
        <i class="fas fa-edit"></i>
      </button>
    </div>
    <div class="research-meta" id="researchMeta">
      <span><i class="fas fa-clock"></i> <span id="researchDate">Loading...</span></span>
      <span><i class="fas fa-user"></i> <span id="researchUser">Loading...</span></span>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer">
    <div class="loading-message">
      <i class="fas fa-spinner fa-spin"></i> Loading market research...
    </div>
  </div>
  <div id="errorMessage" class="error-message" role="alert" style="display: none;"></div>
</div>

<div class="platform-container" id="platformContainer" style="display: none;">
  <h3>Explore Your Market Research:</h3>
  <p class="platform-instructions">The market research has been loaded. Use it to guide your next steps or explore related tools.</p>
  <div class="platform-boxes">
    <button class="platform-box" onclick="copyAllResearchContent()" data-tooltip="Copy the full market research to your clipboard.">
      <i class="fas fa-copy"></i> Copy Full Research
    </button>
    <button class="platform-box" onclick="downloadPdf()" data-tooltip="Download the market research as a PDF file.">
      <i class="fas fa-download"></i> Download as PDF
    </button>
    <a href="../tools/map/vibe-coding-tools-map.html" class="platform-box vibe-coding" data-tooltip="Explore a curated map of coding and NoCode tools to enhance your development process.">
      <i class="fas fa-map"></i> Vibe Coding Tools Map
    </a>
  </div>
  <p class="platform-details">Click a button to copy or download your market research or explore tools to start building your app.</p>
</div>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    getAuth
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  import { 
    collection, 
    doc,
    getDoc,
    getFirestore,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB9hr0IWM4EREzkKDxBxYoYinV6LJXWXV4",
    authDomain: "specify-ai.firebaseapp.com",
    projectId: "specify-ai",
    storageBucket: "specify-ai.firebasestorage.app",
    messagingSenderId: "734278787482",
    appId: "1:734278787482:web:0e312fb6f197e849695a23",
    measurementId: "G-4YR9LK63MR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // Load research function
  async function loadResearch(researchId) {
    try {
      console.log('Loading research with ID:', researchId);
      console.log('Current user:', auth.currentUser?.uid);
      
      // Try to load from marketResearch collection first
      console.log('Trying to load from marketResearch collection...');
      let specDoc = await getDoc(doc(db, 'marketResearch', researchId));
      let specData;
      
      if (specDoc.exists()) {
        specData = specDoc.data();
        console.log('Found in marketResearch collection:', specData);
        console.log('Document userId:', specData.userId);
        console.log('Current user:', auth.currentUser.uid);
        } else {
        console.log('Not found in marketResearch, trying specs collection...');
        // If not found in marketResearch, try specs collection with mode: "market"
        try {
          specDoc = await getDoc(doc(db, 'specs', researchId));
          
          if (!specDoc.exists()) {
            throw new Error('Market research not found in both collections');
          }
          
          specData = specDoc.data();
          console.log('Found in specs collection:', specData);
          console.log('Document userId:', specData.userId);
          console.log('Current user:', auth.currentUser.uid);
        } catch (error) {
          console.error('Error loading from specs collection:', error);
          throw error;
        }
      }
      
      // Check if the document belongs to the current user
      if (!specData.userId) {
        console.warn('Document has no userId field, allowing access');
      } else if (specData.userId !== auth.currentUser.uid) {
        throw new Error('You do not have permission to view this document');
      }
      
      // Update header
      document.getElementById('researchTitle').textContent = specData.title || 'Market Research';
      document.getElementById('researchDate').textContent = specData.createdAt ? new Date(specData.createdAt.toDate()).toLocaleDateString() : 'Unknown date';
      document.getElementById('researchUser').textContent = specData.userName ? `by: ${specData.userName}` : 'by: Unknown User';
      
      // Display content
      displayResearchContent(specData.content);
      
      // Show platform container
      document.getElementById('platformContainer').style.display = 'block';
      
    } catch (error) {
      console.error('Error loading research:', error);
      
      let errorMessage = 'Error loading market research: ';
      
      if (error.message.includes('Missing or insufficient permissions')) {
        errorMessage = 'You do not have permission to view this market research. It may belong to another user or may not exist.';
      } else if (error.message.includes('not found')) {
        errorMessage = 'Market research not found. It may have been deleted or the link is incorrect.';
      } else {
        errorMessage += error.message;
      }
      
      showError(errorMessage);
    }
  }

  function displayResearchContent(content) {
    const chatContainer = document.getElementById('chatContainer');
    
    // Clear loading message
    chatContainer.innerHTML = '';
    
    // Create result message
    const resultDiv = document.createElement('div');
    resultDiv.className = 'chat-message result';
    
    // Convert markdown to HTML
    const htmlContent = marked.parse(content);
    resultDiv.innerHTML = htmlContent;
    
    // Apply syntax highlighting to non-mermaid code blocks
    resultDiv.querySelectorAll('pre code:not(.mermaid)').forEach((block) => {
      hljs.highlightElement(block);
    });
    
    chatContainer.appendChild(resultDiv);
    
    // Initialize Mermaid for diagrams
    if (window.mermaid) {
      mermaid.initialize({ 
        startOnLoad: false,
        theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
      });
      mermaid.init(undefined, resultDiv.querySelectorAll('.mermaid'));
    }
    
    // Also look for standalone Mermaid diagrams that aren't wrapped in code blocks
    const standaloneMermaid = resultDiv.querySelectorAll('pre code');
    standaloneMermaid.forEach((block) => {
      const text = block.textContent.trim();
      if (text.startsWith('flowchart') || text.startsWith('graph') || text.startsWith('sequenceDiagram') || 
          text.startsWith('classDiagram') || text.startsWith('stateDiagram') || text.startsWith('erDiagram') ||
          text.startsWith('journey') || text.startsWith('gantt') || text.startsWith('pie') || text.startsWith('gitgraph')) {
        // Convert this to a mermaid diagram
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = text;
        block.parentNode.replaceWith(mermaidDiv);
      }
    });
    
    // Re-initialize Mermaid for any new diagrams
    if (window.mermaid) {
      mermaid.init(undefined, resultDiv.querySelectorAll('.mermaid'));
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = `
      <div class="error-state">
        <div class="error-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Unable to Load Market Research</h3>
        <p>${message}</p>
        <div class="error-actions">
          <a href="profile.html" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Profile
          </a>
          <button class="btn btn-secondary" onclick="window.location.reload()">
            <i class="fas fa-refresh"></i> Try Again
          </button>
        </div>
      </div>
    `;
  }

  // UI functions
  function updateAuthUI(user) {
      const authButtons = document.getElementById('auth-buttons');
    
    if (user) {
      // User is logged in
      const userEmail = user.email;
      const firstLetter = userEmail ? userEmail.charAt(0).toUpperCase() : 'U';
      
      authButtons.innerHTML = `
        <div class="user-info" onclick="window.location.href='profile.html'">
          <div class="user-avatar">${firstLetter}</div>
          <span>${user.displayName || user.email.split('@')[0]}</span>
        </div>
      `;
      
    } else {
      // User is not logged in
        authButtons.innerHTML = `
          <a href="auth.html" class="btn btn-primary">Sign In</a>
        `;
      }
  }

  // Global functions
  window.showLoginModal = function() {
    window.location.href = 'auth.html';
  };

  window.showRegisterModal = function() {
    window.location.href = 'auth.html';
  };

  window.logout = function() {
    signOut(auth)
      .then(() => {
        alert('Logged out successfully');
        window.location.href = '../index.html';
      })
      .catch(error => {
        alert('Error logging out: ' + error.message);
      });
  };

  window.copyAllResearchContent = function() {
    const researchContent = document.querySelector('.chat-message.result');
    if (researchContent) {
      const textContent = researchContent.textContent || researchContent.innerText;
      navigator.clipboard.writeText(textContent).then(() => {
        alert('Market research copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy to clipboard');
      });
    }
  };

  window.downloadPdf = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const researchContent = document.querySelector('.chat-message.result');
    if (researchContent) {
      const textContent = researchContent.textContent || researchContent.innerText;
      const title = document.getElementById('researchTitle').textContent;
      
      doc.setFontSize(16);
      doc.text(title, 20, 20);
      doc.setFontSize(12);
      
      const splitText = doc.splitTextToSize(textContent, 180);
      doc.text(splitText, 20, 40);
      
      doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
    }
  };

  // Initialize page
  document.addEventListener("DOMContentLoaded", () => {
    // Edit title functionality
    const editTitleBtn = document.getElementById("editTitleBtn");
    if (editTitleBtn) {
      editTitleBtn.addEventListener("click", async () => {
        const currentTitle = document.getElementById("researchTitle").textContent;
        const newTitle = prompt("Edit title:", currentTitle);
        
        if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
          try {
            // Get the research ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const researchId = urlParams.get('id');
            
            if (!researchId) {
              alert("Error: Research ID not found");
              return;
            }

            // Update in Firebase
            const researchRef = doc(db, 'marketResearch', researchId);
            await setDoc(researchRef, {
              title: newTitle.trim(),
              updatedAt: new Date().toISOString()
            }, { merge: true });

            // Update the display
            document.getElementById("researchTitle").textContent = newTitle.trim();
            
            console.log("✅ Research title updated successfully");
            
          } catch (error) {
            console.error("Error updating research title:", error);
            alert("Failed to update title. Please try again.");
          }
        }
      });
    }
  });

  // Listen to auth state changes
  onAuthStateChanged(auth, (user) => {
    updateAuthUI(user);
    
    // Load research only after user is authenticated
    if (user) {
      console.log('User authenticated:', user.uid);
      const urlParams = new URLSearchParams(window.location.search);
      const researchId = urlParams.get('id');
      
      if (researchId) {
        loadResearch(researchId);
      } else {
        showError('No research ID provided');
      }
    } else {
      console.log('User not authenticated');
      showError('Please log in to view this market research');
      }
    });
  </script>