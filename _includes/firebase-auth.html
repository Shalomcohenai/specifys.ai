<script>
  // Auth UI functions
  function updateAuthUI(user) {
    const authButtons = document.getElementById('auth-buttons');
    if (!authButtons) return;
    
    if (user) {
      // User is logged in
      const displayName = user.displayName || user.email.split('@')[0];
      const firstLetter = displayName.charAt(0).toUpperCase();
      
      authButtons.innerHTML = `
        <a href="{{ '/pages/profile.html' | relative_url }}" class="user-info" style="text-decoration: none;">
          <div class="user-avatar">${firstLetter}</div>
          <span>${displayName}</span>
        </a>
      `;
    } else {
      // User is not logged in
      authButtons.innerHTML = `
        <button class="auth-btn" onclick="showLoginModal()">Log in/Sign up</button>
      `;
    }
  }

  // Global auth functions
  window.showLoginModal = function() {
    if (typeof trackButtonClick !== 'undefined') {
      trackButtonClick('Show Login', 'Authentication', 'header');
    }
    window.location.href = '{{ "/pages/auth.html" | relative_url }}';
  };

  window.showRegisterModal = function() {
    if (typeof trackButtonClick !== 'undefined') {
      trackButtonClick('Show Register', 'Authentication', 'header');
    }
    window.location.href = '{{ "/pages/auth.html" | relative_url }}';
  };

  window.logout = function() {
    if (typeof trackAuthEvent !== 'undefined') {
      trackAuthEvent('logout', 'email');
    }
    auth.signOut()
      .then(() => {
        console.log('Logged out successfully');
      })
      .catch(error => {
        console.error('Error logging out:', error);
      });
  };

  // Listen to auth state changes (only after Firebase is initialized)
  function setupAuthListener() {
    if (typeof auth === 'undefined' && typeof window.auth !== 'undefined') {
      window.auth = window.auth;
    }
    
    if (typeof auth === 'undefined') {
      setTimeout(setupAuthListener, 100);
      return;
    }
    
    auth.onAuthStateChanged(async (user) => {
      updateAuthUI(user);

      // Ensure user document exists (deferred and only when visible)
      if (user && document.visibilityState === 'visible') {
        if ('requestIdleCallback' in window) {
          requestIdleCallback(async () => {
            await ensureUserDocument(user);
          }, { timeout: 3000 });
        } else {
          setTimeout(async () => {
            await ensureUserDocument(user);
          }, 3000);
        }
      }
    });
  }
  
  async function ensureUserDocument(user) {
    try {
      const token = await user.getIdToken();
      const apiBaseUrl = window.getApiBaseUrl ? window.getApiBaseUrl() : (window.API_BASE_URL || 'https://specifys-ai.onrender.com');
      const response = await fetch(`${apiBaseUrl}/api/users/ensure`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        console.log('✅ User document ensured in Firestore');
      } else {
        console.warn('⚠️ Failed to ensure user document:', await response.text());
      }
    } catch (error) {
      console.warn('⚠️ Error ensuring user document:', error);
    }
  }

  // Wait for Firebase to be ready
  if (typeof firebase !== 'undefined' && firebase.auth) {
    // Firebase already loaded, wait a bit for initialization
    setTimeout(setupAuthListener, 100);
  } else {
    window.addEventListener('firebase-ready', setupAuthListener);
  }

  // Initialize auth buttons with default state
  document.addEventListener('DOMContentLoaded', function() {
    const authButtons = document.getElementById('auth-buttons');
    if (authButtons && !authButtons.innerHTML.trim()) {
      authButtons.innerHTML = `
        <button class="auth-btn login-btn">Log in/Sign up</button>
      `;
      
      const loginBtn = authButtons.querySelector('.login-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          window.location.href = '{{ "/pages/auth.html" | relative_url }}';
        });
      }
    }
  });
</script>

